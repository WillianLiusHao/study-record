<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>一、前端监控 SDK 面试考点、难点与亮点梳理 | 前端随笔 WillianLiusHao</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="勤学如春起之苗，不见其增，日有所长">
    
    <link rel="preload" href="/study-record/assets/css/0.styles.ee9d39b9.css" as="style"><link rel="preload" href="/study-record/assets/js/app.17aac99d.js" as="script"><link rel="preload" href="/study-record/assets/js/2.016b014c.js" as="script"><link rel="preload" href="/study-record/assets/js/1.4d9187d3.js" as="script"><link rel="preload" href="/study-record/assets/js/85.2ea9262b.js" as="script"><link rel="prefetch" href="/study-record/assets/js/10.36503388.js"><link rel="prefetch" href="/study-record/assets/js/11.fa712348.js"><link rel="prefetch" href="/study-record/assets/js/12.276efbb7.js"><link rel="prefetch" href="/study-record/assets/js/13.d963e8a7.js"><link rel="prefetch" href="/study-record/assets/js/14.d7577f19.js"><link rel="prefetch" href="/study-record/assets/js/15.cc1f798a.js"><link rel="prefetch" href="/study-record/assets/js/16.0291a868.js"><link rel="prefetch" href="/study-record/assets/js/17.0a30da7e.js"><link rel="prefetch" href="/study-record/assets/js/18.0cfbb48c.js"><link rel="prefetch" href="/study-record/assets/js/19.0e21e7df.js"><link rel="prefetch" href="/study-record/assets/js/20.03daea74.js"><link rel="prefetch" href="/study-record/assets/js/21.3b8bed13.js"><link rel="prefetch" href="/study-record/assets/js/22.044c0ee0.js"><link rel="prefetch" href="/study-record/assets/js/23.2e58d861.js"><link rel="prefetch" href="/study-record/assets/js/24.5d91c0ed.js"><link rel="prefetch" href="/study-record/assets/js/25.ecbc19e1.js"><link rel="prefetch" href="/study-record/assets/js/26.ea32b772.js"><link rel="prefetch" href="/study-record/assets/js/27.7994195c.js"><link rel="prefetch" href="/study-record/assets/js/28.1d2d8781.js"><link rel="prefetch" href="/study-record/assets/js/29.29644b5e.js"><link rel="prefetch" href="/study-record/assets/js/3.babd7043.js"><link rel="prefetch" href="/study-record/assets/js/30.c1b69b54.js"><link rel="prefetch" href="/study-record/assets/js/31.b8531d02.js"><link rel="prefetch" href="/study-record/assets/js/32.1a3d2119.js"><link rel="prefetch" href="/study-record/assets/js/33.4073fb14.js"><link rel="prefetch" href="/study-record/assets/js/34.5873267c.js"><link rel="prefetch" href="/study-record/assets/js/35.22f30e0a.js"><link rel="prefetch" href="/study-record/assets/js/36.9acadcf0.js"><link rel="prefetch" href="/study-record/assets/js/37.514fb866.js"><link rel="prefetch" href="/study-record/assets/js/38.cfd8eaf8.js"><link rel="prefetch" href="/study-record/assets/js/39.b18930b7.js"><link rel="prefetch" href="/study-record/assets/js/4.fa802c58.js"><link rel="prefetch" href="/study-record/assets/js/40.ce709979.js"><link rel="prefetch" href="/study-record/assets/js/41.2042214a.js"><link rel="prefetch" href="/study-record/assets/js/42.87b852a8.js"><link rel="prefetch" href="/study-record/assets/js/43.b4287906.js"><link rel="prefetch" href="/study-record/assets/js/44.6bf10f9a.js"><link rel="prefetch" href="/study-record/assets/js/45.25eeefa0.js"><link rel="prefetch" href="/study-record/assets/js/46.0f8cb01f.js"><link rel="prefetch" href="/study-record/assets/js/47.288a54bb.js"><link rel="prefetch" href="/study-record/assets/js/48.b613c839.js"><link rel="prefetch" href="/study-record/assets/js/49.d18be6a8.js"><link rel="prefetch" href="/study-record/assets/js/5.87700c1c.js"><link rel="prefetch" href="/study-record/assets/js/50.400520f0.js"><link rel="prefetch" href="/study-record/assets/js/51.7eab7fad.js"><link rel="prefetch" href="/study-record/assets/js/52.caaed993.js"><link rel="prefetch" href="/study-record/assets/js/53.55fabd90.js"><link rel="prefetch" href="/study-record/assets/js/54.1a826e47.js"><link rel="prefetch" href="/study-record/assets/js/55.e0c40590.js"><link rel="prefetch" href="/study-record/assets/js/56.42f5fc5f.js"><link rel="prefetch" href="/study-record/assets/js/57.8f30f2af.js"><link rel="prefetch" href="/study-record/assets/js/58.63b92872.js"><link rel="prefetch" href="/study-record/assets/js/59.bd09ccb3.js"><link rel="prefetch" href="/study-record/assets/js/6.9086b17c.js"><link rel="prefetch" href="/study-record/assets/js/60.e7406693.js"><link rel="prefetch" href="/study-record/assets/js/61.f2e5a88e.js"><link rel="prefetch" href="/study-record/assets/js/62.0b65291e.js"><link rel="prefetch" href="/study-record/assets/js/63.8de3fdca.js"><link rel="prefetch" href="/study-record/assets/js/64.4e11deef.js"><link rel="prefetch" href="/study-record/assets/js/65.54d039db.js"><link rel="prefetch" href="/study-record/assets/js/66.84db7a63.js"><link rel="prefetch" href="/study-record/assets/js/67.1c39ed43.js"><link rel="prefetch" href="/study-record/assets/js/68.c06e0761.js"><link rel="prefetch" href="/study-record/assets/js/69.ab2a8f77.js"><link rel="prefetch" href="/study-record/assets/js/7.8ac123f2.js"><link rel="prefetch" href="/study-record/assets/js/70.4ac2a1eb.js"><link rel="prefetch" href="/study-record/assets/js/71.a10a64a1.js"><link rel="prefetch" href="/study-record/assets/js/72.f5ee9344.js"><link rel="prefetch" href="/study-record/assets/js/73.ce032dd2.js"><link rel="prefetch" href="/study-record/assets/js/74.0867294f.js"><link rel="prefetch" href="/study-record/assets/js/75.a2ebcace.js"><link rel="prefetch" href="/study-record/assets/js/76.c3eb5991.js"><link rel="prefetch" href="/study-record/assets/js/77.06a7f50c.js"><link rel="prefetch" href="/study-record/assets/js/78.5fb20fe2.js"><link rel="prefetch" href="/study-record/assets/js/79.f6266092.js"><link rel="prefetch" href="/study-record/assets/js/80.d3237485.js"><link rel="prefetch" href="/study-record/assets/js/81.59c4725f.js"><link rel="prefetch" href="/study-record/assets/js/82.d198b1a8.js"><link rel="prefetch" href="/study-record/assets/js/83.88fb1a26.js"><link rel="prefetch" href="/study-record/assets/js/84.43f20fa1.js"><link rel="prefetch" href="/study-record/assets/js/86.d3f5931d.js"><link rel="prefetch" href="/study-record/assets/js/87.b1833438.js"><link rel="prefetch" href="/study-record/assets/js/88.4359c8a8.js"><link rel="prefetch" href="/study-record/assets/js/89.2c40610e.js"><link rel="prefetch" href="/study-record/assets/js/90.5546c4ab.js"><link rel="prefetch" href="/study-record/assets/js/91.22180d3b.js"><link rel="prefetch" href="/study-record/assets/js/92.15962496.js"><link rel="prefetch" href="/study-record/assets/js/vendors~docsearch.32379f2b.js">
    <link rel="stylesheet" href="/study-record/assets/css/0.styles.ee9d39b9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/study-record/" class="home-link router-link-active"><!----> <span class="site-name">前端随笔 WillianLiusHao</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/WillianLiusHao" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/WillianLiusHao" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>1.基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>2.项目</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>3.算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>4.日常</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>20251101</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/study-record/4.%E6%97%A5%E5%B8%B8/20251101/" aria-current="page" class="sidebar-link">index</a></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><p class="sidebar-heading"><span>plan</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><p class="sidebar-heading"><span>框架</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/study-record/4.日常/20251101/面试相关.html" class="sidebar-link">面试相关</a></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><p class="sidebar-heading open"><span>项目</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/study-record/4.日常/20251101/项目/1. 监控.html" class="sidebar-link">1. 监控</a></li><li><a href="/study-record/4.日常/20251101/项目/1.1 前端监控考点.html" class="active sidebar-link">1.1 前端监控考点</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study-record/4.日常/20251101/项目/1.1 前端监控考点.html#一、核心考点-基础与原理-必须掌握" class="sidebar-link">一、核心考点：基础与原理（必须掌握）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study-record/4.日常/20251101/项目/1.1 前端监控考点.html#_1-监控-sdk-的核心功能模块" class="sidebar-link">1. 监控 SDK 的核心功能模块</a></li><li class="sidebar-sub-header"><a href="/study-record/4.日常/20251101/项目/1.1 前端监控考点.html#_2-关键技术原理-高频提问" class="sidebar-link">2. 关键技术原理（高频提问）</a></li><li class="sidebar-sub-header"><a href="/study-record/4.日常/20251101/项目/1.1 前端监控考点.html#_3-工程化与兼容性" class="sidebar-link">3. 工程化与兼容性</a></li></ul></li><li class="sidebar-sub-header"><a href="/study-record/4.日常/20251101/项目/1.1 前端监控考点.html#二、项目难点-体现问题解决能力" class="sidebar-link">二、项目难点：体现问题解决能力</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study-record/4.日常/20251101/项目/1.1 前端监控考点.html#_1-数据准确性问题-最常见难点" class="sidebar-link">1. 数据准确性问题（最常见难点）</a></li><li class="sidebar-sub-header"><a href="/study-record/4.日常/20251101/项目/1.1 前端监控考点.html#_2-性能影响问题-sdk-的-自我修养" class="sidebar-link">2. 性能影响问题（SDK 的 “自我修养”）</a></li><li class="sidebar-sub-header"><a href="/study-record/4.日常/20251101/项目/1.1 前端监控考点.html#_3-复杂场景适配" class="sidebar-link">3. 复杂场景适配</a></li></ul></li><li class="sidebar-sub-header"><a href="/study-record/4.日常/20251101/项目/1.1 前端监控考点.html#三、项目亮点-突出差异化优势" class="sidebar-link">三、项目亮点：突出差异化优势</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study-record/4.日常/20251101/项目/1.1 前端监控考点.html#_1-技术层面-超越基础功能的优化" class="sidebar-link">1. 技术层面：超越基础功能的优化</a></li><li class="sidebar-sub-header"><a href="/study-record/4.日常/20251101/项目/1.1 前端监控考点.html#_2-工程化层面-体现产品化思维" class="sidebar-link">2. 工程化层面：体现产品化思维</a></li><li class="sidebar-sub-header"><a href="/study-record/4.日常/20251101/项目/1.1 前端监控考点.html#_3-业务价值层面-体现落地效果" class="sidebar-link">3. 业务价值层面：体现落地效果</a></li></ul></li><li class="sidebar-sub-header"><a href="/study-record/4.日常/20251101/项目/1.1 前端监控考点.html#四、面试准备建议" class="sidebar-link">四、面试准备建议</a></li><li class="sidebar-sub-header"><a href="/study-record/4.日常/20251101/项目/1.1 前端监控考点.html#一、基础原理类-必问-考察核心认知" class="sidebar-link">一、基础原理类（必问，考察核心认知）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study-record/4.日常/20251101/项目/1.1 前端监控考点.html#_1-前端监控-sdk-主要监控哪些内容-请分别说明实现思路。☆☆☆☆☆" class="sidebar-link">1. 前端监控 SDK 主要监控哪些内容？请分别说明实现思路。☆☆☆☆☆</a></li><li class="sidebar-sub-header"><a href="/study-record/4.日常/20251101/项目/1.1 前端监控考点.html#_2-如何解决-跨域脚本错误-script-error-无法获取完整堆栈的问题" class="sidebar-link">2. 如何解决 “跨域脚本错误（Script error）” 无法获取完整堆栈的问题？</a></li><li class="sidebar-sub-header"><a href="/study-record/4.日常/20251101/项目/1.1 前端监控考点.html#_3-单页应用-spa-的监控和传统多页应用有什么区别-你是怎么适配-spa-的" class="sidebar-link">3. ~~单页应用（SPA）的监控和传统多页应用有什么区别？你是怎么适配 SPA 的？~~</a></li><li class="sidebar-sub-header"><a href="/study-record/4.日常/20251101/项目/1.1 前端监控考点.html#_4-如何拦截-xhr-fetch-请求-实现接口耗时和错误的监控-☆☆☆" class="sidebar-link">4. 如何拦截 XHR/fetch 请求，实现接口耗时和错误的监控？☆☆☆</a></li></ul></li><li class="sidebar-sub-header"><a href="/study-record/4.日常/20251101/项目/1.1 前端监控考点.html#二、难点解决类-区分度题-考察实战能力" class="sidebar-link">二、难点解决类（区分度题，考察实战能力）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study-record/4.日常/20251101/项目/1.1 前端监控考点.html#_5-如何避免-sdk-自身的代码影响页面性能-如占用主线程、消耗带宽-☆☆☆" class="sidebar-link">5. 如何避免 SDK 自身的代码影响页面性能？（如占用主线程、消耗带宽）☆☆☆</a></li><li class="sidebar-sub-header"><a href="/study-record/4.日常/20251101/项目/1.1 前端监控考点.html#_6-如何解决-错误重复上报-的问题-请举例说明。☆☆☆" class="sidebar-link">6. 如何解决 “错误重复上报” 的问题？请举例说明。☆☆☆</a></li><li class="sidebar-sub-header"><a href="/study-record/4.日常/20251101/项目/1.1 前端监控考点.html#_7-如何监控前端的-白屏-问题-白屏的常见原因有哪些" class="sidebar-link">7. 如何监控前端的 “白屏” 问题？白屏的常见原因有哪些？</a></li></ul></li><li class="sidebar-sub-header"><a href="/study-record/4.日常/20251101/项目/1.1 前端监控考点.html#三、工程化与架构类-考察深度-区分高级开发" class="sidebar-link">三、工程化与架构类（考察深度，区分高级开发）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study-record/4.日常/20251101/项目/1.1 前端监控考点.html#_8-你设计的-sdk-是如何实现-可配置-和-可扩展-的-请举例说明。" class="sidebar-link">8. 你设计的 SDK 是如何实现 “可配置” 和 “可扩展” 的？请举例说明。</a></li><li class="sidebar-sub-header"><a href="/study-record/4.日常/20251101/项目/1.1 前端监控考点.html#_9-sdk-的-数据上报-模块需要考虑哪些问题-如何设计一个可靠的上报方案-☆☆☆☆" class="sidebar-link">9. SDK 的 “数据上报” 模块需要考虑哪些问题？如何设计一个可靠的上报方案？☆☆☆☆</a></li><li class="sidebar-sub-header"><a href="/study-record/4.日常/20251101/项目/1.1 前端监控考点.html#_10-如何设计-sdk-的-采样策略-为什么需要采样" class="sidebar-link">10. 如何设计 SDK 的 “采样策略”？为什么需要采样？</a></li></ul></li><li class="sidebar-sub-header"><a href="/study-record/4.日常/20251101/项目/1.1 前端监控考点.html#四、业务价值与优化类-考察思维高度-加分项" class="sidebar-link">四、业务价值与优化类（考察思维高度，加分项）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study-record/4.日常/20251101/项目/1.1 前端监控考点.html#_11-你做的监控-sdk-给业务带来了哪些实际价值-请举-1-2-个具体案例。" class="sidebar-link">11. 你做的监控 SDK 给业务带来了哪些实际价值？请举 1-2 个具体案例。</a></li><li class="sidebar-sub-header"><a href="/study-record/4.日常/20251101/项目/1.1 前端监控考点.html#_12-未来你会如何优化这个-sdk-有哪些规划" class="sidebar-link">12. 未来你会如何优化这个 SDK？有哪些规划？</a></li></ul></li><li class="sidebar-sub-header"><a href="/study-record/4.日常/20251101/项目/1.1 前端监控考点.html#五、面试回答技巧总结" class="sidebar-link">五、面试回答技巧总结</a></li></ul></li><li><a href="/study-record/4.日常/20251101/项目/2. 微前端考察点.html" class="sidebar-link">2. 微前端考察点</a></li></ul></section></li></ul></section></li><li><a href="/study-record/4.日常/forCVTE.html" class="sidebar-link">forCVTE</a></li><li><a href="/study-record/4.日常/inter-records.html" class="sidebar-link">inter-records</a></li><li><a href="/study-record/4.日常/notes.html" class="sidebar-link">notes</a></li><li><a href="/study-record/4.日常/plan.html" class="sidebar-link">plan</a></li><li><a href="/study-record/4.日常/ts-question.html" class="sidebar-link">ts-question</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>5.脑图</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/study-record/" aria-current="page" class="sidebar-link">index</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="一、前端监控-sdk-面试考点、难点与亮点梳理"><a href="#一、前端监控-sdk-面试考点、难点与亮点梳理" class="header-anchor">#</a> 一、前端监控 SDK 面试考点、难点与亮点梳理</h1> <p>在面试中，前端监控 SDK 相关问题会围绕 <strong>技术实现原理、工程化能力、问题解决思路、性能优化</strong> 四个核心维度展开。以下从考点、难点、亮点三部分系统梳理，帮你精准应对面试。</p> <h2 id="一、核心考点-基础与原理-必须掌握"><a href="#一、核心考点-基础与原理-必须掌握" class="header-anchor">#</a> 一、核心考点：基础与原理（必须掌握）</h2> <p>这部分是面试高频提问区，重点考察你对监控 SDK“是什么、能做什么、怎么实现” 的基础认知，需结合项目细节展开。</p> <h3 id="_1-监控-sdk-的核心功能模块"><a href="#_1-监控-sdk-的核心功能模块" class="header-anchor">#</a> 1. 监控 SDK 的核心功能模块</h3> <p>面试官会先确认你对监控范围的理解，需清晰拆解核心模块，避免遗漏关键场景：</p> <ul><li><strong>错误监控：覆盖前端所有错误类型，需说明 “监控什么、怎么监控、如何上报”。</strong> <ul><li>语法错误 / 运行时错误：通过<code>window.onerror</code>捕获（注意跨域脚本错误需配置<code>crossorigin</code>和<code>source-map</code>）。</li> <li>资源加载错误：通过<code>window.addEventListener('error', (e) =&gt; { if(e.target instanceof HTMLElement) { ... } })</code>捕获（区分 JS 错误和资源错误）。</li> <li>Promise 错误：通过<code>window.addEventListener('unhandledrejection', (e) =&gt; { ... })</code>捕获（避免错误静默失败）。</li> <li>React/Vue 框架错误：React 用<code>componentDidCatch</code>（类组件）或<code>ErrorBoundary</code>（函数组件），Vue 用<code>app.config.errorHandler</code>。</li></ul></li> <li><strong>性能监控：基于 Web Performance API，需明确 “监控哪些指标、指标含义、计算方式”。</strong> <ul><li>核心 Web 指标（Core Web Vitals）：LCP（最大内容绘制，衡量加载速度）、FID（首次输入延迟，衡量交互响应）、CLS（累积布局偏移，衡量视觉稳定性）。</li> <li>传统性能指标：FP（首次绘制）、FCP（首次内容绘制）、TTI（首次可交互时间）、TTFB（首字节时间，需结合服务端分析）。</li> <li>自定义性能：接口请求耗时（拦截<code>XMLHttpRequest</code>/<code>fetch</code>）、页面跳转耗时、组件渲染耗时。</li></ul></li> <li><strong>行为监控：记录用户操作，用于分析用户路径和问题复现，需说明 “监控场景、数据脱敏”。</strong> <ul><li>页面埋点：PV/UV（基于<code>visibilitychange</code>判断页面可见性，避免重复统计）、页面停留时间（记录<code>pagehide</code>与<code>pageshow</code>时间差）。</li> <li>用户操作：点击事件（代理到<code>document</code>，过滤非用户触发的点击）、输入行为、路由跳转（监听<code>hashchange</code>/<code>popstate</code>或框架路由钩子）。</li></ul></li> <li><strong>异常上报：确保数据 “能上报、不丢包、不影响主流程”，需说明上报策略。</strong> <ul><li>上报方式：异步<code>img</code>标签（兼容性最好，无跨域问题）、<code>fetch</code>（支持更多配置，需处理跨域）。</li> <li>数据格式：包含<code>错误类型、错误信息、堆栈、时间戳、设备信息（UA）、页面URL、环境变量（生产/测试）</code>等核心字段。</li></ul></li></ul> <h3 id="_2-关键技术原理-高频提问"><a href="#_2-关键技术原理-高频提问" class="header-anchor">#</a> 2. 关键技术原理（高频提问）</h3> <p>需结合项目中实际使用的方案，解释 “为什么这么做”，而非单纯背概念：</p> <ul><li><p><strong>错误堆栈解析：</strong></p> <ul><li>原生错误堆栈包含文件路径、行号，但压缩后的代码需结合<code>source-map</code>还原真实代码位置（项目中是否实现了<code>source-map</code>解析？是前端解析还是后端解析？）。</li> <li>跨域脚本错误（<code>Script error</code>）的解决：1. 脚本标签添加<code>crossorigin=&quot;anonymous&quot;</code>；2. 服务端响应头添加<code>Access-Control-Allow-Origin</code>。</li></ul></li> <li><p><strong>性能指标计算：</strong></p> <ul><li><p>基于<code>performance.timing</code>（旧标准）或<code>performance.getEntriesByType('navigation')</code>（新标准，Navigation Timing API v2）计算 FP/FCP/TTI。</p></li> <li><p>LCP 监控：通过</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">PerformanceObserver</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">entryList</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'largest-contentful-paint'</span><span class="token punctuation">,</span> <span class="token literal-property property">buffered</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>实时监听最大内容元素。</p></li></ul></li> <li><p><strong>请求拦截：</strong></p> <ul><li>拦截<code>XMLHttpRequest</code>：重写<code>XMLHttpRequest.prototype.open</code>和<code>XMLHttpRequest.prototype.send</code>，记录请求开始 / 结束时间，计算耗时。</li> <li>拦截<code>fetch</code>：重写<code>window.fetch</code>，包装<code>Promise</code>，在<code>then/catch</code>中记录请求结果和耗时。</li></ul></li> <li><p><strong>数据防抖 / 节流：</strong></p> <ul><li>高频事件（如滚动、resize）监控需节流（如 100ms 一次），避免生成大量冗余数据；</li> <li>上报队列需防抖（如 500ms 批量上报一次），减少 HTTP 请求次数，降低性能消耗。</li></ul></li></ul> <h3 id="_3-工程化与兼容性"><a href="#_3-工程化与兼容性" class="header-anchor">#</a> 3. 工程化与兼容性</h3> <p>考察你对 “SDK 产品化” 的思考，而非单纯的技术实现：</p> <ul><li><strong>兼容性处理：</strong> <ul><li>低版本浏览器（如 IE11）不支持<code>PerformanceObserver</code>/<code>fetch</code>，如何降级？（如用<code>performance.timing</code>替代、用<code>XMLHttpRequest</code>模拟<code>fetch</code>）。</li> <li>不同框架（React/Vue/Angular）的错误监控适配方案（项目中是否做了多框架兼容？）。</li></ul></li> <li><strong>SDK 体积与加载：</strong> <ul><li>SDK 体积优化：Tree-shaking（排除未使用的模块）、代码压缩（Terser）、按需加载（如行为监控模块可配置关闭）。</li> <li>加载方式：异步加载（避免阻塞主流程）、动态插入脚本（如<code>document.createElement('script')</code>），是否考虑 “首屏加载时不加载 SDK，避免影响首屏性能”？</li></ul></li> <li><strong>配置化设计：</strong> <ul><li>SDK 是否支持自定义配置？（如<code>{ enableError: true, enablePerformance: false, reportUrl: 'xxx' }</code>），方便业务方按需开启模块。</li> <li>是否支持钩子函数？（如<code>beforeReport: (data) =&gt; { ... }</code>，允许业务方自定义过滤 / 修改上报数据）。</li></ul></li></ul> <h2 id="二、项目难点-体现问题解决能力"><a href="#二、项目难点-体现问题解决能力" class="header-anchor">#</a> 二、项目难点：体现问题解决能力</h2> <p>面试官会重点关注 “你在项目中遇到了什么问题、怎么解决的”，需结合具体场景，说明 “痛点 - 方案 - 效果”，避免泛泛而谈。</p> <h3 id="_1-数据准确性问题-最常见难点"><a href="#_1-数据准确性问题-最常见难点" class="header-anchor">#</a> 1. 数据准确性问题（最常见难点）</h3> <ul><li><p><strong>痛点 1：错误重复上报</strong></p> <p>同一错误（如循环中的错误）可能触发多次 <code>onerror</code> 导致重复上报，污染数据。</p> <p>解决方案：用 “错误唯一标识” 去重（如 <code>错误信息+堆栈+URL</code> 哈希值），记录已上报的错误 ID，30 分钟内同一 ID 不再上报。</p></li> <li><p><strong>痛点 2：性能指标计算偏差</strong></p> <p>如 LCP 在 “图片懒加载” 场景下，真实 LCP 元素加载延迟，导致监控到的 LCP 值偏小。</p> <p>解决方案：延长 LCP 监听时间（如页面加载后 5s 内仍监听），或结合 <code>load</code> 事件后再修正 LCP 值；排除非关键元素（如隐藏的图片）。</p></li> <li><p><strong>痛点 3：跨域脚本错误无法获取堆栈</strong></p> <p>即使配置了 <code>crossorigin</code>，部分 CDN 脚本仍可能因响应头问题导致错误堆栈为空。</p> <p>解决方案：前端通过 “错误边界”（如 React ErrorBoundary）在框架层捕获错误，补充上下文信息（如组件名、props），提升错误可复现性。</p></li></ul> <h3 id="_2-性能影响问题-sdk-的-自我修养"><a href="#_2-性能影响问题-sdk-的-自我修养" class="header-anchor">#</a> 2. 性能影响问题（SDK 的 “自我修养”）</h3> <ul><li><p><strong>痛点 1：SDK 自身消耗主进程资源</strong></p> <p>高频监控（如行为监控、滚动监控）可能导致主线程阻塞，影响页面性能。</p> <p>解决方案：</p> <ol><li>监控逻辑用 <code>requestIdleCallback</code>（空闲时执行）</li> <li>复杂计算（如堆栈解析）移交 Web Worker，避免阻塞主线程</li> <li>可配置 “采样率”（如 10% 用户开启详细监控），降低整体消耗。</li></ol></li> <li><p><strong>痛点 2：上报请求占用网络带宽</strong></p> <p>大量上报数据（如行为日志）可能挤占业务接口带宽，导致业务请求延迟。</p> <p>解决方案：</p> <ol><li>批量上报（如 10 条数据合并一次上报）</li> <li>压缩上报数据（如用 gzip，或自定义二进制格式）</li> <li>非关键数据（如行为日志）在弱网环境下延迟上报（监听 <code>navigator.connection.effectiveType</code> 判断网络类型）。</li></ol></li></ul> <h3 id="_3-复杂场景适配"><a href="#_3-复杂场景适配" class="header-anchor">#</a> 3. 复杂场景适配</h3> <ul><li><p><strong>痛点 1：单页应用（SPA）路由切换监控</strong></p> <p>SPA 路由切换不会触发 <code>pageshow</code> ，导致传统的 PV 统计、性能监控失效。</p> <p>解决方案：</p> <ol><li>监听框架路由钩子（如 React Router 的 <code>useEffect</code>、Vue Router 的 <code>afterEach</code>），在路由切换时重新初始化监控（如重新计算 FCP、重置错误计数器）</li> <li>用 <code>performance.getEntriesByType('navigation')</code> 的 <code>type</code> 字段（<code>reload</code>/<code>navigate</code>/<code>back_forward</code>）区分路由类型。</li></ol></li> <li><p><strong>痛点 2：iframe 嵌套页面监控</strong></p> <p>父页面无法直接捕获 iframe 内的错误和性能数据，导致监控盲区。</p> <p>解决方案：</p> <ol><li>iframe 内注入 SDK，通过<code>postMessage</code>将数据传递给父页面，由父页面统一上报</li> <li>父页面监听<code>iframe</code>的<code>load</code>事件，补充 iframe 的加载性能数据。</li></ol></li></ul> <h2 id="三、项目亮点-突出差异化优势"><a href="#三、项目亮点-突出差异化优势" class="header-anchor">#</a> 三、项目亮点：突出差异化优势</h2> <p>亮点是面试中的 “加分项”，需体现你对监控 SDK 的 “深度思考” 或 “创新实践”，避免停留在 “完成基础功能” 层面。</p> <h3 id="_1-技术层面-超越基础功能的优化"><a href="#_1-技术层面-超越基础功能的优化" class="header-anchor">#</a> 1. 技术层面：超越基础功能的优化</h3> <ul><li><p><strong>错误溯源与智能分析：</strong></p> <p>不只是上报错误堆栈，还能关联 “用户操作路径”（如错误发生前用户点击了哪个按钮、输入了什么内容）和 “环境信息”（如浏览器版本、设备型号、网络类型），帮助开发快速复现问题。例如：项目中实现了 “错误 - 操作日志” 关联，点击错误 ID 可查看前 10 步用户操作，复现率提升 60%。</p></li> <li><p><strong>性能瓶颈定位：</strong></p> <p>不只是上报性能指标，还能分析 “性能差的原因”。例如：结合<code>performance.getEntriesByType('resource')</code>分析资源加载耗时，识别出 “某张图片加载耗时 2s”，或 “某接口响应耗时 1.5s”，直接定位瓶颈点；甚至实现 “性能指标告警”（如 LCP&gt;4s 时触发钉钉告警）。</p></li> <li><p><strong>动态配置与灰度发布：</strong></p> <p>实现 “远程配置中心”（如基于 Redis/MySQL），支持动态开启 / 关闭监控模块、调整采样率、更新上报地址，无需重新发布 SDK。例如：线上发现某模块有 bug，可通过配置中心实时关闭该模块，避免影响所有用户；新功能上线时先灰度 10% 用户，验证无问题后全量。</p></li></ul> <h3 id="_2-工程化层面-体现产品化思维"><a href="#_2-工程化层面-体现产品化思维" class="header-anchor">#</a> 2. 工程化层面：体现产品化思维</h3> <ul><li><p><strong>SDK 可扩展架构</strong>：</p> <p>采用 “插件化设计”，将错误监控、性能监控、行为监控拆分为独立插件，业务方可按需引入（如<code>import { ErrorPlugin, PerformancePlugin } from 'monitor-sdk'</code>），同时支持自定义插件（如业务方自己开发 “小程序监控插件”），提升 SDK 的灵活性。</p></li> <li><p><strong>数据可视化与平台联动：</strong></p> <p>不只做 “数据上报”，还参与 “监控平台” 的部分设计，例如：上报的数据在平台上支持 “错误趋势图”“性能分位数统计”“用户分布热力图”，甚至支持 “错误一键跳转至源码（如 GitHub）”“性能问题关联 Jira 工单”，打通 “监控 - 排查 - 修复” 链路。</p></li> <li><p><strong>隐私合规处理：</strong></p> <p>符合 GDPR / 国内《个人信息保护法》，实现 “数据脱敏” 和 “用户授权”。例如：</p> <ol><li>上报的用户输入内容（如表单）自动脱敏（替换手机号 / 邮箱为<code>*</code>）</li> <li>提供<code>init({ enablePrivacy: true })</code>配置，用户拒绝授权时不采集行为数据，避免合规风险。</li></ol></li></ul> <h3 id="_3-业务价值层面-体现落地效果"><a href="#_3-业务价值层面-体现落地效果" class="header-anchor">#</a> 3. 业务价值层面：体现落地效果</h3> <p>亮点最终要回归 “业务价值”，用数据证明 SDK 的作用，例如：</p> <ul><li>**错误排查效率：**SDK 上线后，前端错误平均排查时间从 2 小时缩短至 15 分钟，线上错误率下降 40%。</li> <li>**性能优化效果：**通过监控发现 LCP 瓶颈（某首屏图片未压缩），优化后 LCP 从 5s 降至 2.5s，首屏加载时间缩短 30%。</li> <li>**业务问题定位：**通过行为监控发现 “某支付按钮点击后无响应”，定位到是 IE 浏览器下的兼容性问题，修复后支付转化率提升 5%。</li></ul> <h2 id="四、面试准备建议"><a href="#四、面试准备建议" class="header-anchor">#</a> 四、面试准备建议</h2> <ol><li><strong>梳理项目细节</strong>：明确你在 SDK 项目中负责的模块（如错误监控 / 性能上报），准备 1-2 个 “难点解决案例”（按 “痛点 - 方案 - 效果” 结构表述）。</li> <li><strong>模拟问题回答</strong>：针对高频考点（如错误捕获方式、SPA 监控、source-map 解析），提前组织语言，结合项目实际代码片段（如 “我们当时是这么重写 XMLHttpRequest 的：xxx”）。</li> <li><strong>体现主动性</strong>：主动提及 “你做的优化” 或 “未来可改进的方向”（如 “目前 SDK 在 Web Worker 内的错误监控还未覆盖，后续计划调研 Worker 错误捕获方案”），展现思考深度。</li></ol> <h1 id="二、前端监控-sdk-高频面试题与回答模板"><a href="#二、前端监控-sdk-高频面试题与回答模板" class="header-anchor">#</a> 二、前端监控 SDK 高频面试题与回答模板</h1> <p>以下梳理<strong>15 道高频面试题</strong>，涵盖基础原理、难点解决、工程化、业务价值四大维度，每个问题配套 “回答模板”（含核心逻辑 + 项目结合点 + 加分项），帮你精准匹配面试场景，避免泛泛而谈。</p> <h2 id="一、基础原理类-必问-考察核心认知"><a href="#一、基础原理类-必问-考察核心认知" class="header-anchor">#</a> 一、基础原理类（必问，考察核心认知）</h2> <h3 id="_1-前端监控-sdk-主要监控哪些内容-请分别说明实现思路。☆☆☆☆☆"><a href="#_1-前端监控-sdk-主要监控哪些内容-请分别说明实现思路。☆☆☆☆☆" class="header-anchor">#</a> 1. 前端监控 SDK 主要监控哪些内容？请分别说明实现思路。☆☆☆☆☆</h3> <p><strong>回答模板</strong>：</p> <p>前端监控 SDK 核心覆盖 4 类内容，我们项目中也是围绕这几块落地的：</p> <ol><li><strong>错误监控</strong>：监控 JS 运行时错误、资源加载错误、Promise 错误、框架错误
<ul><li>运行时 / 语法错误：用<code>window.onerror</code>捕获，注意过滤<code>script error</code>（需配置<code>crossorigin</code>和服务端 CORS 头）；</li> <li>资源错误：用<code>window.addEventListener('error', e =&gt; { if(e.target instanceof HTMLImageElement/HTMLLinkElement) { ... } })</code>，区分资源类型（图 / 样式 / 脚本）；</li> <li>Promise 错误：用<code>window.addEventListener('unhandledrejection', e =&gt; { ... })</code>，避免静默失败；</li> <li>框架错误：React 用<code>ErrorBoundary</code>、Vue 用<code>app.config.errorHandler</code>，我们项目还适配了 Vue2/Vue3 双版本。</li></ul></li> <li><strong>性能监控</strong>：重点监控 Core Web Vitals 和传统指标
<ul><li>核心指标：LCP 用<code>PerformanceObserver</code>监听<code>largest-contentful-paint</code>类型，FID/CLS 同理；</li> <li>传统指标：FP/FCP/TTI 通过<code>performance.getEntriesByType('navigation')</code>（新标准）计算，旧浏览器降级用<code>performance.timing</code>；</li> <li>自定义性能：拦截<code>XHR/fetch</code>记录接口耗时，我们项目还加了 “组件渲染耗时”（React 用<code>useEffect</code>记录挂载时间）。</li></ul></li> <li><strong>行为监控</strong>：用于问题复现，需做数据脱敏
<ul><li>PV/UV：用<code>visibilitychange</code>判断页面可见性，避免重复统计；停留时间记录<code>pageshow</code>和<code>pagehide</code>的时间差；</li> <li>用户操作：<code>document</code>代理点击事件，过滤非用户触发（如<code>dispatchEvent</code>），输入内容只记录长度不记录原文（合规要求）。</li></ul></li> <li><strong>异常上报</strong>：确保不丢包、不影响主流程
<ul><li>上报方式：优先用<code>img</code>标签（兼容性好），大体积数据用<code>fetch</code>（配<code>keep-alive</code>）；</li> <li>策略：批量上报（500ms 防抖）+ 失败重试（3 次，间隔指数退避），我们项目还加了 “离线缓存”（<code>localStorage</code>暂存，联网后补发）。</li></ul></li></ol> <h3 id="_2-如何解决-跨域脚本错误-script-error-无法获取完整堆栈的问题"><a href="#_2-如何解决-跨域脚本错误-script-error-无法获取完整堆栈的问题" class="header-anchor">#</a> 2. 如何解决 “跨域脚本错误（Script error）” 无法获取完整堆栈的问题？</h3> <p><strong>回答模板</strong>：</p> <p>跨域脚本错误的核心原因是 “浏览器安全策略限制”—— 跨域脚本执行错误时，为避免泄露敏感信息，只返回<code>Script error.</code>，不提供堆栈和行号。我们项目分两步彻底解决：</p> <ol><li><p><strong>第一步：突破浏览器限制，获取完整错误信息</strong></p> <ul><li>脚本标签加 <code>crossorigin=&quot;anonymous&quot;</code>：告诉浏览器 “该脚本允许跨域访问”；</li> <li>服务端配置 CORS 响应头：在 CDN 或静态资源服务器添加<code>Access-Control-Allow-Origin: *</code>（或指定业务域名），确保浏览器认可跨域权限。这一步做完后，<code>window.onerror</code>就能捕获到完整的错误堆栈（如<code>Uncaught ReferenceError: a is not defined at xxx.js:10</code>）。</li></ul></li> <li><p><strong>第二步：处理压缩代码的堆栈还原（关键补充）</strong></p> <p>线上代码通常经过压缩（如 Terser），堆栈中的行号是压缩后的位置，开发无法定位。我们项目的方案是：</p> <ul><li>构建时生成<code>source-map</code>文件（只保留生产环境必要信息，排除注释），上传到内部服务器（不对外暴露）；</li> <li>错误上报时，携带 “压缩文件名 + 压缩后行号 / 列号”；</li> <li>后端（或监控平台）用<code>source-map</code>库（如<code>source-map</code> npm 包）解析，将压缩后的位置还原为源码位置，最终在平台上展示 “哪个文件的哪一行出了错”。</li></ul></li></ol> <p>实际效果：跨域错误的可定位率从 0 提升到 95% 以上，排查效率大幅提升。</p> <h3 id="_3-单页应用-spa-的监控和传统多页应用有什么区别-你是怎么适配-spa-的"><a href="#_3-单页应用-spa-的监控和传统多页应用有什么区别-你是怎么适配-spa-的" class="header-anchor">#</a> 3. <s>单页应用（SPA）的监控和传统多页应用有什么区别？你是怎么适配 SPA 的？</s></h3> <p><strong>回答模板</strong>：</p> <p>SPA 和多页应用的核心区别是 “路由切换不刷新页面”，导致传统监控的 3 个关键问题：</p> <ul><li>PV 统计不准（多页靠<code>pageshow</code>，SPA 路由切换不触发）</li> <li>性能指标重复计算（如 FCP 只在首次加载时触发，路由切换后无法重新统计）</li> <li>错误监控断档（路由切换后，旧页面的<code>onerror</code>监听可能被销毁）</li></ul> <p>我们项目针对 SPA 做了 3 点适配，以 React Router 为例：</p> <ol><li><strong>PV 统计与页面生命周期管理</strong> <ul><li>监听路由钩子：在<code>useEffect</code>（或<code>history.listen</code>）中，路由切换时触发 “虚拟页面加载” 事件，重新初始化 PV 统计（记录新路由的<code>pageshow</code>时间）；</li> <li>页面停留时间：路由切换时，计算上一个路由的 “离开时间 - 进入时间”，上报停留时间，避免数据丢失。</li></ul></li> <li><strong>性能指标重新采集</strong> <ul><li>路由切换后，重新监听 LCP/CLS：销毁上一个路由的<code>PerformanceObserver</code>，创建新实例，确保新页面的性能指标能被捕获；</li> <li>自定义 “路由切换耗时”：记录<code>history.push</code>触发时间和新组件<code>componentDidMount</code>（或<code>useEffect</code>）执行时间，计算路由切换的前端耗时（反映 SPA 的交互流畅度）。</li></ul></li> <li><strong>错误监控持续生效</strong> <ul><li>全局错误监听（如<code>window.onerror</code>）不随路由销毁，但框架错误（如 React 组件错误）需确保<code>ErrorBoundary</code>在根组件层级，覆盖所有路由页面；</li> <li>路由切换时，清空上一个页面的 “错误去重缓存”（避免同一错误在不同路由下被误判为新错误）。</li></ul></li></ol> <p>适配后，SPA 的监控数据和多页应用一致，能精准反映每个路由的错误、性能和用户行为。</p> <h3 id="_4-如何拦截-xhr-fetch-请求-实现接口耗时和错误的监控-☆☆☆"><a href="#_4-如何拦截-xhr-fetch-请求-实现接口耗时和错误的监控-☆☆☆" class="header-anchor">#</a> 4. 如何拦截 XHR/fetch 请求，实现接口耗时和错误的监控？☆☆☆</h3> <p><strong>回答模板</strong>：</p> <p>拦截请求的核心思路是 “重写原生方法，注入监控逻辑”，我们项目同时支持 XHR 和 fetch，方案如下：</p> <h4 id="_1-xhr-拦截-重写原型方法"><a href="#_1-xhr-拦截-重写原型方法" class="header-anchor">#</a> （1）XHR 拦截：重写原型方法</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 保存原生方法</span>
<span class="token keyword">const</span> originalOpen <span class="token operator">=</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>open<span class="token punctuation">;</span>
<span class="token keyword">const</span> originalSend <span class="token operator">=</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>send<span class="token punctuation">;</span>

<span class="token comment">// 重写open：记录请求方法、URL</span>
<span class="token class-name">XMLHttpRequest</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">open</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">method<span class="token punctuation">,</span> url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_monitor <span class="token operator">=</span> <span class="token punctuation">{</span> method<span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token literal-property property">startTime</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 挂载监控信息到XHR实例</span>
  <span class="token function">originalOpen</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 重写send：监听load/error/abort事件，记录结果和耗时</span>
<span class="token class-name">XMLHttpRequest</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">send</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">body</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token comment">// 监听请求完成</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> endTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'xhr'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">method</span><span class="token operator">:</span> _this<span class="token punctuation">.</span>_monitor<span class="token punctuation">.</span>method<span class="token punctuation">,</span>
      <span class="token literal-property property">url</span><span class="token operator">:</span> _this<span class="token punctuation">.</span>_monitor<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
      <span class="token literal-property property">status</span><span class="token operator">:</span> _this<span class="token punctuation">.</span>status<span class="token punctuation">,</span>
      <span class="token literal-property property">duration</span><span class="token operator">:</span> endTime <span class="token operator">-</span> _this<span class="token punctuation">.</span>_monitor<span class="token punctuation">.</span>startTime<span class="token punctuation">,</span>
      <span class="token literal-property property">isError</span><span class="token operator">:</span> _this<span class="token punctuation">.</span>status <span class="token operator">&gt;=</span> <span class="token number">400</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">report</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 上报数据</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 监听错误和中断</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> handleError<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'abort'</span><span class="token punctuation">,</span> handleAbort<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token function">originalSend</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_2-fetch-拦截-包装-promise"><a href="#_2-fetch-拦截-包装-promise" class="header-anchor">#</a> （2）fetch 拦截：包装 Promise</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> originalFetch <span class="token operator">=</span> window<span class="token punctuation">.</span>fetch<span class="token punctuation">;</span>
window<span class="token punctuation">.</span><span class="token function-variable function">fetch</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">input<span class="token punctuation">,</span> init <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">typeof</span> input <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">?</span> input <span class="token operator">:</span> input<span class="token punctuation">.</span>url<span class="token punctuation">;</span>
  <span class="token keyword">const</span> method <span class="token operator">=</span> init<span class="token punctuation">.</span>method <span class="token operator">||</span> <span class="token string">'GET'</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> startTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 包装Promise，捕获成功/失败</span>
  <span class="token keyword">return</span> <span class="token function">originalFetch</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> init<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 复制response（避免被消费后无法读取）</span>
      <span class="token keyword">const</span> clonedResponse <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> endTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'fetch'</span><span class="token punctuation">,</span>
        method<span class="token punctuation">,</span>
        url<span class="token punctuation">,</span>
        <span class="token literal-property property">status</span><span class="token operator">:</span> response<span class="token punctuation">.</span>status<span class="token punctuation">,</span>
        <span class="token literal-property property">duration</span><span class="token operator">:</span> endTime <span class="token operator">-</span> startTime<span class="token punctuation">,</span>
        <span class="token literal-property property">isError</span><span class="token operator">:</span> response<span class="token punctuation">.</span>status <span class="token operator">&gt;=</span> <span class="token number">400</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token comment">// 如果是JSON响应，可额外记录响应体（需脱敏）</span>
      clonedResponse<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">resBody</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        data<span class="token punctuation">.</span>responseBody <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>resBody<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 只取前200字符</span>
        <span class="token function">report</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">report</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 非JSON响应直接上报</span>
      <span class="token keyword">return</span> response<span class="token punctuation">;</span> <span class="token comment">// 不影响原业务逻辑</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> endTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">report</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'fetch'</span><span class="token punctuation">,</span>
        method<span class="token punctuation">,</span>
        url<span class="token punctuation">,</span>
        <span class="token literal-property property">duration</span><span class="token operator">:</span> endTime <span class="token operator">-</span> startTime<span class="token punctuation">,</span>
        <span class="token literal-property property">isError</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token literal-property property">errorMsg</span><span class="token operator">:</span> error<span class="token punctuation">.</span>message
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">throw</span> error<span class="token punctuation">;</span> <span class="token comment">// 抛出错误，不影响业务的catch逻辑</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_3-关键注意点"><a href="#_3-关键注意点" class="header-anchor">#</a> （3）关键注意点</h4> <ul><li>不破坏原生逻辑：所有重写都调用<code>apply</code>/<code>call</code>保留原生行为，避免影响业务代码；</li> <li>处理异常场景：如 XHR 的<code>abort</code>、fetch 的网络错误，确保这些场景下也能上报；</li> <li>数据脱敏：接口 URL 中的敏感参数（如手机号）需替换（如<code>/user/13800138000</code>→<code>/user/****</code>），响应体不记录完整信息，符合隐私合规。</li></ul> <h2 id="二、难点解决类-区分度题-考察实战能力"><a href="#二、难点解决类-区分度题-考察实战能力" class="header-anchor">#</a> 二、难点解决类（区分度题，考察实战能力）</h2> <h3 id="_5-如何避免-sdk-自身的代码影响页面性能-如占用主线程、消耗带宽-☆☆☆"><a href="#_5-如何避免-sdk-自身的代码影响页面性能-如占用主线程、消耗带宽-☆☆☆" class="header-anchor">#</a> 5. 如何避免 SDK 自身的代码影响页面性能？（如占用主线程、消耗带宽）☆☆☆</h3> <p><strong>回答模板</strong>：</p> <p>SDK 的核心原则是 “监控不添乱”，我们项目从 “执行、上报、体积” 三个维度做了优化，确保对页面性能的影响低于 1%：</p> <ol><li><strong>降低主线程占用：让监控逻辑 “不抢资源”</strong> <ul><li>非紧急逻辑用<code>requestIdleCallback</code>：如行为日志的格式化、非核心指标（如滚动位置）的计算，只在浏览器空闲时执行，避免阻塞 JS 执行和页面渲染；</li> <li>复杂计算移交 Web Worker：如错误堆栈的解析（尤其是<code>source-map</code>还原）、大量日志的压缩，我们项目用 Worker 处理后，主线程占用率从 8% 降至 1% 以下；</li> <li>高频事件节流：如<code>resize</code>/<code>scroll</code>监控，用 100ms 节流，避免每秒触发几十次监控逻辑。</li></ul></li> <li><strong>减少网络消耗：让上报 “不占带宽”</strong> <ul><li>批量上报：将零散的日志（如行为点击、小错误）缓存到内存队列，500ms 防抖批量上报一次，HTTP 请求数减少 80%；</li> <li>数据压缩：上报前用<code>pako</code>库将 JSON 数据压缩为 gzip 格式（体积减少 60%），服务端解压后解析；</li> <li>弱网适配：通过<code>navigator.connection.effectiveType</code>判断网络类型（如 2G/3G），弱网下延迟上报非关键数据（如行为日志），优先保证错误和性能数据上报。</li></ul></li> <li><strong>控制 SDK 体积：让加载 “不拖慢首屏”</strong> <ul><li>插件化按需加载：将 SDK 拆分为 “核心上报模块”（必选，5KB）、“错误监控模块”（可选，3KB）、“行为监控模块”（可选，2KB），业务方只引入需要的模块；</li> <li>Tree-shaking 优化：用 ES 模块（ESM）打包，配合 Webpack/Rollup 的 Tree-shaking，剔除未使用的代码（如不开启行为监控则不打包相关逻辑）；</li> <li>异步加载 SDK：业务方通过动态脚本插入（<code>document.createElement('script')</code>）加载 SDK，且放在<code>DOMContentLoaded</code>后执行，不阻塞首屏渲染。</li></ul></li></ol> <p>我们还在内部做了性能压测：在低端机（如 iPhone 8）和弱网（3G）环境下，集成 SDK 后页面的 FCP 只延迟了 20ms，完全在可接受范围内。</p> <h3 id="_6-如何解决-错误重复上报-的问题-请举例说明。☆☆☆"><a href="#_6-如何解决-错误重复上报-的问题-请举例说明。☆☆☆" class="header-anchor">#</a> 6. 如何解决 “错误重复上报” 的问题？请举例说明。☆☆☆</h3> <p><strong>回答模板</strong>：</p> <p>错误重复上报的核心原因是 “同一错误触发多次监控事件”，比如：</p> <ul><li>循环中抛出的错误（每秒触发 10 次<code>onerror</code>）</li> <li>SPA 路由切换后，旧页面的错误监听未销毁，重复捕获同一错误</li> <li>同一错误在不同生命周期（如<code>load</code>和<code>DOMContentLoaded</code>）被捕获</li></ul> <p>我们项目用 “<strong>唯一标识去重 + 过期清理</strong>” 的方案解决，具体分 3 步：</p> <ol><li><p><strong>生成错误的唯一标识（key）</strong></p> <p>基于 “错误的核心特征” 生成哈希值，确保同一错误的 key 唯一，不同错误的 key 不同。我们项目的 key 生成规则是：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">generateErrorKey</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 核心特征：错误类型+错误信息+堆栈的关键行（前3行）+当前URL</span>
  <span class="token keyword">const</span> errorType <span class="token operator">=</span> error<span class="token punctuation">.</span>name <span class="token operator">||</span> <span class="token string">'UnknownError'</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> errorMsg <span class="token operator">=</span> error<span class="token punctuation">.</span>message <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> stackKey <span class="token operator">=</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>stack <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 取堆栈前3行，避免过长</span>
  <span class="token keyword">const</span> url <span class="token operator">=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">;</span>
  <span class="token comment">// 用MD5生成短哈希（避免key过长）</span>
  <span class="token keyword">return</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>errorType<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>errorMsg<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>stackKey<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><strong>用 “去重缓存” 记录已上报的错误</strong></p> <p>用<code>localStorage</code>（持久化，避免页面刷新后失效）+ 内存对象（高效读取）维护去重缓存，结构如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 内存缓存：记录当前页面已上报的错误key（页面关闭后清空）</span>
<span class="token keyword">const</span> inMemoryCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// localStorage缓存：记录24小时内已上报的错误key（跨页面/刷新生效）</span>
<span class="token keyword">const</span> <span class="token function-variable function">getLocalCache</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'monitor_error_cache'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'{}'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">setLocalCache</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">cache</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'monitor_error_cache'</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>cache<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 检查错误是否已上报</span>
<span class="token keyword">function</span> <span class="token function">isErrorReported</span><span class="token punctuation">(</span><span class="token parameter">errorKey</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 先查内存（快），再查localStorage（持久）</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>inMemoryCache<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>errorKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> localCache <span class="token operator">=</span> <span class="token function">getLocalCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> now <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 清理24小时前的过期缓存（避免localStorage膨胀）</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>localCache<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> localCache<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token keyword">delete</span> localCache<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setLocalCache</span><span class="token punctuation">(</span>localCache<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 判断是否存在未过期的key</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>localCache<span class="token punctuation">[</span>errorKey<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token comment">// 不存在则加入缓存</span>
  inMemoryCache<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>errorKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
  localCache<span class="token punctuation">[</span>errorKey<span class="token punctuation">]</span> <span class="token operator">=</span> now<span class="token punctuation">;</span>
  <span class="token function">setLocalCache</span><span class="token punctuation">(</span>localCache<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><strong>上报前校验去重</strong></p> <p>在错误上报函数中加入校验，已上报的错误直接跳过：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">reportError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> errorKey <span class="token operator">=</span> <span class="token function">generateErrorKey</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isErrorReported</span><span class="token punctuation">(</span>errorKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'重复错误，跳过上报'</span><span class="token punctuation">,</span> errorKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 正常上报逻辑...</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <p>实际效果：之前循环错误会上报 100 次，现在只上报 1 次；SPA 路由切换后的重复错误也被完全过滤，错误数据的准确性提升 90%。</p> <h3 id="_7-如何监控前端的-白屏-问题-白屏的常见原因有哪些"><a href="#_7-如何监控前端的-白屏-问题-白屏的常见原因有哪些" class="header-anchor">#</a> 7. 如何监控前端的 “白屏” 问题？白屏的常见原因有哪些？</h3> <p><strong>回答模板</strong>：</p> <p>白屏是前端严重的用户体验问题，核心是 “页面加载后，关键内容长时间未渲染”。我们项目从 “<strong>白屏检测</strong>” 和 “<strong>原因定位</strong>” 两方面实现监控：</p> <h4 id="_1-白屏检测方案-多维度判断"><a href="#_1-白屏检测方案-多维度判断" class="header-anchor">#</a> （1）白屏检测方案：多维度判断</h4> <p>结合 “DOM 渲染状态” 和 “时间阈值”，避免误判（如首屏加载慢但未白屏）：</p> <ol><li><strong>DOM 维度</strong>：监听<code>DOMContentLoaded</code>后，检查 “关键容器”（如<code>#app</code>）是否有子元素（排除空文本节点）；</li> <li><strong>时间维度</strong>：设置白屏阈值（如 5s），如果<code>load</code>事件触发后 5s，关键容器仍无有效内容，判定为白屏；</li> <li><strong>视觉维度</strong>：辅助判断（可选）—— 用<code>document.elementFromPoint(100, 100)</code>（取页面中间点），如果返回的元素是<code>html</code>/<code>body</code>或<code>null</code>，说明中间区域无内容。</li></ol> <p>核心代码逻辑：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">checkWhiteScreen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> criticalContainer <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'app'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 业务方配置的关键容器</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>criticalContainer<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// 容器不存在，不检测</span>

  <span class="token comment">// 检查容器是否有有效内容（排除空文本、注释节点）</span>
  <span class="token keyword">const</span> hasContent <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>criticalContainer<span class="token punctuation">.</span>childNodes<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token parameter">node</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 元素节点：有宽高或有子元素</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> rect <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> rect<span class="token punctuation">.</span>width <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> rect<span class="token punctuation">.</span>height <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">||</span> node<span class="token punctuation">.</span>childNodes<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 文本节点：非空（排除空格）</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> node<span class="token punctuation">.</span>textContent<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 时间阈值+DOM状态判断</span>
  <span class="token keyword">const</span> loadTime <span class="token operator">=</span> performance<span class="token punctuation">.</span>timing<span class="token punctuation">.</span>loadEventEnd <span class="token operator">-</span> performance<span class="token punctuation">.</span>timing<span class="token punctuation">.</span>navigationStart<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>loadTime <span class="token operator">&gt;</span> <span class="token number">5000</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>hasContent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 判定为白屏，上报数据</span>
    <span class="token function">report</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'whiteScreen'</span><span class="token punctuation">,</span>
      loadTime<span class="token punctuation">,</span>
      <span class="token literal-property property">container</span><span class="token operator">:</span> <span class="token string">'#app'</span><span class="token punctuation">,</span>
      <span class="token comment">// 补充上下文：当前URL、浏览器版本、网络类型</span>
      <span class="token literal-property property">url</span><span class="token operator">:</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">,</span>
      <span class="token literal-property property">ua</span><span class="token operator">:</span> navigator<span class="token punctuation">.</span>userAgent<span class="token punctuation">,</span>
      <span class="token literal-property property">network</span><span class="token operator">:</span> navigator<span class="token punctuation">.</span>connection<span class="token operator">?.</span>effectiveType
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 触发检测：load事件后1s（避免load刚触发时内容未渲染完）</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>checkWhiteScreen<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_2-白屏常见原因及定位"><a href="#_2-白屏常见原因及定位" class="header-anchor">#</a> （2）白屏常见原因及定位</h4> <p>上报白屏时，我们还会关联 “其他监控数据”，帮助快速定位原因：</p> <ul><li>原因 1：JS 执行错误（如首屏渲染脚本报错，导致<code>#app</code>未挂载）→ 关联 “错误监控数据”，看白屏时间是否有 JS 错误；</li> <li>原因 2：资源加载失败（如首屏 CSS/JS 加载超时）→ 关联 “资源错误数据”，看是否有<code>link</code>/<code>script</code>加载失败；</li> <li>原因 3：接口返回异常（如首屏接口返回 500，导致数据为空）→ 关联 “接口监控数据”，看白屏前是否有接口错误；</li> <li>原因 4：CSS 样式问题（如<code>#app</code>被设置<code>display: none</code>）→ 上报时记录关键容器的<code>computedStyle</code>（如<code>display</code>/<code>visibility</code>/<code>opacity</code>）。</li></ul> <p>实际案例：我们曾通过白屏监控发现，某活动页在 iOS 12 浏览器下白屏，关联错误数据后，定位到是 “ES6 语法未转译”（<code>const</code>未转成<code>var</code>），导致首屏 JS 报错。</p> <h2 id="三、工程化与架构类-考察深度-区分高级开发"><a href="#三、工程化与架构类-考察深度-区分高级开发" class="header-anchor">#</a> 三、工程化与架构类（考察深度，区分高级开发）</h2> <h3 id="_8-你设计的-sdk-是如何实现-可配置-和-可扩展-的-请举例说明。"><a href="#_8-你设计的-sdk-是如何实现-可配置-和-可扩展-的-请举例说明。" class="header-anchor">#</a> 8. 你设计的 SDK 是如何实现 “可配置” 和 “可扩展” 的？请举例说明。</h3> <p><strong>回答模板</strong>：</p> <p>SDK 的可配置和可扩展是 “产品化” 的关键 —— 不同业务方的需求不同（如 A 业务要行为监控，B 业务只需要错误监控），且未来可能新增功能（如小程序监控）。我们项目用 “<strong>配置中心 + 插件化架构</strong>” 实现，具体如下：</p> <h4 id="_1-可配置-分层配置-满足不同需求"><a href="#_1-可配置-分层配置-满足不同需求" class="header-anchor">#</a> （1）可配置：分层配置，满足不同需求</h4> <p>设计 “默认配置 + 业务配置 + 动态配置” 三层结构，优先级：动态配置 &gt; 业务配置 &gt; 默认配置：</p> <ol><li><strong>默认配置</strong>：内置基础配置，业务方无需关心（如上报间隔 500ms，采样率 100%）；</li> <li><strong>业务配置</strong>：业务方初始化时传入，覆盖默认配置（如<code>init({ enableBehavior: false, sampleRate: 50 })</code>）；</li> <li><strong>动态配置</strong>：通过接口拉取远程配置（如从监控平台获取），实时生效（如线上发现问题，动态关闭某模块）。</li></ol> <p>配置项设计（核心部分）：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> defaultConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">reportUrl</span><span class="token operator">:</span> <span class="token string">'https://monitor.xxx.com/report'</span><span class="token punctuation">,</span> <span class="token comment">// 默认上报地址</span>
  <span class="token literal-property property">modules</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 错误监控：默认开启</span>
    <span class="token literal-property property">performance</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 性能监控：默认开启</span>
    <span class="token literal-property property">behavior</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token comment">// 行为监控：默认关闭（避免隐私问题）</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">sampleRate</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token comment">// 采样率：默认100%（全量）</span>
  <span class="token literal-property property">batchInterval</span><span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token comment">// 批量上报间隔：500ms</span>
  <span class="token function-variable function">beforeReport</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> data<span class="token punctuation">,</span> <span class="token comment">// 上报前钩子：默认不处理</span>
  <span class="token literal-property property">whiteList</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 错误上报白名单：默认无（所有错误都上报）</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 初始化函数：合并配置</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token parameter">customConfig <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. 合并默认配置和业务配置</span>
  <span class="token keyword">const</span> mergedConfig <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>defaultConfig<span class="token punctuation">,</span> <span class="token operator">...</span>customConfig <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// 2. 拉取动态配置（异步，不阻塞初始化）</span>
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://monitor.xxx.com/config'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">dynamicConfig</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 动态配置覆盖合并后的配置</span>
      Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>mergedConfig<span class="token punctuation">,</span> dynamicConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 重新初始化模块（如动态关闭错误监控）</span>
      <span class="token function">reInitModules</span><span class="token punctuation">(</span>mergedConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 3. 初始化模块</span>
  <span class="token function">initModules</span><span class="token punctuation">(</span>mergedConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> mergedConfig<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_2-可扩展-插件化架构-支持新增功能"><a href="#_2-可扩展-插件化架构-支持新增功能" class="header-anchor">#</a> （2）可扩展：插件化架构，支持新增功能</h4> <p>将 SDK 拆分为 “核心层” 和 “插件层”，核心层提供基础能力（如上报、配置管理），插件层实现具体监控功能（如错误插件、性能插件）：</p> <ol><li><p><strong>核心层能力</strong>：</p> <ul><li>配置管理：提供<code>getConfig()</code>/<code>setConfig()</code>方法，供插件获取配置；</li> <li>上报管理：提供<code>report(data)</code>方法，统一处理批量、重试、压缩；</li> <li>插件注册：提供<code>registerPlugin(plugin)</code>方法，标准化插件接入。</li></ul></li> <li><p><strong>插件标准化接口</strong>：</p> <p>每个插件必须实现<code>name</code>（唯一标识）、<code>init</code>（初始化）、<code>destroy</code>（销毁）三个方法，核心层通过接口调用插件：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 错误监控插件示例</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> ErrorPlugin <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token comment">// 插件名，与配置中的modules.error对应</span>
  <span class="token function">init</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 初始化错误监听（window.onerror等）</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">bindListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 销毁监听，避免内存泄漏</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">unbindListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">bindListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span>onerror <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleError</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...其他监听</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">handleError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 错误处理逻辑</span>
    <span class="token function">report</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token operator">...</span>error <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 核心层注册插件</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">registerPlugin</span><span class="token punctuation">(</span><span class="token parameter">plugin</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>plugin<span class="token punctuation">.</span>name <span class="token operator">||</span> <span class="token operator">!</span>plugin<span class="token punctuation">.</span>init<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'插件必须实现name和init方法'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 存入插件列表</span>
  window<span class="token punctuation">.</span>__MONITOR_PLUGINS__ <span class="token operator">=</span> window<span class="token punctuation">.</span>__MONITOR_PLUGINS__ <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  window<span class="token punctuation">.</span>__MONITOR_PLUGINS__<span class="token punctuation">[</span>plugin<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> plugin<span class="token punctuation">;</span>
  <span class="token comment">// 根据配置决定是否初始化</span>
  <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>modules<span class="token punctuation">[</span>plugin<span class="token punctuation">.</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    plugin<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><strong>扩展案例</strong>：新增 “小程序监控插件”</p> <p>无需修改核心层代码，只需开发新插件，实现<code>init</code>/<code>destroy</code>：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">const</span> MiniProgramPlugin <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'miniProgram'</span><span class="token punctuation">,</span>
  <span class="token function">init</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 小程序特有的监控逻辑（如App.onError、Page.onLoad）</span>
    <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token function-variable function">onError</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">report</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'miniProgramError'</span><span class="token punctuation">,</span> <span class="token operator">...</span>error <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 小程序销毁逻辑</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 业务方引入并注册</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> registerPlugin<span class="token punctuation">,</span> MiniProgramPlugin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'monitor-sdk'</span><span class="token punctuation">;</span>
<span class="token function">registerPlugin</span><span class="token punctuation">(</span>MiniProgramPlugin<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li></ol> <p>这种架构的优势：新增功能不影响现有代码，插件可独立迭代，业务方按需引入，灵活性极高。</p> <h3 id="_9-sdk-的-数据上报-模块需要考虑哪些问题-如何设计一个可靠的上报方案-☆☆☆☆"><a href="#_9-sdk-的-数据上报-模块需要考虑哪些问题-如何设计一个可靠的上报方案-☆☆☆☆" class="header-anchor">#</a> 9. SDK 的 “数据上报” 模块需要考虑哪些问题？如何设计一个可靠的上报方案？☆☆☆☆</h3> <p><strong>回答模板</strong>：</p> <p>上报模块是 SDK 的 “最后一公里”，核心目标是 “<strong>不丢数据、不影响业务、可追溯</strong>”。我们项目从 “<strong>可靠性</strong>”“<strong>安全性</strong>”“<strong>可观测性</strong>” 三个维度设计上报方案：</p> <h4 id="_1-可靠性-确保数据不丢"><a href="#_1-可靠性-确保数据不丢" class="header-anchor">#</a> （1）可靠性：确保数据不丢</h4> <ol><li><strong>批量上报 + 内存队列</strong>：
<ul><li>所有待上报数据先存入内存队列（<code>Array</code>），500ms 防抖批量上报（减少 HTTP 请求）；</li> <li>队列满了（如 100 条）强制上报，避免内存溢出。</li></ul></li> <li><strong>失败重试机制</strong>：
<ul><li>上报失败后，将数据移入 “重试队列”，重试 3 次，间隔指数退避（1s→2s→4s），避免频繁重试占用资源；</li> <li>3 次重试失败后，将数据存入<code>localStorage</code>（离线缓存），下次页面加载时检查并补发。</li></ul></li> <li><strong>上报方式降级</strong>：
<ul><li>优先用<code>fetch</code>（支持 POST、大体积数据、CORS）；</li> <li>不支持<code>fetch</code>的浏览器（如 IE11），降级用<code>img</code>标签（兼容性最好，适合小体积数据，如错误日志）；</li> <li><code>img</code>标签也失败时（如网络中断），走离线缓存。</li></ul></li></ol> <p>核心代码（简化版）：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Reporter</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>queue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 待上报队列</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>retryQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 重试队列</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 批量上报定时器</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 添加数据到队列</span>
  <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">triggerBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 触发批量上报</span>
    <span class="token comment">// 队列满了强制上报</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span>length <span class="token operator">&gt;=</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reportBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 防抖触发批量上报</span>
  <span class="token function">triggerBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">clearTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reportBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 批量上报</span>
  <span class="token keyword">async</span> <span class="token function">reportBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 取出队列数据</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 上报成功：如果有重试队列，优先上报重试队列</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>retryQueue<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> retryData <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>retryQueue<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>retryData<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 上报失败：加入重试队列</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>retryQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 重试3次后存入localStorage</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>retryQueue<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">3</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">saveToLocal</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>retryQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 发送请求（支持fetch/img降级）</span>
  <span class="token function">send</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> jsonData <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 优先用fetch</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>fetch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>reportUrl<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/json'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">body</span><span class="token operator">:</span> jsonData<span class="token punctuation">,</span>
        <span class="token literal-property property">credentials</span><span class="token operator">:</span> <span class="token string">'include'</span><span class="token punctuation">,</span> <span class="token comment">// 携带Cookie（用于用户标识）</span>
        <span class="token literal-property property">keepalive</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token comment">// 页面卸载时也能完成上报</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">.</span>ok<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'上报失败'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 降级用img标签（只支持GET，需将数据编码为query）</span>
    <span class="token keyword">const</span> img <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    img<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>reportUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?data=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>jsonData<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      img<span class="token punctuation">.</span>onload <span class="token operator">=</span> resolve<span class="token punctuation">;</span>
      img<span class="token punctuation">.</span>onerror <span class="token operator">=</span> reject<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 离线缓存到localStorage</span>
  <span class="token function">saveToLocal</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">monitor_offline_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 初始化：补发离线缓存</span>
  <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 遍历localStorage，补发所有离线数据</span>
    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>localStorage<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'monitor_offline_'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        localStorage<span class="token punctuation">.</span><span class="token function">removeItem</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 补发后删除</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_2-安全性-确保数据合规、不泄露"><a href="#_2-安全性-确保数据合规、不泄露" class="header-anchor">#</a> （2）安全性：确保数据合规、不泄露</h4> <ol><li><strong>数据脱敏</strong>：
<ul><li>用户信息：手机号、邮箱、身份证号用<code>*</code>替换（如<code>138****8000</code>）；</li> <li>URL 参数：敏感参数（如<code>token</code>/<code>password</code>）从上报的 URL 中剔除；</li> <li>响应体：只记录前 200 字符，且过滤<code>data.user</code>等敏感字段。</li></ul></li> <li><strong>权限控制</strong>：
<ul><li>提供<code>beforeReport</code>钩子，业务方可自定义过滤数据（如<code>beforeReport: (data) =&gt; data.type !== 'behavior' ? data : null</code>，不上报行为数据）；</li> <li>动态配置 “上报白名单”，只允许指定域名的上报请求（避免恶意使用 SDK 上报垃圾数据）。</li></ul></li> <li><strong>隐私合规</strong>：
<ul><li>支持 “用户授权开关”，用户拒绝授权时，不采集行为、设备等敏感数据；</li> <li>上报数据不包含唯一用户标识（如 UUID），如需用户关联，由业务方传入脱敏后的用户 ID。</li></ul></li></ol> <h4 id="_3-可观测性-确保上报问题可追溯"><a href="#_3-可观测性-确保上报问题可追溯" class="header-anchor">#</a> （3）可观测性：确保上报问题可追溯</h4> <ol><li><strong>上报日志</strong>：
<ul><li>上报成功 / 失败的日志，在开发环境打印到控制台（生产环境关闭），方便调试；</li> <li>上报数据中加入<code>reportId</code>（唯一标识），监控平台可通过<code>reportId</code>查询具体上报记录。</li></ul></li> <li><strong>上报监控</strong>：
<ul><li>在 SDK 内部监控 “上报成功率”，如果成功率低于 90%，触发告警（如钉钉通知）；</li> <li>记录上报耗时，如耗时超过 1s，调整批量上报策略（如减少单次上报数据量）。</li></ul></li></ol> <h3 id="_10-如何设计-sdk-的-采样策略-为什么需要采样"><a href="#_10-如何设计-sdk-的-采样策略-为什么需要采样" class="header-anchor">#</a> 10. 如何设计 SDK 的 “采样策略”？为什么需要采样？</h3> <p><strong>回答模板</strong>：</p> <p>采样的核心目的是 “<strong>在保证数据准确性的前提下，降低 SDK 对业务的性能影响和监控平台的存储压力</strong>”—— 如果百万级用户全量上报，每天可能产生 TB 级数据，存储和计算成本极高，且大部分数据是重复的（如同一错误在不同用户端触发）。</p> <p>我们项目设计了 “<strong>分层采样策略</strong>”，根据 “数据类型” 和 “业务场景” 动态调整采样率，具体如下：</p> <h4 id="_1-为什么需要采样"><a href="#_1-为什么需要采样" class="header-anchor">#</a> （1）为什么需要采样？</h4> <ol><li><strong>降低性能消耗</strong>：全量上报会产生大量 HTTP 请求，占用带宽和主线程资源，尤其是弱网和低端机；</li> <li><strong>减少存储成本</strong>：监控平台存储全量数据的成本极高（如 100 万用户，每人每天产生 100 条日志，每天 10 亿条，约 100GB）；</li> <li><strong>保证数据有效性</strong>：大部分重复数据（如同一错误）对分析价值不大，采样后的数据仍能反映整体趋势（如错误率、性能指标分布）。</li></ol> <h4 id="_2-分层采样策略设计"><a href="#_2-分层采样策略设计" class="header-anchor">#</a> （2）分层采样策略设计</h4> <p>根据数据的 “重要性” 和 “重复率”，设置不同的采样率：</p> <table><thead><tr><th>数据类型</th> <th>重要性</th> <th>重复率</th> <th>采样率策略</th> <th>示例</th></tr></thead> <tbody><tr><td>错误监控</td> <td>高</td> <td>中</td> <td>100% 全量（关键错误不遗漏）</td> <td>所有 JS 错误、资源错误全量上报</td></tr> <tr><td>性能监控</td> <td>中</td> <td>高</td> <td>按用户采样（如 50%）</td> <td>50% 用户的 LCP/CLS 数据上报</td></tr> <tr><td>行为监控</td> <td>低</td> <td>极高</td> <td>按用户 + 事件采样（如 20%）</td> <td>20% 用户的点击、输入事件上报</td></tr> <tr><td>白屏 / 崩溃监控</td> <td>极高</td> <td>低</td> <td>100% 全量（严重问题不遗漏）</td> <td>所有白屏、页面崩溃全量上报</td></tr></tbody></table> <h4 id="_3-采样实现方案"><a href="#_3-采样实现方案" class="header-anchor">#</a> （3）采样实现方案</h4> <ol><li><p><strong>用户级采样</strong>：基于用户唯一标识（如<code>navigator.userAgent</code>+<code>screen.width</code>的哈希值），确保同一用户始终被采样（或不被采样），避免数据偏差：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 生成用户唯一标识（非隐私数据，只用于采样）</span>
<span class="token keyword">function</span> <span class="token function">generateUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ua <span class="token operator">=</span> navigator<span class="token punctuation">.</span>userAgent<span class="token punctuation">;</span>
  <span class="token keyword">const</span> screen <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>window<span class="token punctuation">.</span>screen<span class="token punctuation">.</span>width<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">x</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>window<span class="token punctuation">.</span>screen<span class="token punctuation">.</span>height<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ua<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>screen<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 取前8位哈希</span>
<span class="token punctuation">}</span>

<span class="token comment">// 用户级采样：判断用户是否在采样范围内</span>
<span class="token keyword">function</span> <span class="token function">isUserSampled</span><span class="token punctuation">(</span><span class="token parameter">sampleRate</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>sampleRate <span class="token operator">===</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> userId <span class="token operator">=</span> <span class="token function">generateUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 将哈希值转为数字（0-15777215，因为8位16进制最大是FF FF FF = 16^6-1=16777215）</span>
  <span class="token keyword">const</span> userNum <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 采样率=样本数/总数 → 如50%采样率：userNum &lt; 16777215 * 0.5</span>
  <span class="token keyword">return</span> userNum <span class="token operator">&lt;</span> <span class="token number">16777215</span> <span class="token operator">*</span> <span class="token punctuation">(</span>sampleRate <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><strong>事件级采样</strong>：对高频事件（如点击），在用户级采样的基础上，再做事件级采样（如 20% 的点击事件上报），进一步减少数据量：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 事件级采样：随机判断当前事件是否上报</span>
<span class="token keyword">function</span> <span class="token function">isEventSampled</span><span class="token punctuation">(</span><span class="token parameter">sampleRate</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>sampleRate <span class="token operator">===</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token punctuation">(</span>sampleRate <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 行为监控插件中的采样逻辑</span>
<span class="token keyword">function</span> <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 先判断用户是否在采样范围内，再判断事件是否被采样</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUserSampled</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>behaviorSampleRate<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isEventSampled</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">report</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token literal-property property">target</span><span class="token operator">:</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>tagName<span class="token punctuation">,</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><strong>动态调整采样率</strong>：</p> <ul><li>峰值时段（如电商大促）：自动降低采样率（如从 50% 降至 20%），避免监控平台过载；</li> <li>新功能上线：提高采样率（如 100%），确保能捕获新功能的错误和性能问题；</li> <li>异常场景：如错误率突增，自动提高该错误类型的采样率（100%），便于定位原因。</li></ul></li></ol> <h4 id="_4-采样数据的准确性保障"><a href="#_4-采样数据的准确性保障" class="header-anchor">#</a> （4）采样数据的准确性保障</h4> <ul><li><strong>分层抽样</strong>：确保不同用户群体（如不同浏览器、不同设备）的采样比例一致，避免数据偏差；</li> <li><strong>数据校正</strong>：监控平台展示时，用 “采样率” 对数据进行校正（如采样率 50%，统计错误数时乘以 2），反映真实情况；</li> <li><strong>采样日志</strong>：上报数据中携带<code>sampleRate</code>字段，方便平台后续分析和校正。</li></ul> <h2 id="四、业务价值与优化类-考察思维高度-加分项"><a href="#四、业务价值与优化类-考察思维高度-加分项" class="header-anchor">#</a> 四、业务价值与优化类（考察思维高度，加分项）</h2> <h3 id="_11-你做的监控-sdk-给业务带来了哪些实际价值-请举-1-2-个具体案例。"><a href="#_11-你做的监控-sdk-给业务带来了哪些实际价值-请举-1-2-个具体案例。" class="header-anchor">#</a> 11. 你做的监控 SDK 给业务带来了哪些实际价值？请举 1-2 个具体案例。</h3> <p><strong>回答模板</strong>：</p> <p>SDK 的核心价值是 “<strong>提前发现问题、快速定位问题、优化用户体验</strong>”，我们项目落地后，给业务带来了 3 个关键价值，举 2 个具体案例：</p> <h4 id="案例-1-线上-js-错误率从-3-降至-0-5-挽回百万级用户损失"><a href="#案例-1-线上-js-错误率从-3-降至-0-5-挽回百万级用户损失" class="header-anchor">#</a> 案例 1：线上 JS 错误率从 3% 降至 0.5%，挽回百万级用户损失</h4> <ul><li><p><strong>背景</strong>：某电商 APP 的 H5 页面（日活 50 万），用户反馈 “点击购物车后白屏”，但开发无法复现，问题持续 1 周，用户流失率上升 2%。</p></li> <li><p>SDK 的作用：</p> <ol><li>错误监控捕获到 “<code>cart.js:203 Uncaught TypeError: Cannot read property 'id' of undefined</code>”，且堆栈显示是 “用户删除最后一件商品后，<code>cartList[0].id</code>未判空”；</li> <li>关联行为数据发现：该错误只在 “iOS 11 浏览器 + 删除最后一件商品” 场景下触发（之前测试未覆盖该场景）；</li> <li>错误上报的用户分布显示：每天有 1.5 万用户触发该错误（错误率 3%），对应约 3000 用户流失（按 2% 流失率）。</li></ol></li> <li><p>业务效果：</p> <p>开发修复后，错误率降至 0.5% 以下，每天减少 3000 用户流失，按客单价 100 元计算，每月挽回约 90 万营收。</p></li></ul> <h4 id="案例-2-首屏加载时间从-6s-优化至-2-5s-转化率提升-15"><a href="#案例-2-首屏加载时间从-6s-优化至-2-5s-转化率提升-15" class="header-anchor">#</a> 案例 2：首屏加载时间从 6s 优化至 2.5s，转化率提升 15%</h4> <ul><li><p><strong>背景</strong>：某金融产品的注册页，用户反馈 “加载慢”，注册转化率只有 8%，低于行业平均的 12%。</p></li> <li><p>SDK 的作用：</p> <ol><li>性能监控显示：首屏 LCP（最大内容绘制）为 6s（远超谷歌推荐的 2.5s），主要瓶颈是 “首屏 banner 图（2.5MB）加载耗时 3s” 和 “注册接口响应耗时 1.8s”；</li> <li>资源监控发现：banner 图未做压缩（原图 2.5MB，压缩后可降至 300KB），且未开启 CDN 加速；</li> <li>接口监控显示：注册接口的 TTFB（首字节时间）1.2s，主要是数据库查询未加索引。</li></ol></li> <li><p>业务效果：</p> <p>优化后（图片压缩 + CDN + 接口加索引），首屏 LCP 降至 2.5s，注册转化率提升至 13.2%，每月新增注册用户约 5000 人，对应新增营收约 25 万元。</p></li></ul> <h3 id="_12-未来你会如何优化这个-sdk-有哪些规划"><a href="#_12-未来你会如何优化这个-sdk-有哪些规划" class="header-anchor">#</a> 12. 未来你会如何优化这个 SDK？有哪些规划？</h3> <p><strong>回答模板</strong>：</p> <p>基于当前 SDK 的落地效果，未来会从 “<strong>监控维度扩展</strong>”“<strong>智能化能力</strong>”“<strong>跨端适配</strong>” 三个方向优化，具体规划：</p> <ol><li><strong>监控维度扩展：覆盖更多前端场景</strong> <ul><li>新增 “用户体验监控”：如页面卡顿（监听<code>longtask</code>，超过 50ms 的任务判定为卡顿）、手势操作异常（如移动端双击、滑动无响应）；</li> <li>新增 “前端安全监控”：如 XSS 攻击（监控<code>document.write</code>、<code>eval</code>等危险 API 调用）、CSRF 攻击（监控异常的表单提交和接口请求）；</li> <li>新增 “资源性能监控”：如图片懒加载失效、CSS 阻塞渲染、JS 执行时间过长（帮助定位资源优化点）。</li></ul></li> <li><strong>智能化能力：从 “监控” 到 “诊断”</strong> <ul><li>错误智能分类：基于 AI 模型自动将错误分类（如 “语法错误”“接口错误”“框架错误”），并给出修复建议（如 “未定义变量，建议在使用前判空”）；</li> <li>性能根因分析：自动关联 “性能指标 - 资源加载 - 接口耗时”，定位性能瓶颈根因（如 “LCP 高是因为 banner 图未压缩，且 CDN 节点延迟高”）；</li> <li>异常预测：基于历史数据，预测可能出现的问题（如 “某接口近 1 小时响应时间从 500ms 升至 1.5s，可能即将超时，建议排查”）。</li></ul></li> <li><strong>跨端适配：覆盖全前端场景</strong> <ul><li>小程序监控：适配微信 / 支付宝 / 抖音小程序，监控 “小程序启动耗时”“页面切换耗时”“API 调用错误”；</li> <li>Electron / 桌面端监控：监控 “应用启动时间”“渲染进程崩溃”“主进程错误”；</li> <li>跨端统一上报：提供跨端 SDK（Web / 小程序 / Electron），统一上报格式和监控平台，方便业务方一站式查看全端数据。</li></ul></li> <li><strong>性能与体验优化</strong> <ul><li>更小体积：通过 “按需编译”（业务方只编译需要的模块）和 “代码混淆”，将 SDK 体积从当前的 15KB 降至 8KB 以下；</li> <li>更快加载：支持 “预加载”（<code>&lt;link rel=&quot;preload&quot; href=&quot;monitor-sdk.js&quot;&gt;</code>）和 “CDN 加速”，减少 SDK 加载时间；</li> <li>更友好的调试：提供 Chrome 插件，可视化查看 SDK 的监控数据（如错误日志、性能指标），无需登录监控平台。</li></ul></li></ol> <h2 id="五、面试回答技巧总结"><a href="#五、面试回答技巧总结" class="header-anchor">#</a> 五、面试回答技巧总结</h2> <ol><li><strong>结合项目细节</strong>：每个问题的回答都要加入 “我们项目中…”“我当时做的是…”，避免纯理论，体现实战经验；</li> <li><strong>逻辑清晰</strong>：用 “1. 2. 3.” 或 “背景 - 方案 - 效果” 的结构，让面试官快速抓住重点；</li> <li><strong>突出解决问题的能力</strong>：难点问题要说明 “痛点是什么→我怎么解决的→解决后效果如何”，而非只说 “我用了 XX 技术”；</li> <li><strong>展现思考高度</strong>：不仅说 “怎么做”，还要说 “为什么这么做”“有没有更好的方案”“未来如何优化”，体现主动性和深度。</li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/study-record/4.日常/20251101/项目/1. 监控.html" class="prev">
        1. 监控
      </a></span> <span class="next"><a href="/study-record/4.日常/20251101/项目/2. 微前端考察点.html">
        2. 微前端考察点
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/study-record/assets/js/app.17aac99d.js" defer></script><script src="/study-record/assets/js/2.016b014c.js" defer></script><script src="/study-record/assets/js/1.4d9187d3.js" defer></script><script src="/study-record/assets/js/85.2ea9262b.js" defer></script>
  </body>
</html>
