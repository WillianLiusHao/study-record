(window.webpackJsonp=window.webpackJsonp||[]).push([[26],{226:function(_,v,t){_.exports=t.p+"assets/img/performanceAPIV2.95ff3bfa.png"},227:function(_,v,t){_.exports=t.p+"assets/img/performance_data.fe8f2f01.png"},278:function(_,v,t){"use strict";t.r(v);var e=t(6),r=Object(e.a)({},(function(){var _=this,v=_._self._c;return v("ContentSlotsDistributor",{attrs:{"slot-key":_.$parent.slotKey}},[v("h1",{attrs:{id:"监控js-sdk"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#监控js-sdk"}},[_._v("#")]),_._v(" 监控js-sdk")]),_._v(" "),v("p",[_._v("核心指标："),v("code",[_._v("PV")]),_._v("、"),v("code",[_._v("JS错误")]),_._v("、"),v("code",[_._v("资源错误")]),_._v("、"),v("code",[_._v("网络请求错误")]),_._v("、"),v("code",[_._v("页面加载速度")])]),_._v(" "),v("h2",{attrs:{id:"一、采集数据"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#一、采集数据"}},[_._v("#")]),_._v(" 一、采集数据")]),_._v(" "),v("h3",{attrs:{id:"_1-错误数据"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_1-错误数据"}},[_._v("#")]),_._v(" 1. "),v("strong",[_._v("错误数据")])]),_._v(" "),v("p",[v("code",[_._v("页面地址")]),_._v("、"),v("code",[_._v("ip地址")]),_._v("、"),v("code",[_._v("发生时间")]),_._v("、"),v("code",[_._v("错误次数")]),_._v("、"),v("code",[_._v("设备信息(navigator.userAgent)")]),_._v("、"),v("code",[_._v("错误uid")]),_._v("，这些数据是每个错误类型都会上报的，"),v("strong",[_._v("其中每一类错误次数是后端根据错误uid统计")])]),_._v(" "),v("ul",[v("li",[_._v("JS 脚本执行错误\n"),v("ul",[v("li",[v("strong",[_._v("错误堆栈信息")])]),_._v(" "),v("li",[_._v("报错信息")]),_._v(" "),v("li",[_._v("错误类型")])])]),_._v(" "),v("li",[_._v("资源请求错误\n"),v("ul",[v("li",[_._v("资源地址")]),_._v(" "),v("li",[_._v("类型：img / link")])])]),_._v(" "),v("li",[_._v("接口请求错误\n"),v("ul",[v("li",[_._v("接口地址")])])])]),_._v(" "),v("h3",{attrs:{id:"_2-性能数据"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_2-性能数据"}},[_._v("#")]),_._v(" 2. "),v("strong",[_._v("性能数据")])]),_._v(" "),v("ul",[v("li",[_._v("加载类\n"),v("ul",[v("li",[_._v("白屏时间")]),_._v(" "),v("li",[_._v("首屏渲染时间")]),_._v(" "),v("li",[_._v("加载时间")]),_._v(" "),v("li",[_._v("DNS查询耗时")]),_._v(" "),v("li",[_._v("TCP连接耗时")]),_._v(" "),v("li",[_._v("TTFB请求响应耗时")])])]),_._v(" "),v("li",[_._v("网页卡顿\n"),v("ul",[v("li",[_._v("FPS")])])])]),_._v(" "),v("h3",{attrs:{id:"_3-用户行为数据"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_3-用户行为数据"}},[_._v("#")]),_._v(" 3. "),v("strong",[_._v("用户行为数据")])]),_._v(" "),v("ul",[v("li",[_._v("PV、UV、IP")]),_._v(" "),v("li",[_._v("均停留时长")]),_._v(" "),v("li",[_._v("链接来源")]),_._v(" "),v("li",[_._v("自定义的埋点事件")]),_._v(" "),v("li",[_._v("行为回溯")]),_._v(" "),v("li",[v("strong",[_._v("热力图")])])]),_._v(" "),v("p",[v("em",[_._v("- 注册量（结合了IC注册数据）")]),v("br"),_._v(" "),v("em",[_._v("- 转化率、跳出率（结合IC注册数据）")])]),_._v(" "),v("h2",{attrs:{id:"二、数据上报"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#二、数据上报"}},[_._v("#")]),_._v(" 二、数据上报")]),_._v(" "),v("h3",{attrs:{id:"_1-错误监控"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_1-错误监控"}},[_._v("#")]),_._v(" 1. 错误监控")]),_._v(" "),v("p",[_._v("上报方式："),v("code",[_._v("sendBeacon 直接上报")])]),_._v(" "),v("ul",[v("li",[v("p",[v("strong",[_._v("JS 执行错误")])]),_._v(" "),v("ul",[v("li",[_._v("通过 "),v("code",[_._v("window.onerror")]),_._v(" 捕捉")])]),_._v(" "),v("blockquote",[v("p",[_._v("tips： js错误在PC需要做兼容")]),_._v(" "),v("ul",[v("li",[_._v("不同浏览器内核的错误抛出方式不同")]),_._v(" "),v("li",[_._v("不同浏览器内核同个 API 返回的字段也可能不同")])])])]),_._v(" "),v("li",[v("p",[v("strong",[_._v("资源请求错误")])]),_._v(" "),v("p",[_._v("通过 "),v("code",[_._v("addEventListener('error', callback, true)")]),_._v(" 在捕获阶段捕捉资源加载失败错误。")])]),_._v(" "),v("li",[v("p",[v("strong",[_._v("接口请求错误")])]),_._v(" "),v("p",[_._v("改写浏览器内置的 "),v("code",[_._v("XMLHttpRequest")]),_._v(" 和 "),v("code",[_._v("fetch")])])])]),_._v(" "),v("h3",{attrs:{id:"_2-性能监控"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_2-性能监控"}},[_._v("#")]),_._v(" 2. 性能监控")]),_._v(" "),v("p",[_._v("客观数据直接上报："),v("code",[_._v("白屏")]),_._v(" "),v("code",[_._v("首屏")]),_._v(" "),v("code",[_._v("加载时间")]),_._v(" "),v("code",[_._v("DNS/TCP/TTFB")]),v("br"),_._v("\n需计算再上报："),v("code",[_._v("FPS")])]),_._v(" "),v("p",[_._v("主要用到的都是性能指标 "),v("code",[_._v("Performance API")]),_._v("，符合 W3C 标准")]),_._v(" "),v("p",[v("img",{attrs:{src:t(226),alt:""}})]),_._v(" "),v("ul",[v("li",[v("p",[v("strong",[_._v("白屏时间")])]),_._v(" "),v("ul",[v("li",[v("strong",[_._v("方案1：性能指标的 FP")])]),_._v(" "),v("li",[_._v("方案2："),v("code",[_._v("performance.timing.domLoading - performance.timing.navigationStart")])])])]),_._v(" "),v("li",[v("p",[v("strong",[_._v("首屏时间 <= 2.5s")])]),_._v(" "),v("ul",[v("li",[v("strong",[_._v("方案1：直接使用 LCP")])]),_._v(" "),v("li",[_._v("方案2：通过 MutationObserver 进行手动计算")])]),_._v(" "),v("p",[_._v("计算过程：")]),_._v(" "),v("ol",[v("li",[_._v("利用 MutationObserver 监听 document 对象，每当 DOM 元素属性发生变更时，触发事件。")]),_._v(" "),v("li",[_._v("判断该 DOM 元素是否在首屏内，如果在，则在 requestAnimationFrame() 回调函数中调用 performance.now() 获取当前时间，作为它的绘制时间。")]),_._v(" "),v("li",[_._v("将最后一个 DOM 元素的绘制时间和首屏中所有加载的图片时间作对比，将最大值作为首屏渲染时间。")])])]),_._v(" "),v("li",[v("p",[v("strong",[_._v("加载时间")])]),_._v(" "),v("ul",[v("li",[v("code",[_._v("timing.loadEventEnd - timing.navigationStart")])])])]),_._v(" "),v("li",[v("p",[v("strong",[_._v("DNS/TCP/TTFB")])]),_._v(" "),v("ul",[v("li",[_._v("DNS："),v("code",[_._v("domainLookupEnd - domainLookupStart")])]),_._v(" "),v("li",[_._v("TCP："),v("code",[_._v("connectEnd - connectStart")])]),_._v(" "),v("li",[_._v("TTFB："),v("code",[_._v("responseStart - requestStart")])])])]),_._v(" "),v("li",[v("p",[v("strong",[_._v("页面卡顿(FPS)")])]),_._v(" "),v("ul",[v("li",[_._v("利用 "),v("code",[_._v("requestAnimationFrame()")]),_._v(" 可以计算当前页面的 FPS。")])]),_._v(" "),v("p",[_._v("计算逻辑：开始前先记录一个初始时间，然后每次触发 requestAnimationFrame() 时，就将帧数加 1。过去一秒后用 "),v("code",[_._v("帧数/流逝的时间")]),_._v(" 就能得到当前帧率。")])])]),_._v(" "),v("p",[v("img",{attrs:{src:t(227),alt:""}})]),_._v(" "),v("ul",[v("li",[_._v("参考文章\n"),v("ul",[v("li",[v("a",{attrs:{href:"https://juejin.cn/post/7035647196510814221",target:"_blank",rel:"noopener noreferrer"}},[_._v("相关文章1"),v("OutboundLink")],1)]),_._v(" "),v("li",[v("a",{attrs:{href:"https://github.com/woai3c/Front-end-articles/blob/master/monitor.md",target:"_blank",rel:"noopener noreferrer"}},[_._v("前端性能和错误监控"),v("OutboundLink")],1)]),_._v(" "),v("li",[v("a",{attrs:{href:"https://github.com/woai3c/Front-end-articles/issues/26",target:"_blank",rel:"noopener noreferrer"}},[_._v("woai3c"),v("OutboundLink")],1)])])])]),_._v(" "),v("h3",{attrs:{id:"_3-行为监控"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_3-行为监控"}},[_._v("#")]),_._v(" 3. 行为监控")]),_._v(" "),v("p",[_._v("直接上报："),v("code",[_._v("PV/UV/IP")]),v("br"),_._v("\n阶段上报+关闭页面上报："),v("code",[_._v("用户交互事件")]),_._v("、"),v("code",[_._v("停留时长")])]),_._v(" "),v("ul",[v("li",[v("p",[v("strong",[_._v("PV/UV/IP")])]),_._v(" "),v("ul",[v("li",[_._v("pv：加载一次 sdk 算一次")]),_._v(" "),v("li",[_._v("uv：生成用户的 uuid，存在 "),v("code",[_._v("session")]),_._v("，每次加载判断 "),v("code",[_._v("session")]),_._v(" 有效性")]),_._v(" "),v("li",[_._v("ip 是"),v("code",[_._v("后端")]),_._v("通过用户 "),v("code",[_._v("ip")]),_._v(" 做唯一标识")])])]),_._v(" "),v("li",[v("p",[v("strong",[_._v("停留时长")]),_._v("：页面"),v("code",[_._v("load")]),_._v("时记录时间A，"),v("strong",[_._v("onBeforeunload")]),_._v(" 记录时间B，停留时长 = B - A")])]),_._v(" "),v("li",[v("p",[v("strong",[_._v("链接来源")]),_._v("："),v("code",[_._v("document.referrer")])])]),_._v(" "),v("li",[v("p",[v("strong",[_._v("事件上报（重点）")])]),_._v(" "),v("ul",[v("li",[v("strong",[_._v("自定义的埋点事件")]),_._v("：并非用户的所有事件都会进行收集上报，以下场景才会捕获并上报事件。\n"),v("ul",[v("li",[v("code",[_._v("埋了点的位置")]),_._v("：通过归类一套 "),v("strong",[_._v("按组件归类")]),_._v("的树状事件代码，进行埋点")]),_._v(" "),v("li",[v("code",[_._v("手动触发了上报事件")]),_._v("：组件的特定生命周期/事件回调中，会固定执行上报")])])]),_._v(" "),v("li",[_._v("点击事件：通过 "),v("code",[_._v("data-la")]),_._v("  属性标记元素，上报时候只有绑了改值才会上报")])])]),_._v(" "),v("li",[v("p",[v("strong",[_._v("热力图")]),_._v("\n服务端通过点击事件统计生成热区")])]),_._v(" "),v("li",[v("p",[v("strong",[_._v("行为回溯")]),_._v(" "),v("code",[_._v("rrweb")]),_._v(" 记性录屏，数据通过 websocket 上报，缺点是数据量太大了")])])]),_._v(" "),v("h2",{attrs:{id:"三、项目总结"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#三、项目总结"}},[_._v("#")]),_._v(" 三、项目总结")]),_._v(" "),v("p",[_._v("对标产品：友盟，百度统计")]),_._v(" "),v("h3",{attrs:{id:"背景"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#背景"}},[_._v("#")]),_._v(" 背景")]),_._v(" "),v("ul",[v("li",[v("p",[v("code",[_._v("错误监控")]),_._v("：之前的营销页面，线上出错无法及时知道，更多时候是人为的方式站岗放哨，导致生产报错，白白花了投放经费")])]),_._v(" "),v("li",[v("p",[v("code",[_._v("性能监控")]),_._v("：对页面的性能好坏没有定量评价，都是人为测试凭感觉定性")])]),_._v(" "),v("li",[v("p",[v("code",[_._v("埋点/行为回溯/录屏 rrweb")]),_._v("：对用户的具体行为无感知，不知道具体用户操作行为，浏览习惯，爱好，页面素材效果等")])])]),_._v(" "),v("p",[v("strong",[_._v("功能")])]),_._v(" "),v("ul",[v("li",[v("p",[v("strong",[_._v("邮件通知项目经理页面生产出错：页面js错误单位时间达到一定量，且一段时间无新的注册数据")])])]),_._v(" "),v("li",[v("p",[v("strong",[_._v("行为回溯 / 录屏")])])]),_._v(" "),v("li",[v("p",[v("strong",[_._v("大屏看板")])]),_._v(" "),v("ul",[v("li",[v("code",[_._v("访客 / 注册 / 健康状况 排行榜")])]),_._v(" "),v("li",[_._v("用户城市分布")]),_._v(" "),v("li",[_._v("公司营销数据概览，PV/UV/IP 的 今昨日对比")])])])]),_._v(" "),v("h3",{attrs:{id:"难点-亮点"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#难点-亮点"}},[_._v("#")]),_._v(" 难点，亮点")]),_._v(" "),v("h4",{attrs:{id:"_1-各个浏览器js错误捕获的兼容"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_1-各个浏览器js错误捕获的兼容"}},[_._v("#")]),_._v(" 1. 各个浏览器JS错误捕获的兼容")]),_._v(" "),v("p",[_._v("各个内核浏览器的错误堆栈返回信息不一样，需做兼容和大量的测试")]),_._v(" "),v("h4",{attrs:{id:"_2-数据的上报策略-上报方式、上报时机"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_2-数据的上报策略-上报方式、上报时机"}},[_._v("#")]),_._v(" 2. 数据的上报策略（上报方式、上报时机）")]),_._v(" "),v("ul",[v("li",[v("p",[_._v("上报方式：sendBeacon（首选）/ XMLHTTPRequest（次选） 降级上报")]),_._v(" "),v("ol",[v("li",[v("strong",[_._v("sendBeacon（首选，异步、保证数据的可靠，不影响页面性能）")])]),_._v(" "),v("li",[_._v("XMLHttpRequest")]),_._v(" "),v("li",[v("s",[_._v("img")])])])]),_._v(" "),v("li",[v("p",[_._v("上报时机")]),_._v(" "),v("ol",[v("li",[_._v("采用 "),v("code",[_._v("requestIdleCallback（首选）/ setTimeout（次选）")]),_._v(" 延时上报（requestIdleCallback 会在浏览器空闲时调用）")]),_._v(" "),v("li",[_._v("在页面关闭前 "),v("code",[_._v("beforeunload")]),_._v(" 回调函数里上报\n"),v("s",[_._v("3. "),v("code",[_._v("缓存上报")]),_._v("数据，达到一定数量后再上报")])])]),_._v(" "),v("p",[v("code",[_._v("requestAnimationFrame")]),_._v(" 的回调函数会在绘制之前执行，"),v("code",[_._v("requestIdleCallback")]),_._v("的在绘制之后执行")]),_._v(" "),v("p",[_._v("如果某一帧渲染时间不到16ms(以60fps算)，那此时这一帧有一定的空闲时间，这段空闲事件就可以执行 "),v("code",[_._v("requestIdleCallback")])])])]),_._v(" "),v("h4",{attrs:{id:"_3-错误信息唯一id的作用"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_3-错误信息唯一id的作用"}},[_._v("#")]),_._v(" 3. 错误信息唯一ID的作用")]),_._v(" "),v("ul",[v("li",[v("p",[_._v("错误上报数据去重")]),_._v(" "),v("ol",[v("li",[_._v("客户端基于错误的"),v("strong",[_._v("堆栈信息")]),_._v("，生成错误的唯一ID，上报时去重")])])]),_._v(" "),v("li",[v("p",[_._v("错误数据聚合")]),_._v(" "),v("ol",[v("li",[_._v("服务端汇总整理数据的时候，通过错误唯一ID进行聚合统计")])])])]),_._v(" "),v("h4",{attrs:{id:"_4-sdk的打包封装、sdk加载方式、作用域隔离"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_4-sdk的打包封装、sdk加载方式、作用域隔离"}},[_._v("#")]),_._v(" 4. sdk的打包封装、sdk加载方式、作用域隔离")]),_._v(" "),v("p",[v("strong",[_._v("打包/加载方式")])]),_._v(" "),v("ul",[v("li",[v("p",[_._v("异步 / 同步？")])]),_._v(" "),v("li",[v("p",[_._v("cmd / cjs？")])])]),_._v(" "),v("p",[v("strong",[_._v("作用域隔离：")])]),_._v(" "),v("p",[v("code",[_._v("try catch")]),_._v("：防止 sdk 的报错反而影响了页面的运行")]),_._v(" "),v("h4",{attrs:{id:"_5-客户端和服务端的时间校对"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_5-客户端和服务端的时间校对"}},[_._v("#")]),_._v(" 5. 客户端和服务端的时间校对")]),_._v(" "),v("p",[_._v("在请求sdk的时候，通过返回的响应头的 "),v("code",[_._v("date")]),_._v(" 字段，确定客户端和服务器端的时间差")]),_._v(" "),v("hr"),_._v(" "),v("p",[_._v("参考："),v("a",{attrs:{href:"https://juejin.cn/post/7108660942686126093",target:"_blank",rel:"noopener noreferrer"}},[_._v("说说前端监控平台/监控SDK的架构设计和难点亮点？"),v("OutboundLink")],1)]),_._v(" "),v("h3",{attrs:{id:"相关问题"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#相关问题"}},[_._v("#")]),_._v(" 相关问题")]),_._v(" "),v("p",[v("strong",[_._v("必要性（为什么要自研）")])]),_._v(" "),v("ul",[v("li",[_._v("方便接入公司团队的告警业务")]),_._v(" "),v("li",[_._v("数据定制化，市面上有些无法满足")]),_._v(" "),v("li",[_._v("方便业务拓展，自定义的埋点（结合营销平台组件），热力图等")]),_._v(" "),v("li",[_._v("方便做数据的联动分析，如错误可以联动用户行为回溯")])]),_._v(" "),v("p",[v("strong",[_._v("优化")])]),_._v(" "),v("ol",[v("li",[_._v("如何把 sdk 做成跨平台可用的")])]),_._v(" "),v("p",[_._v("思考方向："),v("code",[_._v("分平台打包")])]),_._v(" "),v("ol",{attrs:{start:"2"}},[v("li",[_._v("如何把 sdk 做的更加通用化，并且在业务需要的时候可以快速拓展和定制")])]),_._v(" "),v("p",[_._v("思考方向："),v("code",[_._v("插件化")])]),_._v(" "),v("hr"),_._v(" "),v("p",[_._v("参考资料：")]),_._v(" "),v("ul",[v("li",[v("a",{attrs:{href:"https://juejin.cn/column/7097156230489047047",target:"_blank",rel:"noopener noreferrer"}},[_._v("一文摸清前端监控实践要点"),v("OutboundLink")],1)])])])}),[],!1,null,null,null);v.default=r.exports}}]);