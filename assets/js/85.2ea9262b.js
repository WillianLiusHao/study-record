(window.webpackJsonp=window.webpackJsonp||[]).push([[85],{310:function(t,s,a){"use strict";a.r(s);var n=a(6),r=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"一、前端监控-sdk-面试考点、难点与亮点梳理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#一、前端监控-sdk-面试考点、难点与亮点梳理"}},[t._v("#")]),t._v(" 一、前端监控 SDK 面试考点、难点与亮点梳理")]),t._v(" "),s("p",[t._v("在面试中，前端监控 SDK 相关问题会围绕 "),s("strong",[t._v("技术实现原理、工程化能力、问题解决思路、性能优化")]),t._v(" 四个核心维度展开。以下从考点、难点、亮点三部分系统梳理，帮你精准应对面试。")]),t._v(" "),s("h2",{attrs:{id:"一、核心考点-基础与原理-必须掌握"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#一、核心考点-基础与原理-必须掌握"}},[t._v("#")]),t._v(" 一、核心考点：基础与原理（必须掌握）")]),t._v(" "),s("p",[t._v("这部分是面试高频提问区，重点考察你对监控 SDK“是什么、能做什么、怎么实现” 的基础认知，需结合项目细节展开。")]),t._v(" "),s("h3",{attrs:{id:"_1-监控-sdk-的核心功能模块"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-监控-sdk-的核心功能模块"}},[t._v("#")]),t._v(" 1. 监控 SDK 的核心功能模块")]),t._v(" "),s("p",[t._v("面试官会先确认你对监控范围的理解，需清晰拆解核心模块，避免遗漏关键场景：")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("错误监控：覆盖前端所有错误类型，需说明 “监控什么、怎么监控、如何上报”。")]),t._v(" "),s("ul",[s("li",[t._v("语法错误 / 运行时错误：通过"),s("code",[t._v("window.onerror")]),t._v("捕获（注意跨域脚本错误需配置"),s("code",[t._v("crossorigin")]),t._v("和"),s("code",[t._v("source-map")]),t._v("）。")]),t._v(" "),s("li",[t._v("资源加载错误：通过"),s("code",[t._v("window.addEventListener('error', (e) => { if(e.target instanceof HTMLElement) { ... } })")]),t._v("捕获（区分 JS 错误和资源错误）。")]),t._v(" "),s("li",[t._v("Promise 错误：通过"),s("code",[t._v("window.addEventListener('unhandledrejection', (e) => { ... })")]),t._v("捕获（避免错误静默失败）。")]),t._v(" "),s("li",[t._v("React/Vue 框架错误：React 用"),s("code",[t._v("componentDidCatch")]),t._v("（类组件）或"),s("code",[t._v("ErrorBoundary")]),t._v("（函数组件），Vue 用"),s("code",[t._v("app.config.errorHandler")]),t._v("。")])])]),t._v(" "),s("li",[s("strong",[t._v("性能监控：基于 Web Performance API，需明确 “监控哪些指标、指标含义、计算方式”。")]),t._v(" "),s("ul",[s("li",[t._v("核心 Web 指标（Core Web Vitals）：LCP（最大内容绘制，衡量加载速度）、FID（首次输入延迟，衡量交互响应）、CLS（累积布局偏移，衡量视觉稳定性）。")]),t._v(" "),s("li",[t._v("传统性能指标：FP（首次绘制）、FCP（首次内容绘制）、TTI（首次可交互时间）、TTFB（首字节时间，需结合服务端分析）。")]),t._v(" "),s("li",[t._v("自定义性能：接口请求耗时（拦截"),s("code",[t._v("XMLHttpRequest")]),t._v("/"),s("code",[t._v("fetch")]),t._v("）、页面跳转耗时、组件渲染耗时。")])])]),t._v(" "),s("li",[s("strong",[t._v("行为监控：记录用户操作，用于分析用户路径和问题复现，需说明 “监控场景、数据脱敏”。")]),t._v(" "),s("ul",[s("li",[t._v("页面埋点：PV/UV（基于"),s("code",[t._v("visibilitychange")]),t._v("判断页面可见性，避免重复统计）、页面停留时间（记录"),s("code",[t._v("pagehide")]),t._v("与"),s("code",[t._v("pageshow")]),t._v("时间差）。")]),t._v(" "),s("li",[t._v("用户操作：点击事件（代理到"),s("code",[t._v("document")]),t._v("，过滤非用户触发的点击）、输入行为、路由跳转（监听"),s("code",[t._v("hashchange")]),t._v("/"),s("code",[t._v("popstate")]),t._v("或框架路由钩子）。")])])]),t._v(" "),s("li",[s("strong",[t._v("异常上报：确保数据 “能上报、不丢包、不影响主流程”，需说明上报策略。")]),t._v(" "),s("ul",[s("li",[t._v("上报方式：异步"),s("code",[t._v("img")]),t._v("标签（兼容性最好，无跨域问题）、"),s("code",[t._v("fetch")]),t._v("（支持更多配置，需处理跨域）。")]),t._v(" "),s("li",[t._v("数据格式：包含"),s("code",[t._v("错误类型、错误信息、堆栈、时间戳、设备信息（UA）、页面URL、环境变量（生产/测试）")]),t._v("等核心字段。")])])])]),t._v(" "),s("h3",{attrs:{id:"_2-关键技术原理-高频提问"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-关键技术原理-高频提问"}},[t._v("#")]),t._v(" 2. 关键技术原理（高频提问）")]),t._v(" "),s("p",[t._v("需结合项目中实际使用的方案，解释 “为什么这么做”，而非单纯背概念：")]),t._v(" "),s("ul",[s("li",[s("p",[s("strong",[t._v("错误堆栈解析：")])]),t._v(" "),s("ul",[s("li",[t._v("原生错误堆栈包含文件路径、行号，但压缩后的代码需结合"),s("code",[t._v("source-map")]),t._v("还原真实代码位置（项目中是否实现了"),s("code",[t._v("source-map")]),t._v("解析？是前端解析还是后端解析？）。")]),t._v(" "),s("li",[t._v("跨域脚本错误（"),s("code",[t._v("Script error")]),t._v("）的解决：1. 脚本标签添加"),s("code",[t._v('crossorigin="anonymous"')]),t._v("；2. 服务端响应头添加"),s("code",[t._v("Access-Control-Allow-Origin")]),t._v("。")])])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("性能指标计算：")])]),t._v(" "),s("ul",[s("li",[s("p",[t._v("基于"),s("code",[t._v("performance.timing")]),t._v("（旧标准）或"),s("code",[t._v("performance.getEntriesByType('navigation')")]),t._v("（新标准，Navigation Timing API v2）计算 FP/FCP/TTI。")])]),t._v(" "),s("li",[s("p",[t._v("LCP 监控：通过")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("PerformanceObserver")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("entryList")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("observe")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'largest-contentful-paint'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("buffered")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[t._v("实时监听最大内容元素。")])])])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("请求拦截：")])]),t._v(" "),s("ul",[s("li",[t._v("拦截"),s("code",[t._v("XMLHttpRequest")]),t._v("：重写"),s("code",[t._v("XMLHttpRequest.prototype.open")]),t._v("和"),s("code",[t._v("XMLHttpRequest.prototype.send")]),t._v("，记录请求开始 / 结束时间，计算耗时。")]),t._v(" "),s("li",[t._v("拦截"),s("code",[t._v("fetch")]),t._v("：重写"),s("code",[t._v("window.fetch")]),t._v("，包装"),s("code",[t._v("Promise")]),t._v("，在"),s("code",[t._v("then/catch")]),t._v("中记录请求结果和耗时。")])])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("数据防抖 / 节流：")])]),t._v(" "),s("ul",[s("li",[t._v("高频事件（如滚动、resize）监控需节流（如 100ms 一次），避免生成大量冗余数据；")]),t._v(" "),s("li",[t._v("上报队列需防抖（如 500ms 批量上报一次），减少 HTTP 请求次数，降低性能消耗。")])])])]),t._v(" "),s("h3",{attrs:{id:"_3-工程化与兼容性"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-工程化与兼容性"}},[t._v("#")]),t._v(" 3. 工程化与兼容性")]),t._v(" "),s("p",[t._v("考察你对 “SDK 产品化” 的思考，而非单纯的技术实现：")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("兼容性处理：")]),t._v(" "),s("ul",[s("li",[t._v("低版本浏览器（如 IE11）不支持"),s("code",[t._v("PerformanceObserver")]),t._v("/"),s("code",[t._v("fetch")]),t._v("，如何降级？（如用"),s("code",[t._v("performance.timing")]),t._v("替代、用"),s("code",[t._v("XMLHttpRequest")]),t._v("模拟"),s("code",[t._v("fetch")]),t._v("）。")]),t._v(" "),s("li",[t._v("不同框架（React/Vue/Angular）的错误监控适配方案（项目中是否做了多框架兼容？）。")])])]),t._v(" "),s("li",[s("strong",[t._v("SDK 体积与加载：")]),t._v(" "),s("ul",[s("li",[t._v("SDK 体积优化：Tree-shaking（排除未使用的模块）、代码压缩（Terser）、按需加载（如行为监控模块可配置关闭）。")]),t._v(" "),s("li",[t._v("加载方式：异步加载（避免阻塞主流程）、动态插入脚本（如"),s("code",[t._v("document.createElement('script')")]),t._v("），是否考虑 “首屏加载时不加载 SDK，避免影响首屏性能”？")])])]),t._v(" "),s("li",[s("strong",[t._v("配置化设计：")]),t._v(" "),s("ul",[s("li",[t._v("SDK 是否支持自定义配置？（如"),s("code",[t._v("{ enableError: true, enablePerformance: false, reportUrl: 'xxx' }")]),t._v("），方便业务方按需开启模块。")]),t._v(" "),s("li",[t._v("是否支持钩子函数？（如"),s("code",[t._v("beforeReport: (data) => { ... }")]),t._v("，允许业务方自定义过滤 / 修改上报数据）。")])])])]),t._v(" "),s("h2",{attrs:{id:"二、项目难点-体现问题解决能力"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#二、项目难点-体现问题解决能力"}},[t._v("#")]),t._v(" 二、项目难点：体现问题解决能力")]),t._v(" "),s("p",[t._v("面试官会重点关注 “你在项目中遇到了什么问题、怎么解决的”，需结合具体场景，说明 “痛点 - 方案 - 效果”，避免泛泛而谈。")]),t._v(" "),s("h3",{attrs:{id:"_1-数据准确性问题-最常见难点"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-数据准确性问题-最常见难点"}},[t._v("#")]),t._v(" 1. 数据准确性问题（最常见难点）")]),t._v(" "),s("ul",[s("li",[s("p",[s("strong",[t._v("痛点 1：错误重复上报")])]),t._v(" "),s("p",[t._v("同一错误（如循环中的错误）可能触发多次 "),s("code",[t._v("onerror")]),t._v(" 导致重复上报，污染数据。")]),t._v(" "),s("p",[t._v("解决方案：用 “错误唯一标识” 去重（如 "),s("code",[t._v("错误信息+堆栈+URL")]),t._v(" 哈希值），记录已上报的错误 ID，30 分钟内同一 ID 不再上报。")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("痛点 2：性能指标计算偏差")])]),t._v(" "),s("p",[t._v("如 LCP 在 “图片懒加载” 场景下，真实 LCP 元素加载延迟，导致监控到的 LCP 值偏小。")]),t._v(" "),s("p",[t._v("解决方案：延长 LCP 监听时间（如页面加载后 5s 内仍监听），或结合 "),s("code",[t._v("load")]),t._v(" 事件后再修正 LCP 值；排除非关键元素（如隐藏的图片）。")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("痛点 3：跨域脚本错误无法获取堆栈")])]),t._v(" "),s("p",[t._v("即使配置了 "),s("code",[t._v("crossorigin")]),t._v("，部分 CDN 脚本仍可能因响应头问题导致错误堆栈为空。")]),t._v(" "),s("p",[t._v("解决方案：前端通过 “错误边界”（如 React ErrorBoundary）在框架层捕获错误，补充上下文信息（如组件名、props），提升错误可复现性。")])])]),t._v(" "),s("h3",{attrs:{id:"_2-性能影响问题-sdk-的-自我修养"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-性能影响问题-sdk-的-自我修养"}},[t._v("#")]),t._v(" 2. 性能影响问题（SDK 的 “自我修养”）")]),t._v(" "),s("ul",[s("li",[s("p",[s("strong",[t._v("痛点 1：SDK 自身消耗主进程资源")])]),t._v(" "),s("p",[t._v("高频监控（如行为监控、滚动监控）可能导致主线程阻塞，影响页面性能。")]),t._v(" "),s("p",[t._v("解决方案：")]),t._v(" "),s("ol",[s("li",[t._v("监控逻辑用 "),s("code",[t._v("requestIdleCallback")]),t._v("（空闲时执行）")]),t._v(" "),s("li",[t._v("复杂计算（如堆栈解析）移交 Web Worker，避免阻塞主线程")]),t._v(" "),s("li",[t._v("可配置 “采样率”（如 10% 用户开启详细监控），降低整体消耗。")])])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("痛点 2：上报请求占用网络带宽")])]),t._v(" "),s("p",[t._v("大量上报数据（如行为日志）可能挤占业务接口带宽，导致业务请求延迟。")]),t._v(" "),s("p",[t._v("解决方案：")]),t._v(" "),s("ol",[s("li",[t._v("批量上报（如 10 条数据合并一次上报）")]),t._v(" "),s("li",[t._v("压缩上报数据（如用 gzip，或自定义二进制格式）")]),t._v(" "),s("li",[t._v("非关键数据（如行为日志）在弱网环境下延迟上报（监听 "),s("code",[t._v("navigator.connection.effectiveType")]),t._v(" 判断网络类型）。")])])])]),t._v(" "),s("h3",{attrs:{id:"_3-复杂场景适配"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-复杂场景适配"}},[t._v("#")]),t._v(" 3. 复杂场景适配")]),t._v(" "),s("ul",[s("li",[s("p",[s("strong",[t._v("痛点 1：单页应用（SPA）路由切换监控")])]),t._v(" "),s("p",[t._v("SPA 路由切换不会触发 "),s("code",[t._v("pageshow")]),t._v(" ，导致传统的 PV 统计、性能监控失效。")]),t._v(" "),s("p",[t._v("解决方案：")]),t._v(" "),s("ol",[s("li",[t._v("监听框架路由钩子（如 React Router 的 "),s("code",[t._v("useEffect")]),t._v("、Vue Router 的 "),s("code",[t._v("afterEach")]),t._v("），在路由切换时重新初始化监控（如重新计算 FCP、重置错误计数器）")]),t._v(" "),s("li",[t._v("用 "),s("code",[t._v("performance.getEntriesByType('navigation')")]),t._v(" 的 "),s("code",[t._v("type")]),t._v(" 字段（"),s("code",[t._v("reload")]),t._v("/"),s("code",[t._v("navigate")]),t._v("/"),s("code",[t._v("back_forward")]),t._v("）区分路由类型。")])])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("痛点 2：iframe 嵌套页面监控")])]),t._v(" "),s("p",[t._v("父页面无法直接捕获 iframe 内的错误和性能数据，导致监控盲区。")]),t._v(" "),s("p",[t._v("解决方案：")]),t._v(" "),s("ol",[s("li",[t._v("iframe 内注入 SDK，通过"),s("code",[t._v("postMessage")]),t._v("将数据传递给父页面，由父页面统一上报")]),t._v(" "),s("li",[t._v("父页面监听"),s("code",[t._v("iframe")]),t._v("的"),s("code",[t._v("load")]),t._v("事件，补充 iframe 的加载性能数据。")])])])]),t._v(" "),s("h2",{attrs:{id:"三、项目亮点-突出差异化优势"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#三、项目亮点-突出差异化优势"}},[t._v("#")]),t._v(" 三、项目亮点：突出差异化优势")]),t._v(" "),s("p",[t._v("亮点是面试中的 “加分项”，需体现你对监控 SDK 的 “深度思考” 或 “创新实践”，避免停留在 “完成基础功能” 层面。")]),t._v(" "),s("h3",{attrs:{id:"_1-技术层面-超越基础功能的优化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-技术层面-超越基础功能的优化"}},[t._v("#")]),t._v(" 1. 技术层面：超越基础功能的优化")]),t._v(" "),s("ul",[s("li",[s("p",[s("strong",[t._v("错误溯源与智能分析：")])]),t._v(" "),s("p",[t._v("不只是上报错误堆栈，还能关联 “用户操作路径”（如错误发生前用户点击了哪个按钮、输入了什么内容）和 “环境信息”（如浏览器版本、设备型号、网络类型），帮助开发快速复现问题。例如：项目中实现了 “错误 - 操作日志” 关联，点击错误 ID 可查看前 10 步用户操作，复现率提升 60%。")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("性能瓶颈定位：")])]),t._v(" "),s("p",[t._v("不只是上报性能指标，还能分析 “性能差的原因”。例如：结合"),s("code",[t._v("performance.getEntriesByType('resource')")]),t._v("分析资源加载耗时，识别出 “某张图片加载耗时 2s”，或 “某接口响应耗时 1.5s”，直接定位瓶颈点；甚至实现 “性能指标告警”（如 LCP>4s 时触发钉钉告警）。")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("动态配置与灰度发布：")])]),t._v(" "),s("p",[t._v("实现 “远程配置中心”（如基于 Redis/MySQL），支持动态开启 / 关闭监控模块、调整采样率、更新上报地址，无需重新发布 SDK。例如：线上发现某模块有 bug，可通过配置中心实时关闭该模块，避免影响所有用户；新功能上线时先灰度 10% 用户，验证无问题后全量。")])])]),t._v(" "),s("h3",{attrs:{id:"_2-工程化层面-体现产品化思维"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-工程化层面-体现产品化思维"}},[t._v("#")]),t._v(" 2. 工程化层面：体现产品化思维")]),t._v(" "),s("ul",[s("li",[s("p",[s("strong",[t._v("SDK 可扩展架构")]),t._v("：")]),t._v(" "),s("p",[t._v("采用 “插件化设计”，将错误监控、性能监控、行为监控拆分为独立插件，业务方可按需引入（如"),s("code",[t._v("import { ErrorPlugin, PerformancePlugin } from 'monitor-sdk'")]),t._v("），同时支持自定义插件（如业务方自己开发 “小程序监控插件”），提升 SDK 的灵活性。")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("数据可视化与平台联动：")])]),t._v(" "),s("p",[t._v("不只做 “数据上报”，还参与 “监控平台” 的部分设计，例如：上报的数据在平台上支持 “错误趋势图”“性能分位数统计”“用户分布热力图”，甚至支持 “错误一键跳转至源码（如 GitHub）”“性能问题关联 Jira 工单”，打通 “监控 - 排查 - 修复” 链路。")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("隐私合规处理：")])]),t._v(" "),s("p",[t._v("符合 GDPR / 国内《个人信息保护法》，实现 “数据脱敏” 和 “用户授权”。例如：")]),t._v(" "),s("ol",[s("li",[t._v("上报的用户输入内容（如表单）自动脱敏（替换手机号 / 邮箱为"),s("code",[t._v("*")]),t._v("）")]),t._v(" "),s("li",[t._v("提供"),s("code",[t._v("init({ enablePrivacy: true })")]),t._v("配置，用户拒绝授权时不采集行为数据，避免合规风险。")])])])]),t._v(" "),s("h3",{attrs:{id:"_3-业务价值层面-体现落地效果"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-业务价值层面-体现落地效果"}},[t._v("#")]),t._v(" 3. 业务价值层面：体现落地效果")]),t._v(" "),s("p",[t._v("亮点最终要回归 “业务价值”，用数据证明 SDK 的作用，例如：")]),t._v(" "),s("ul",[s("li",[t._v("**错误排查效率：**SDK 上线后，前端错误平均排查时间从 2 小时缩短至 15 分钟，线上错误率下降 40%。")]),t._v(" "),s("li",[t._v("**性能优化效果：**通过监控发现 LCP 瓶颈（某首屏图片未压缩），优化后 LCP 从 5s 降至 2.5s，首屏加载时间缩短 30%。")]),t._v(" "),s("li",[t._v("**业务问题定位：**通过行为监控发现 “某支付按钮点击后无响应”，定位到是 IE 浏览器下的兼容性问题，修复后支付转化率提升 5%。")])]),t._v(" "),s("h2",{attrs:{id:"四、面试准备建议"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#四、面试准备建议"}},[t._v("#")]),t._v(" 四、面试准备建议")]),t._v(" "),s("ol",[s("li",[s("strong",[t._v("梳理项目细节")]),t._v("：明确你在 SDK 项目中负责的模块（如错误监控 / 性能上报），准备 1-2 个 “难点解决案例”（按 “痛点 - 方案 - 效果” 结构表述）。")]),t._v(" "),s("li",[s("strong",[t._v("模拟问题回答")]),t._v("：针对高频考点（如错误捕获方式、SPA 监控、source-map 解析），提前组织语言，结合项目实际代码片段（如 “我们当时是这么重写 XMLHttpRequest 的：xxx”）。")]),t._v(" "),s("li",[s("strong",[t._v("体现主动性")]),t._v("：主动提及 “你做的优化” 或 “未来可改进的方向”（如 “目前 SDK 在 Web Worker 内的错误监控还未覆盖，后续计划调研 Worker 错误捕获方案”），展现思考深度。")])]),t._v(" "),s("h1",{attrs:{id:"二、前端监控-sdk-高频面试题与回答模板"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#二、前端监控-sdk-高频面试题与回答模板"}},[t._v("#")]),t._v(" 二、前端监控 SDK 高频面试题与回答模板")]),t._v(" "),s("p",[t._v("以下梳理"),s("strong",[t._v("15 道高频面试题")]),t._v("，涵盖基础原理、难点解决、工程化、业务价值四大维度，每个问题配套 “回答模板”（含核心逻辑 + 项目结合点 + 加分项），帮你精准匹配面试场景，避免泛泛而谈。")]),t._v(" "),s("h2",{attrs:{id:"一、基础原理类-必问-考察核心认知"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#一、基础原理类-必问-考察核心认知"}},[t._v("#")]),t._v(" 一、基础原理类（必问，考察核心认知）")]),t._v(" "),s("h3",{attrs:{id:"_1-前端监控-sdk-主要监控哪些内容-请分别说明实现思路。☆☆☆☆☆"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-前端监控-sdk-主要监控哪些内容-请分别说明实现思路。☆☆☆☆☆"}},[t._v("#")]),t._v(" 1. 前端监控 SDK 主要监控哪些内容？请分别说明实现思路。☆☆☆☆☆")]),t._v(" "),s("p",[s("strong",[t._v("回答模板")]),t._v("：")]),t._v(" "),s("p",[t._v("前端监控 SDK 核心覆盖 4 类内容，我们项目中也是围绕这几块落地的：")]),t._v(" "),s("ol",[s("li",[s("strong",[t._v("错误监控")]),t._v("：监控 JS 运行时错误、资源加载错误、Promise 错误、框架错误\n"),s("ul",[s("li",[t._v("运行时 / 语法错误：用"),s("code",[t._v("window.onerror")]),t._v("捕获，注意过滤"),s("code",[t._v("script error")]),t._v("（需配置"),s("code",[t._v("crossorigin")]),t._v("和服务端 CORS 头）；")]),t._v(" "),s("li",[t._v("资源错误：用"),s("code",[t._v("window.addEventListener('error', e => { if(e.target instanceof HTMLImageElement/HTMLLinkElement) { ... } })")]),t._v("，区分资源类型（图 / 样式 / 脚本）；")]),t._v(" "),s("li",[t._v("Promise 错误：用"),s("code",[t._v("window.addEventListener('unhandledrejection', e => { ... })")]),t._v("，避免静默失败；")]),t._v(" "),s("li",[t._v("框架错误：React 用"),s("code",[t._v("ErrorBoundary")]),t._v("、Vue 用"),s("code",[t._v("app.config.errorHandler")]),t._v("，我们项目还适配了 Vue2/Vue3 双版本。")])])]),t._v(" "),s("li",[s("strong",[t._v("性能监控")]),t._v("：重点监控 Core Web Vitals 和传统指标\n"),s("ul",[s("li",[t._v("核心指标：LCP 用"),s("code",[t._v("PerformanceObserver")]),t._v("监听"),s("code",[t._v("largest-contentful-paint")]),t._v("类型，FID/CLS 同理；")]),t._v(" "),s("li",[t._v("传统指标：FP/FCP/TTI 通过"),s("code",[t._v("performance.getEntriesByType('navigation')")]),t._v("（新标准）计算，旧浏览器降级用"),s("code",[t._v("performance.timing")]),t._v("；")]),t._v(" "),s("li",[t._v("自定义性能：拦截"),s("code",[t._v("XHR/fetch")]),t._v("记录接口耗时，我们项目还加了 “组件渲染耗时”（React 用"),s("code",[t._v("useEffect")]),t._v("记录挂载时间）。")])])]),t._v(" "),s("li",[s("strong",[t._v("行为监控")]),t._v("：用于问题复现，需做数据脱敏\n"),s("ul",[s("li",[t._v("PV/UV：用"),s("code",[t._v("visibilitychange")]),t._v("判断页面可见性，避免重复统计；停留时间记录"),s("code",[t._v("pageshow")]),t._v("和"),s("code",[t._v("pagehide")]),t._v("的时间差；")]),t._v(" "),s("li",[t._v("用户操作："),s("code",[t._v("document")]),t._v("代理点击事件，过滤非用户触发（如"),s("code",[t._v("dispatchEvent")]),t._v("），输入内容只记录长度不记录原文（合规要求）。")])])]),t._v(" "),s("li",[s("strong",[t._v("异常上报")]),t._v("：确保不丢包、不影响主流程\n"),s("ul",[s("li",[t._v("上报方式：优先用"),s("code",[t._v("img")]),t._v("标签（兼容性好），大体积数据用"),s("code",[t._v("fetch")]),t._v("（配"),s("code",[t._v("keep-alive")]),t._v("）；")]),t._v(" "),s("li",[t._v("策略：批量上报（500ms 防抖）+ 失败重试（3 次，间隔指数退避），我们项目还加了 “离线缓存”（"),s("code",[t._v("localStorage")]),t._v("暂存，联网后补发）。")])])])]),t._v(" "),s("h3",{attrs:{id:"_2-如何解决-跨域脚本错误-script-error-无法获取完整堆栈的问题"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-如何解决-跨域脚本错误-script-error-无法获取完整堆栈的问题"}},[t._v("#")]),t._v(" 2. 如何解决 “跨域脚本错误（Script error）” 无法获取完整堆栈的问题？")]),t._v(" "),s("p",[s("strong",[t._v("回答模板")]),t._v("：")]),t._v(" "),s("p",[t._v("跨域脚本错误的核心原因是 “浏览器安全策略限制”—— 跨域脚本执行错误时，为避免泄露敏感信息，只返回"),s("code",[t._v("Script error.")]),t._v("，不提供堆栈和行号。我们项目分两步彻底解决：")]),t._v(" "),s("ol",[s("li",[s("p",[s("strong",[t._v("第一步：突破浏览器限制，获取完整错误信息")])]),t._v(" "),s("ul",[s("li",[t._v("脚本标签加 "),s("code",[t._v('crossorigin="anonymous"')]),t._v("：告诉浏览器 “该脚本允许跨域访问”；")]),t._v(" "),s("li",[t._v("服务端配置 CORS 响应头：在 CDN 或静态资源服务器添加"),s("code",[t._v("Access-Control-Allow-Origin: *")]),t._v("（或指定业务域名），确保浏览器认可跨域权限。这一步做完后，"),s("code",[t._v("window.onerror")]),t._v("就能捕获到完整的错误堆栈（如"),s("code",[t._v("Uncaught ReferenceError: a is not defined at xxx.js:10")]),t._v("）。")])])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("第二步：处理压缩代码的堆栈还原（关键补充）")])]),t._v(" "),s("p",[t._v("线上代码通常经过压缩（如 Terser），堆栈中的行号是压缩后的位置，开发无法定位。我们项目的方案是：")]),t._v(" "),s("ul",[s("li",[t._v("构建时生成"),s("code",[t._v("source-map")]),t._v("文件（只保留生产环境必要信息，排除注释），上传到内部服务器（不对外暴露）；")]),t._v(" "),s("li",[t._v("错误上报时，携带 “压缩文件名 + 压缩后行号 / 列号”；")]),t._v(" "),s("li",[t._v("后端（或监控平台）用"),s("code",[t._v("source-map")]),t._v("库（如"),s("code",[t._v("source-map")]),t._v(" npm 包）解析，将压缩后的位置还原为源码位置，最终在平台上展示 “哪个文件的哪一行出了错”。")])])])]),t._v(" "),s("p",[t._v("实际效果：跨域错误的可定位率从 0 提升到 95% 以上，排查效率大幅提升。")]),t._v(" "),s("h3",{attrs:{id:"_3-单页应用-spa-的监控和传统多页应用有什么区别-你是怎么适配-spa-的"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-单页应用-spa-的监控和传统多页应用有什么区别-你是怎么适配-spa-的"}},[t._v("#")]),t._v(" 3. "),s("s",[t._v("单页应用（SPA）的监控和传统多页应用有什么区别？你是怎么适配 SPA 的？")])]),t._v(" "),s("p",[s("strong",[t._v("回答模板")]),t._v("：")]),t._v(" "),s("p",[t._v("SPA 和多页应用的核心区别是 “路由切换不刷新页面”，导致传统监控的 3 个关键问题：")]),t._v(" "),s("ul",[s("li",[t._v("PV 统计不准（多页靠"),s("code",[t._v("pageshow")]),t._v("，SPA 路由切换不触发）")]),t._v(" "),s("li",[t._v("性能指标重复计算（如 FCP 只在首次加载时触发，路由切换后无法重新统计）")]),t._v(" "),s("li",[t._v("错误监控断档（路由切换后，旧页面的"),s("code",[t._v("onerror")]),t._v("监听可能被销毁）")])]),t._v(" "),s("p",[t._v("我们项目针对 SPA 做了 3 点适配，以 React Router 为例：")]),t._v(" "),s("ol",[s("li",[s("strong",[t._v("PV 统计与页面生命周期管理")]),t._v(" "),s("ul",[s("li",[t._v("监听路由钩子：在"),s("code",[t._v("useEffect")]),t._v("（或"),s("code",[t._v("history.listen")]),t._v("）中，路由切换时触发 “虚拟页面加载” 事件，重新初始化 PV 统计（记录新路由的"),s("code",[t._v("pageshow")]),t._v("时间）；")]),t._v(" "),s("li",[t._v("页面停留时间：路由切换时，计算上一个路由的 “离开时间 - 进入时间”，上报停留时间，避免数据丢失。")])])]),t._v(" "),s("li",[s("strong",[t._v("性能指标重新采集")]),t._v(" "),s("ul",[s("li",[t._v("路由切换后，重新监听 LCP/CLS：销毁上一个路由的"),s("code",[t._v("PerformanceObserver")]),t._v("，创建新实例，确保新页面的性能指标能被捕获；")]),t._v(" "),s("li",[t._v("自定义 “路由切换耗时”：记录"),s("code",[t._v("history.push")]),t._v("触发时间和新组件"),s("code",[t._v("componentDidMount")]),t._v("（或"),s("code",[t._v("useEffect")]),t._v("）执行时间，计算路由切换的前端耗时（反映 SPA 的交互流畅度）。")])])]),t._v(" "),s("li",[s("strong",[t._v("错误监控持续生效")]),t._v(" "),s("ul",[s("li",[t._v("全局错误监听（如"),s("code",[t._v("window.onerror")]),t._v("）不随路由销毁，但框架错误（如 React 组件错误）需确保"),s("code",[t._v("ErrorBoundary")]),t._v("在根组件层级，覆盖所有路由页面；")]),t._v(" "),s("li",[t._v("路由切换时，清空上一个页面的 “错误去重缓存”（避免同一错误在不同路由下被误判为新错误）。")])])])]),t._v(" "),s("p",[t._v("适配后，SPA 的监控数据和多页应用一致，能精准反映每个路由的错误、性能和用户行为。")]),t._v(" "),s("h3",{attrs:{id:"_4-如何拦截-xhr-fetch-请求-实现接口耗时和错误的监控-☆☆☆"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-如何拦截-xhr-fetch-请求-实现接口耗时和错误的监控-☆☆☆"}},[t._v("#")]),t._v(" 4. 如何拦截 XHR/fetch 请求，实现接口耗时和错误的监控？☆☆☆")]),t._v(" "),s("p",[s("strong",[t._v("回答模板")]),t._v("：")]),t._v(" "),s("p",[t._v("拦截请求的核心思路是 “重写原生方法，注入监控逻辑”，我们项目同时支持 XHR 和 fetch，方案如下：")]),t._v(" "),s("h4",{attrs:{id:"_1-xhr-拦截-重写原型方法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-xhr-拦截-重写原型方法"}},[t._v("#")]),t._v(" （1）XHR 拦截：重写原型方法")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 保存原生方法")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" originalOpen "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("XMLHttpRequest")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("prototype"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("open"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" originalSend "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("XMLHttpRequest")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("prototype"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("send"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 重写open：记录请求方法、URL")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("XMLHttpRequest")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("prototype"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("open")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("method"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" url")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_monitor "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" method"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" url"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("startTime")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Date"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 挂载监控信息到XHR实例")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("originalOpen")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("apply")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" arguments"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 重写send：监听load/error/abort事件，记录结果和耗时")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("XMLHttpRequest")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("prototype"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("send")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("body")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" _this "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 监听请求完成")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("addEventListener")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'load'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" endTime "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Date"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" data "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'xhr'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("method")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" _this"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_monitor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("method"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("url")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" _this"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_monitor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("url"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("status")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" _this"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("status"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("duration")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" endTime "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" _this"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_monitor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("startTime"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("isError")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" _this"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("status "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("400")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("report")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 上报数据")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 监听错误和中断")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("addEventListener")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'error'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" handleError"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("addEventListener")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'abort'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" handleAbort"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  \n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("originalSend")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("apply")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" arguments"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("h4",{attrs:{id:"_2-fetch-拦截-包装-promise"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-fetch-拦截-包装-promise"}},[t._v("#")]),t._v(" （2）fetch 拦截：包装 Promise")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" originalFetch "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" window"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("fetch"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nwindow"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("fetch")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("input"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" init "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" url "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),t._v(" input "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'string'")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" input "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" input"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("url"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" method "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("method "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'GET'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" startTime "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Date"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 包装Promise，捕获成功/失败")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("originalFetch")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("input"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("response")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 复制response（避免被消费后无法读取）")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" clonedResponse "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" response"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("clone")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" endTime "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Date"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" data "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'fetch'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        method"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        url"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("status")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" response"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("status"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("duration")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" endTime "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" startTime"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("isError")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" response"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("status "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("400")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 如果是JSON响应，可额外记录响应体（需脱敏）")]),t._v("\n      clonedResponse"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("json")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("resBody")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        data"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("responseBody "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("JSON")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("stringify")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("resBody"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("slice")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 只取前200字符")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("report")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("catch")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("report")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 非JSON响应直接上报")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" response"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 不影响原业务逻辑")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("catch")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("error")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" endTime "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Date"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("report")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'fetch'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        method"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        url"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("duration")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" endTime "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" startTime"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("isError")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("errorMsg")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" error"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("message\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throw")]),t._v(" error"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 抛出错误，不影响业务的catch逻辑")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("h4",{attrs:{id:"_3-关键注意点"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-关键注意点"}},[t._v("#")]),t._v(" （3）关键注意点")]),t._v(" "),s("ul",[s("li",[t._v("不破坏原生逻辑：所有重写都调用"),s("code",[t._v("apply")]),t._v("/"),s("code",[t._v("call")]),t._v("保留原生行为，避免影响业务代码；")]),t._v(" "),s("li",[t._v("处理异常场景：如 XHR 的"),s("code",[t._v("abort")]),t._v("、fetch 的网络错误，确保这些场景下也能上报；")]),t._v(" "),s("li",[t._v("数据脱敏：接口 URL 中的敏感参数（如手机号）需替换（如"),s("code",[t._v("/user/13800138000")]),t._v("→"),s("code",[t._v("/user/****")]),t._v("），响应体不记录完整信息，符合隐私合规。")])]),t._v(" "),s("h2",{attrs:{id:"二、难点解决类-区分度题-考察实战能力"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#二、难点解决类-区分度题-考察实战能力"}},[t._v("#")]),t._v(" 二、难点解决类（区分度题，考察实战能力）")]),t._v(" "),s("h3",{attrs:{id:"_5-如何避免-sdk-自身的代码影响页面性能-如占用主线程、消耗带宽-☆☆☆"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-如何避免-sdk-自身的代码影响页面性能-如占用主线程、消耗带宽-☆☆☆"}},[t._v("#")]),t._v(" 5. 如何避免 SDK 自身的代码影响页面性能？（如占用主线程、消耗带宽）☆☆☆")]),t._v(" "),s("p",[s("strong",[t._v("回答模板")]),t._v("：")]),t._v(" "),s("p",[t._v("SDK 的核心原则是 “监控不添乱”，我们项目从 “执行、上报、体积” 三个维度做了优化，确保对页面性能的影响低于 1%：")]),t._v(" "),s("ol",[s("li",[s("strong",[t._v("降低主线程占用：让监控逻辑 “不抢资源”")]),t._v(" "),s("ul",[s("li",[t._v("非紧急逻辑用"),s("code",[t._v("requestIdleCallback")]),t._v("：如行为日志的格式化、非核心指标（如滚动位置）的计算，只在浏览器空闲时执行，避免阻塞 JS 执行和页面渲染；")]),t._v(" "),s("li",[t._v("复杂计算移交 Web Worker：如错误堆栈的解析（尤其是"),s("code",[t._v("source-map")]),t._v("还原）、大量日志的压缩，我们项目用 Worker 处理后，主线程占用率从 8% 降至 1% 以下；")]),t._v(" "),s("li",[t._v("高频事件节流：如"),s("code",[t._v("resize")]),t._v("/"),s("code",[t._v("scroll")]),t._v("监控，用 100ms 节流，避免每秒触发几十次监控逻辑。")])])]),t._v(" "),s("li",[s("strong",[t._v("减少网络消耗：让上报 “不占带宽”")]),t._v(" "),s("ul",[s("li",[t._v("批量上报：将零散的日志（如行为点击、小错误）缓存到内存队列，500ms 防抖批量上报一次，HTTP 请求数减少 80%；")]),t._v(" "),s("li",[t._v("数据压缩：上报前用"),s("code",[t._v("pako")]),t._v("库将 JSON 数据压缩为 gzip 格式（体积减少 60%），服务端解压后解析；")]),t._v(" "),s("li",[t._v("弱网适配：通过"),s("code",[t._v("navigator.connection.effectiveType")]),t._v("判断网络类型（如 2G/3G），弱网下延迟上报非关键数据（如行为日志），优先保证错误和性能数据上报。")])])]),t._v(" "),s("li",[s("strong",[t._v("控制 SDK 体积：让加载 “不拖慢首屏”")]),t._v(" "),s("ul",[s("li",[t._v("插件化按需加载：将 SDK 拆分为 “核心上报模块”（必选，5KB）、“错误监控模块”（可选，3KB）、“行为监控模块”（可选，2KB），业务方只引入需要的模块；")]),t._v(" "),s("li",[t._v("Tree-shaking 优化：用 ES 模块（ESM）打包，配合 Webpack/Rollup 的 Tree-shaking，剔除未使用的代码（如不开启行为监控则不打包相关逻辑）；")]),t._v(" "),s("li",[t._v("异步加载 SDK：业务方通过动态脚本插入（"),s("code",[t._v("document.createElement('script')")]),t._v("）加载 SDK，且放在"),s("code",[t._v("DOMContentLoaded")]),t._v("后执行，不阻塞首屏渲染。")])])])]),t._v(" "),s("p",[t._v("我们还在内部做了性能压测：在低端机（如 iPhone 8）和弱网（3G）环境下，集成 SDK 后页面的 FCP 只延迟了 20ms，完全在可接受范围内。")]),t._v(" "),s("h3",{attrs:{id:"_6-如何解决-错误重复上报-的问题-请举例说明。☆☆☆"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_6-如何解决-错误重复上报-的问题-请举例说明。☆☆☆"}},[t._v("#")]),t._v(" 6. 如何解决 “错误重复上报” 的问题？请举例说明。☆☆☆")]),t._v(" "),s("p",[s("strong",[t._v("回答模板")]),t._v("：")]),t._v(" "),s("p",[t._v("错误重复上报的核心原因是 “同一错误触发多次监控事件”，比如：")]),t._v(" "),s("ul",[s("li",[t._v("循环中抛出的错误（每秒触发 10 次"),s("code",[t._v("onerror")]),t._v("）")]),t._v(" "),s("li",[t._v("SPA 路由切换后，旧页面的错误监听未销毁，重复捕获同一错误")]),t._v(" "),s("li",[t._v("同一错误在不同生命周期（如"),s("code",[t._v("load")]),t._v("和"),s("code",[t._v("DOMContentLoaded")]),t._v("）被捕获")])]),t._v(" "),s("p",[t._v("我们项目用 “"),s("strong",[t._v("唯一标识去重 + 过期清理")]),t._v("” 的方案解决，具体分 3 步：")]),t._v(" "),s("ol",[s("li",[s("p",[s("strong",[t._v("生成错误的唯一标识（key）")])]),t._v(" "),s("p",[t._v("基于 “错误的核心特征” 生成哈希值，确保同一错误的 key 唯一，不同错误的 key 不同。我们项目的 key 生成规则是：")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("generateErrorKey")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("error")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 核心特征：错误类型+错误信息+堆栈的关键行（前3行）+当前URL")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" errorType "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" error"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("name "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'UnknownError'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" errorMsg "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" error"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("message "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" stackKey "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("error"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("stack "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("split")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'\\n'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("slice")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("join")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 取堆栈前3行，避免过长")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" url "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" window"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("location"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("href"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 用MD5生成短哈希（避免key过长）")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("md5")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token template-string"}},[s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("errorType"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("_")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("errorMsg"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("_")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("stackKey"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("_")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("url"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("用 “去重缓存” 记录已上报的错误")])]),t._v(" "),s("p",[t._v("用"),s("code",[t._v("localStorage")]),t._v("（持久化，避免页面刷新后失效）+ 内存对象（高效读取）维护去重缓存，结构如下：")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 内存缓存：记录当前页面已上报的错误key（页面关闭后清空）")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" inMemoryCache "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Set")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// localStorage缓存：记录24小时内已上报的错误key（跨页面/刷新生效）")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("getLocalCache")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("JSON")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("parse")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("localStorage"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getItem")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'monitor_error_cache'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'{}'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("setLocalCache")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("cache")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" localStorage"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setItem")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'monitor_error_cache'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("JSON")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("stringify")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cache"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 检查错误是否已上报")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("isErrorReported")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("errorKey")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 先查内存（快），再查localStorage（持久）")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("inMemoryCache"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("has")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("errorKey"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" localCache "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getLocalCache")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" now "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Date"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 清理24小时前的过期缓存（避免localStorage膨胀）")]),t._v("\n  Object"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("keys")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("localCache"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("forEach")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("key")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("now "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" localCache"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("24")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("60")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("60")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("delete")]),t._v(" localCache"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setLocalCache")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("localCache"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 判断是否存在未过期的key")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("localCache"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("errorKey"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 不存在则加入缓存")]),t._v("\n  inMemoryCache"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("errorKey"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  localCache"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("errorKey"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" now"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setLocalCache")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("localCache"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("上报前校验去重")])]),t._v(" "),s("p",[t._v("在错误上报函数中加入校验，已上报的错误直接跳过：")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("reportError")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("error")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" errorKey "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("generateErrorKey")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("error"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("isErrorReported")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("errorKey"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'重复错误，跳过上报'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" errorKey"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 正常上报逻辑...")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])])]),t._v(" "),s("p",[t._v("实际效果：之前循环错误会上报 100 次，现在只上报 1 次；SPA 路由切换后的重复错误也被完全过滤，错误数据的准确性提升 90%。")]),t._v(" "),s("h3",{attrs:{id:"_7-如何监控前端的-白屏-问题-白屏的常见原因有哪些"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_7-如何监控前端的-白屏-问题-白屏的常见原因有哪些"}},[t._v("#")]),t._v(" 7. 如何监控前端的 “白屏” 问题？白屏的常见原因有哪些？")]),t._v(" "),s("p",[s("strong",[t._v("回答模板")]),t._v("：")]),t._v(" "),s("p",[t._v("白屏是前端严重的用户体验问题，核心是 “页面加载后，关键内容长时间未渲染”。我们项目从 “"),s("strong",[t._v("白屏检测")]),t._v("” 和 “"),s("strong",[t._v("原因定位")]),t._v("” 两方面实现监控：")]),t._v(" "),s("h4",{attrs:{id:"_1-白屏检测方案-多维度判断"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-白屏检测方案-多维度判断"}},[t._v("#")]),t._v(" （1）白屏检测方案：多维度判断")]),t._v(" "),s("p",[t._v("结合 “DOM 渲染状态” 和 “时间阈值”，避免误判（如首屏加载慢但未白屏）：")]),t._v(" "),s("ol",[s("li",[s("strong",[t._v("DOM 维度")]),t._v("：监听"),s("code",[t._v("DOMContentLoaded")]),t._v("后，检查 “关键容器”（如"),s("code",[t._v("#app")]),t._v("）是否有子元素（排除空文本节点）；")]),t._v(" "),s("li",[s("strong",[t._v("时间维度")]),t._v("：设置白屏阈值（如 5s），如果"),s("code",[t._v("load")]),t._v("事件触发后 5s，关键容器仍无有效内容，判定为白屏；")]),t._v(" "),s("li",[s("strong",[t._v("视觉维度")]),t._v("：辅助判断（可选）—— 用"),s("code",[t._v("document.elementFromPoint(100, 100)")]),t._v("（取页面中间点），如果返回的元素是"),s("code",[t._v("html")]),t._v("/"),s("code",[t._v("body")]),t._v("或"),s("code",[t._v("null")]),t._v("，说明中间区域无内容。")])]),t._v(" "),s("p",[t._v("核心代码逻辑：")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("checkWhiteScreen")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" criticalContainer "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" document"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getElementById")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'app'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 业务方配置的关键容器")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("criticalContainer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 容器不存在，不检测")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 检查容器是否有有效内容（排除空文本、注释节点）")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" hasContent "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Array"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("from")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("criticalContainer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("childNodes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("some")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("node")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 元素节点：有宽高或有子元素")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("nodeType "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" rect "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getBoundingClientRect")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" rect"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("width "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" rect"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("height "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("childNodes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 文本节点：非空（排除空格）")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("nodeType "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("textContent"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("trim")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 时间阈值+DOM状态判断")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" loadTime "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" performance"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("timing"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("loadEventEnd "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" performance"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("timing"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("navigationStart"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("loadTime "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5000")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("hasContent"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 判定为白屏，上报数据")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("report")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'whiteScreen'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      loadTime"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("container")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'#app'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 补充上下文：当前URL、浏览器版本、网络类型")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("url")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" window"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("location"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("href"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("ua")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" navigator"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("userAgent"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("network")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" navigator"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("connection"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?.")]),t._v("effectiveType\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 触发检测：load事件后1s（避免load刚触发时内容未渲染完）")]),t._v("\nwindow"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("addEventListener")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'load'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("checkWhiteScreen"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("h4",{attrs:{id:"_2-白屏常见原因及定位"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-白屏常见原因及定位"}},[t._v("#")]),t._v(" （2）白屏常见原因及定位")]),t._v(" "),s("p",[t._v("上报白屏时，我们还会关联 “其他监控数据”，帮助快速定位原因：")]),t._v(" "),s("ul",[s("li",[t._v("原因 1：JS 执行错误（如首屏渲染脚本报错，导致"),s("code",[t._v("#app")]),t._v("未挂载）→ 关联 “错误监控数据”，看白屏时间是否有 JS 错误；")]),t._v(" "),s("li",[t._v("原因 2：资源加载失败（如首屏 CSS/JS 加载超时）→ 关联 “资源错误数据”，看是否有"),s("code",[t._v("link")]),t._v("/"),s("code",[t._v("script")]),t._v("加载失败；")]),t._v(" "),s("li",[t._v("原因 3：接口返回异常（如首屏接口返回 500，导致数据为空）→ 关联 “接口监控数据”，看白屏前是否有接口错误；")]),t._v(" "),s("li",[t._v("原因 4：CSS 样式问题（如"),s("code",[t._v("#app")]),t._v("被设置"),s("code",[t._v("display: none")]),t._v("）→ 上报时记录关键容器的"),s("code",[t._v("computedStyle")]),t._v("（如"),s("code",[t._v("display")]),t._v("/"),s("code",[t._v("visibility")]),t._v("/"),s("code",[t._v("opacity")]),t._v("）。")])]),t._v(" "),s("p",[t._v("实际案例：我们曾通过白屏监控发现，某活动页在 iOS 12 浏览器下白屏，关联错误数据后，定位到是 “ES6 语法未转译”（"),s("code",[t._v("const")]),t._v("未转成"),s("code",[t._v("var")]),t._v("），导致首屏 JS 报错。")]),t._v(" "),s("h2",{attrs:{id:"三、工程化与架构类-考察深度-区分高级开发"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#三、工程化与架构类-考察深度-区分高级开发"}},[t._v("#")]),t._v(" 三、工程化与架构类（考察深度，区分高级开发）")]),t._v(" "),s("h3",{attrs:{id:"_8-你设计的-sdk-是如何实现-可配置-和-可扩展-的-请举例说明。"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_8-你设计的-sdk-是如何实现-可配置-和-可扩展-的-请举例说明。"}},[t._v("#")]),t._v(" 8. 你设计的 SDK 是如何实现 “可配置” 和 “可扩展” 的？请举例说明。")]),t._v(" "),s("p",[s("strong",[t._v("回答模板")]),t._v("：")]),t._v(" "),s("p",[t._v("SDK 的可配置和可扩展是 “产品化” 的关键 —— 不同业务方的需求不同（如 A 业务要行为监控，B 业务只需要错误监控），且未来可能新增功能（如小程序监控）。我们项目用 “"),s("strong",[t._v("配置中心 + 插件化架构")]),t._v("” 实现，具体如下：")]),t._v(" "),s("h4",{attrs:{id:"_1-可配置-分层配置-满足不同需求"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-可配置-分层配置-满足不同需求"}},[t._v("#")]),t._v(" （1）可配置：分层配置，满足不同需求")]),t._v(" "),s("p",[t._v("设计 “默认配置 + 业务配置 + 动态配置” 三层结构，优先级：动态配置 > 业务配置 > 默认配置：")]),t._v(" "),s("ol",[s("li",[s("strong",[t._v("默认配置")]),t._v("：内置基础配置，业务方无需关心（如上报间隔 500ms，采样率 100%）；")]),t._v(" "),s("li",[s("strong",[t._v("业务配置")]),t._v("：业务方初始化时传入，覆盖默认配置（如"),s("code",[t._v("init({ enableBehavior: false, sampleRate: 50 })")]),t._v("）；")]),t._v(" "),s("li",[s("strong",[t._v("动态配置")]),t._v("：通过接口拉取远程配置（如从监控平台获取），实时生效（如线上发现问题，动态关闭某模块）。")])]),t._v(" "),s("p",[t._v("配置项设计（核心部分）：")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" defaultConfig "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("reportUrl")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'https://monitor.xxx.com/report'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 默认上报地址")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("modules")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("error")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 错误监控：默认开启")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("performance")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 性能监控：默认开启")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("behavior")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 行为监控：默认关闭（避免隐私问题）")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("sampleRate")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 采样率：默认100%（全量）")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("batchInterval")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("500")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 批量上报间隔：500ms")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("beforeReport")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("data")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" data"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 上报前钩子：默认不处理")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("whiteList")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 错误上报白名单：默认无（所有错误都上报）")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 初始化函数：合并配置")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("init")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("customConfig "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1. 合并默认配置和业务配置")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" mergedConfig "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("defaultConfig"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("customConfig "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2. 拉取动态配置（异步，不阻塞初始化）")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("fetch")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'https://monitor.xxx.com/config'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("res")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" res"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("json")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("dynamicConfig")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 动态配置覆盖合并后的配置")]),t._v("\n      Object"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("assign")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("mergedConfig"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dynamicConfig"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 重新初始化模块（如动态关闭错误监控）")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("reInitModules")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("mergedConfig"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 3. 初始化模块")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("initModules")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("mergedConfig"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" mergedConfig"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h4",{attrs:{id:"_2-可扩展-插件化架构-支持新增功能"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-可扩展-插件化架构-支持新增功能"}},[t._v("#")]),t._v(" （2）可扩展：插件化架构，支持新增功能")]),t._v(" "),s("p",[t._v("将 SDK 拆分为 “核心层” 和 “插件层”，核心层提供基础能力（如上报、配置管理），插件层实现具体监控功能（如错误插件、性能插件）：")]),t._v(" "),s("ol",[s("li",[s("p",[s("strong",[t._v("核心层能力")]),t._v("：")]),t._v(" "),s("ul",[s("li",[t._v("配置管理：提供"),s("code",[t._v("getConfig()")]),t._v("/"),s("code",[t._v("setConfig()")]),t._v("方法，供插件获取配置；")]),t._v(" "),s("li",[t._v("上报管理：提供"),s("code",[t._v("report(data)")]),t._v("方法，统一处理批量、重试、压缩；")]),t._v(" "),s("li",[t._v("插件注册：提供"),s("code",[t._v("registerPlugin(plugin)")]),t._v("方法，标准化插件接入。")])])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("插件标准化接口")]),t._v("：")]),t._v(" "),s("p",[t._v("每个插件必须实现"),s("code",[t._v("name")]),t._v("（唯一标识）、"),s("code",[t._v("init")]),t._v("（初始化）、"),s("code",[t._v("destroy")]),t._v("（销毁）三个方法，核心层通过接口调用插件：")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 错误监控插件示例")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" ErrorPlugin "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'error'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 插件名，与配置中的modules.error对应")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("init")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("config")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 初始化错误监听（window.onerror等）")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("bindListeners")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("destroy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 销毁监听，避免内存泄漏")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("unbindListeners")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("bindListeners")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    window"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("onerror "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("handleError")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("bind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...其他监听")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("handleError")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("error")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 错误处理逻辑")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("report")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'error'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("error "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 核心层注册插件")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("registerPlugin")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("plugin")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("plugin"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("name "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("plugin"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("error")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'插件必须实现name和init方法'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 存入插件列表")]),t._v("\n  window"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("__MONITOR_PLUGINS__ "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" window"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("__MONITOR_PLUGINS__ "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  window"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("__MONITOR_PLUGINS__"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("plugin"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" plugin"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 根据配置决定是否初始化")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" config "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getConfig")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("modules"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("plugin"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    plugin"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("init")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("扩展案例")]),t._v("：新增 “小程序监控插件”")]),t._v(" "),s("p",[t._v("无需修改核心层代码，只需开发新插件，实现"),s("code",[t._v("init")]),t._v("/"),s("code",[t._v("destroy")]),t._v("：")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" MiniProgramPlugin "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'miniProgram'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("init")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("config")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 小程序特有的监控逻辑（如App.onError、Page.onLoad）")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("App")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("onError")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("error")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("report")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'miniProgramError'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("error "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("destroy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 小程序销毁逻辑")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 业务方引入并注册")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" registerPlugin"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" MiniProgramPlugin "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'monitor-sdk'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("registerPlugin")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("MiniProgramPlugin"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])])])]),t._v(" "),s("p",[t._v("这种架构的优势：新增功能不影响现有代码，插件可独立迭代，业务方按需引入，灵活性极高。")]),t._v(" "),s("h3",{attrs:{id:"_9-sdk-的-数据上报-模块需要考虑哪些问题-如何设计一个可靠的上报方案-☆☆☆☆"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_9-sdk-的-数据上报-模块需要考虑哪些问题-如何设计一个可靠的上报方案-☆☆☆☆"}},[t._v("#")]),t._v(" 9. SDK 的 “数据上报” 模块需要考虑哪些问题？如何设计一个可靠的上报方案？☆☆☆☆")]),t._v(" "),s("p",[s("strong",[t._v("回答模板")]),t._v("：")]),t._v(" "),s("p",[t._v("上报模块是 SDK 的 “最后一公里”，核心目标是 “"),s("strong",[t._v("不丢数据、不影响业务、可追溯")]),t._v("”。我们项目从 “"),s("strong",[t._v("可靠性")]),t._v("”“"),s("strong",[t._v("安全性")]),t._v("”“"),s("strong",[t._v("可观测性")]),t._v("” 三个维度设计上报方案：")]),t._v(" "),s("h4",{attrs:{id:"_1-可靠性-确保数据不丢"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-可靠性-确保数据不丢"}},[t._v("#")]),t._v(" （1）可靠性：确保数据不丢")]),t._v(" "),s("ol",[s("li",[s("strong",[t._v("批量上报 + 内存队列")]),t._v("：\n"),s("ul",[s("li",[t._v("所有待上报数据先存入内存队列（"),s("code",[t._v("Array")]),t._v("），500ms 防抖批量上报（减少 HTTP 请求）；")]),t._v(" "),s("li",[t._v("队列满了（如 100 条）强制上报，避免内存溢出。")])])]),t._v(" "),s("li",[s("strong",[t._v("失败重试机制")]),t._v("：\n"),s("ul",[s("li",[t._v("上报失败后，将数据移入 “重试队列”，重试 3 次，间隔指数退避（1s→2s→4s），避免频繁重试占用资源；")]),t._v(" "),s("li",[t._v("3 次重试失败后，将数据存入"),s("code",[t._v("localStorage")]),t._v("（离线缓存），下次页面加载时检查并补发。")])])]),t._v(" "),s("li",[s("strong",[t._v("上报方式降级")]),t._v("：\n"),s("ul",[s("li",[t._v("优先用"),s("code",[t._v("fetch")]),t._v("（支持 POST、大体积数据、CORS）；")]),t._v(" "),s("li",[t._v("不支持"),s("code",[t._v("fetch")]),t._v("的浏览器（如 IE11），降级用"),s("code",[t._v("img")]),t._v("标签（兼容性最好，适合小体积数据，如错误日志）；")]),t._v(" "),s("li",[s("code",[t._v("img")]),t._v("标签也失败时（如网络中断），走离线缓存。")])])])]),t._v(" "),s("p",[t._v("核心代码（简化版）：")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Reporter")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("constructor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("queue "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 待上报队列")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("retryQueue "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 重试队列")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("timer "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 批量上报定时器")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 添加数据到队列")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("data")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("queue"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("push")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("triggerBatch")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 触发批量上报")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 队列满了强制上报")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("queue"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("reportBatch")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 防抖触发批量上报")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("triggerBatch")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("clearTimeout")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("timer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("timer "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("reportBatch")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("500")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 批量上报")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("reportBatch")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("queue"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" data "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("queue"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("splice")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 取出队列数据")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("send")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 上报成功：如果有重试队列，优先上报重试队列")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("retryQueue"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" retryData "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("retryQueue"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("splice")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("send")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("retryData"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("catch")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("error"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 上报失败：加入重试队列")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("retryQueue"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("push")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("data"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 重试3次后存入localStorage")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("retryQueue"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("saveToLocal")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("retryQueue "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 发送请求（支持fetch/img降级）")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("send")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("data")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" config "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getConfig")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" jsonData "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("JSON")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("stringify")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 优先用fetch")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("window"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("fetch"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("fetch")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("reportUrl"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("method")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'POST'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("headers")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v("'Content-Type'")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'application/json'")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("body")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" jsonData"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("credentials")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'include'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 携带Cookie（用于用户标识）")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("keepalive")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 页面卸载时也能完成上报")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("res")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("res"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ok"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throw")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Error")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'上报失败'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 降级用img标签（只支持GET，需将数据编码为query）")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" img "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    img"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("src "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token template-string"}},[s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("reportUrl"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("?data=")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("encodeURIComponent")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("jsonData"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Promise")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("resolve"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" reject")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      img"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("onload "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" resolve"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      img"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("onerror "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" reject"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 离线缓存到localStorage")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("saveToLocal")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("data")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" key "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token template-string"}},[s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("monitor_offline_")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("Date"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    localStorage"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setItem")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("JSON")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("stringify")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 初始化：补发离线缓存")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("init")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 遍历localStorage，补发所有离线数据")]),t._v("\n    Object"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("keys")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("localStorage"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("forEach")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("key")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("startsWith")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'monitor_offline_'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" data "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("JSON")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("parse")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("localStorage"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getItem")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        localStorage"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("removeItem")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 补发后删除")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h4",{attrs:{id:"_2-安全性-确保数据合规、不泄露"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-安全性-确保数据合规、不泄露"}},[t._v("#")]),t._v(" （2）安全性：确保数据合规、不泄露")]),t._v(" "),s("ol",[s("li",[s("strong",[t._v("数据脱敏")]),t._v("：\n"),s("ul",[s("li",[t._v("用户信息：手机号、邮箱、身份证号用"),s("code",[t._v("*")]),t._v("替换（如"),s("code",[t._v("138****8000")]),t._v("）；")]),t._v(" "),s("li",[t._v("URL 参数：敏感参数（如"),s("code",[t._v("token")]),t._v("/"),s("code",[t._v("password")]),t._v("）从上报的 URL 中剔除；")]),t._v(" "),s("li",[t._v("响应体：只记录前 200 字符，且过滤"),s("code",[t._v("data.user")]),t._v("等敏感字段。")])])]),t._v(" "),s("li",[s("strong",[t._v("权限控制")]),t._v("：\n"),s("ul",[s("li",[t._v("提供"),s("code",[t._v("beforeReport")]),t._v("钩子，业务方可自定义过滤数据（如"),s("code",[t._v("beforeReport: (data) => data.type !== 'behavior' ? data : null")]),t._v("，不上报行为数据）；")]),t._v(" "),s("li",[t._v("动态配置 “上报白名单”，只允许指定域名的上报请求（避免恶意使用 SDK 上报垃圾数据）。")])])]),t._v(" "),s("li",[s("strong",[t._v("隐私合规")]),t._v("：\n"),s("ul",[s("li",[t._v("支持 “用户授权开关”，用户拒绝授权时，不采集行为、设备等敏感数据；")]),t._v(" "),s("li",[t._v("上报数据不包含唯一用户标识（如 UUID），如需用户关联，由业务方传入脱敏后的用户 ID。")])])])]),t._v(" "),s("h4",{attrs:{id:"_3-可观测性-确保上报问题可追溯"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-可观测性-确保上报问题可追溯"}},[t._v("#")]),t._v(" （3）可观测性：确保上报问题可追溯")]),t._v(" "),s("ol",[s("li",[s("strong",[t._v("上报日志")]),t._v("：\n"),s("ul",[s("li",[t._v("上报成功 / 失败的日志，在开发环境打印到控制台（生产环境关闭），方便调试；")]),t._v(" "),s("li",[t._v("上报数据中加入"),s("code",[t._v("reportId")]),t._v("（唯一标识），监控平台可通过"),s("code",[t._v("reportId")]),t._v("查询具体上报记录。")])])]),t._v(" "),s("li",[s("strong",[t._v("上报监控")]),t._v("：\n"),s("ul",[s("li",[t._v("在 SDK 内部监控 “上报成功率”，如果成功率低于 90%，触发告警（如钉钉通知）；")]),t._v(" "),s("li",[t._v("记录上报耗时，如耗时超过 1s，调整批量上报策略（如减少单次上报数据量）。")])])])]),t._v(" "),s("h3",{attrs:{id:"_10-如何设计-sdk-的-采样策略-为什么需要采样"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_10-如何设计-sdk-的-采样策略-为什么需要采样"}},[t._v("#")]),t._v(" 10. 如何设计 SDK 的 “采样策略”？为什么需要采样？")]),t._v(" "),s("p",[s("strong",[t._v("回答模板")]),t._v("：")]),t._v(" "),s("p",[t._v("采样的核心目的是 “"),s("strong",[t._v("在保证数据准确性的前提下，降低 SDK 对业务的性能影响和监控平台的存储压力")]),t._v("”—— 如果百万级用户全量上报，每天可能产生 TB 级数据，存储和计算成本极高，且大部分数据是重复的（如同一错误在不同用户端触发）。")]),t._v(" "),s("p",[t._v("我们项目设计了 “"),s("strong",[t._v("分层采样策略")]),t._v("”，根据 “数据类型” 和 “业务场景” 动态调整采样率，具体如下：")]),t._v(" "),s("h4",{attrs:{id:"_1-为什么需要采样"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-为什么需要采样"}},[t._v("#")]),t._v(" （1）为什么需要采样？")]),t._v(" "),s("ol",[s("li",[s("strong",[t._v("降低性能消耗")]),t._v("：全量上报会产生大量 HTTP 请求，占用带宽和主线程资源，尤其是弱网和低端机；")]),t._v(" "),s("li",[s("strong",[t._v("减少存储成本")]),t._v("：监控平台存储全量数据的成本极高（如 100 万用户，每人每天产生 100 条日志，每天 10 亿条，约 100GB）；")]),t._v(" "),s("li",[s("strong",[t._v("保证数据有效性")]),t._v("：大部分重复数据（如同一错误）对分析价值不大，采样后的数据仍能反映整体趋势（如错误率、性能指标分布）。")])]),t._v(" "),s("h4",{attrs:{id:"_2-分层采样策略设计"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-分层采样策略设计"}},[t._v("#")]),t._v(" （2）分层采样策略设计")]),t._v(" "),s("p",[t._v("根据数据的 “重要性” 和 “重复率”，设置不同的采样率：")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("数据类型")]),t._v(" "),s("th",[t._v("重要性")]),t._v(" "),s("th",[t._v("重复率")]),t._v(" "),s("th",[t._v("采样率策略")]),t._v(" "),s("th",[t._v("示例")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("错误监控")]),t._v(" "),s("td",[t._v("高")]),t._v(" "),s("td",[t._v("中")]),t._v(" "),s("td",[t._v("100% 全量（关键错误不遗漏）")]),t._v(" "),s("td",[t._v("所有 JS 错误、资源错误全量上报")])]),t._v(" "),s("tr",[s("td",[t._v("性能监控")]),t._v(" "),s("td",[t._v("中")]),t._v(" "),s("td",[t._v("高")]),t._v(" "),s("td",[t._v("按用户采样（如 50%）")]),t._v(" "),s("td",[t._v("50% 用户的 LCP/CLS 数据上报")])]),t._v(" "),s("tr",[s("td",[t._v("行为监控")]),t._v(" "),s("td",[t._v("低")]),t._v(" "),s("td",[t._v("极高")]),t._v(" "),s("td",[t._v("按用户 + 事件采样（如 20%）")]),t._v(" "),s("td",[t._v("20% 用户的点击、输入事件上报")])]),t._v(" "),s("tr",[s("td",[t._v("白屏 / 崩溃监控")]),t._v(" "),s("td",[t._v("极高")]),t._v(" "),s("td",[t._v("低")]),t._v(" "),s("td",[t._v("100% 全量（严重问题不遗漏）")]),t._v(" "),s("td",[t._v("所有白屏、页面崩溃全量上报")])])])]),t._v(" "),s("h4",{attrs:{id:"_3-采样实现方案"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-采样实现方案"}},[t._v("#")]),t._v(" （3）采样实现方案")]),t._v(" "),s("ol",[s("li",[s("p",[s("strong",[t._v("用户级采样")]),t._v("：基于用户唯一标识（如"),s("code",[t._v("navigator.userAgent")]),t._v("+"),s("code",[t._v("screen.width")]),t._v("的哈希值），确保同一用户始终被采样（或不被采样），避免数据偏差：")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 生成用户唯一标识（非隐私数据，只用于采样）")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("generateUserId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" ua "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" navigator"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("userAgent"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" screen "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token template-string"}},[s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("window"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("screen"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("width"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("x")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("window"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("screen"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("height"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("md5")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token template-string"}},[s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("ua"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("_")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("screen"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("slice")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 取前8位哈希")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 用户级采样：判断用户是否在采样范围内")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("isUserSampled")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("sampleRate")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sampleRate "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" userId "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("generateUserId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 将哈希值转为数字（0-15777215，因为8位16进制最大是FF FF FF = 16^6-1=16777215）")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" userNum "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("parseInt")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("userId"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 采样率=样本数/总数 → 如50%采样率：userNum < 16777215 * 0.5")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" userNum "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("16777215")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sampleRate "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("事件级采样")]),t._v("：对高频事件（如点击），在用户级采样的基础上，再做事件级采样（如 20% 的点击事件上报），进一步减少数据量：")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 事件级采样：随机判断当前事件是否上报")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("isEventSampled")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("sampleRate")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sampleRate "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" Math"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("random")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sampleRate "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 行为监控插件中的采样逻辑")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("handleClick")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("e")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" config "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getConfig")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 先判断用户是否在采样范围内，再判断事件是否被采样")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("isUserSampled")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("behaviorSampleRate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("isEventSampled")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("20")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("report")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'click'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("target")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" e"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("target"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tagName"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("动态调整采样率")]),t._v("：")]),t._v(" "),s("ul",[s("li",[t._v("峰值时段（如电商大促）：自动降低采样率（如从 50% 降至 20%），避免监控平台过载；")]),t._v(" "),s("li",[t._v("新功能上线：提高采样率（如 100%），确保能捕获新功能的错误和性能问题；")]),t._v(" "),s("li",[t._v("异常场景：如错误率突增，自动提高该错误类型的采样率（100%），便于定位原因。")])])])]),t._v(" "),s("h4",{attrs:{id:"_4-采样数据的准确性保障"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-采样数据的准确性保障"}},[t._v("#")]),t._v(" （4）采样数据的准确性保障")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("分层抽样")]),t._v("：确保不同用户群体（如不同浏览器、不同设备）的采样比例一致，避免数据偏差；")]),t._v(" "),s("li",[s("strong",[t._v("数据校正")]),t._v("：监控平台展示时，用 “采样率” 对数据进行校正（如采样率 50%，统计错误数时乘以 2），反映真实情况；")]),t._v(" "),s("li",[s("strong",[t._v("采样日志")]),t._v("：上报数据中携带"),s("code",[t._v("sampleRate")]),t._v("字段，方便平台后续分析和校正。")])]),t._v(" "),s("h2",{attrs:{id:"四、业务价值与优化类-考察思维高度-加分项"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#四、业务价值与优化类-考察思维高度-加分项"}},[t._v("#")]),t._v(" 四、业务价值与优化类（考察思维高度，加分项）")]),t._v(" "),s("h3",{attrs:{id:"_11-你做的监控-sdk-给业务带来了哪些实际价值-请举-1-2-个具体案例。"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_11-你做的监控-sdk-给业务带来了哪些实际价值-请举-1-2-个具体案例。"}},[t._v("#")]),t._v(" 11. 你做的监控 SDK 给业务带来了哪些实际价值？请举 1-2 个具体案例。")]),t._v(" "),s("p",[s("strong",[t._v("回答模板")]),t._v("：")]),t._v(" "),s("p",[t._v("SDK 的核心价值是 “"),s("strong",[t._v("提前发现问题、快速定位问题、优化用户体验")]),t._v("”，我们项目落地后，给业务带来了 3 个关键价值，举 2 个具体案例：")]),t._v(" "),s("h4",{attrs:{id:"案例-1-线上-js-错误率从-3-降至-0-5-挽回百万级用户损失"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#案例-1-线上-js-错误率从-3-降至-0-5-挽回百万级用户损失"}},[t._v("#")]),t._v(" 案例 1：线上 JS 错误率从 3% 降至 0.5%，挽回百万级用户损失")]),t._v(" "),s("ul",[s("li",[s("p",[s("strong",[t._v("背景")]),t._v("：某电商 APP 的 H5 页面（日活 50 万），用户反馈 “点击购物车后白屏”，但开发无法复现，问题持续 1 周，用户流失率上升 2%。")])]),t._v(" "),s("li",[s("p",[t._v("SDK 的作用：")]),t._v(" "),s("ol",[s("li",[t._v("错误监控捕获到 “"),s("code",[t._v("cart.js:203 Uncaught TypeError: Cannot read property 'id' of undefined")]),t._v("”，且堆栈显示是 “用户删除最后一件商品后，"),s("code",[t._v("cartList[0].id")]),t._v("未判空”；")]),t._v(" "),s("li",[t._v("关联行为数据发现：该错误只在 “iOS 11 浏览器 + 删除最后一件商品” 场景下触发（之前测试未覆盖该场景）；")]),t._v(" "),s("li",[t._v("错误上报的用户分布显示：每天有 1.5 万用户触发该错误（错误率 3%），对应约 3000 用户流失（按 2% 流失率）。")])])]),t._v(" "),s("li",[s("p",[t._v("业务效果：")]),t._v(" "),s("p",[t._v("开发修复后，错误率降至 0.5% 以下，每天减少 3000 用户流失，按客单价 100 元计算，每月挽回约 90 万营收。")])])]),t._v(" "),s("h4",{attrs:{id:"案例-2-首屏加载时间从-6s-优化至-2-5s-转化率提升-15"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#案例-2-首屏加载时间从-6s-优化至-2-5s-转化率提升-15"}},[t._v("#")]),t._v(" 案例 2：首屏加载时间从 6s 优化至 2.5s，转化率提升 15%")]),t._v(" "),s("ul",[s("li",[s("p",[s("strong",[t._v("背景")]),t._v("：某金融产品的注册页，用户反馈 “加载慢”，注册转化率只有 8%，低于行业平均的 12%。")])]),t._v(" "),s("li",[s("p",[t._v("SDK 的作用：")]),t._v(" "),s("ol",[s("li",[t._v("性能监控显示：首屏 LCP（最大内容绘制）为 6s（远超谷歌推荐的 2.5s），主要瓶颈是 “首屏 banner 图（2.5MB）加载耗时 3s” 和 “注册接口响应耗时 1.8s”；")]),t._v(" "),s("li",[t._v("资源监控发现：banner 图未做压缩（原图 2.5MB，压缩后可降至 300KB），且未开启 CDN 加速；")]),t._v(" "),s("li",[t._v("接口监控显示：注册接口的 TTFB（首字节时间）1.2s，主要是数据库查询未加索引。")])])]),t._v(" "),s("li",[s("p",[t._v("业务效果：")]),t._v(" "),s("p",[t._v("优化后（图片压缩 + CDN + 接口加索引），首屏 LCP 降至 2.5s，注册转化率提升至 13.2%，每月新增注册用户约 5000 人，对应新增营收约 25 万元。")])])]),t._v(" "),s("h3",{attrs:{id:"_12-未来你会如何优化这个-sdk-有哪些规划"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_12-未来你会如何优化这个-sdk-有哪些规划"}},[t._v("#")]),t._v(" 12. 未来你会如何优化这个 SDK？有哪些规划？")]),t._v(" "),s("p",[s("strong",[t._v("回答模板")]),t._v("：")]),t._v(" "),s("p",[t._v("基于当前 SDK 的落地效果，未来会从 “"),s("strong",[t._v("监控维度扩展")]),t._v("”“"),s("strong",[t._v("智能化能力")]),t._v("”“"),s("strong",[t._v("跨端适配")]),t._v("” 三个方向优化，具体规划：")]),t._v(" "),s("ol",[s("li",[s("strong",[t._v("监控维度扩展：覆盖更多前端场景")]),t._v(" "),s("ul",[s("li",[t._v("新增 “用户体验监控”：如页面卡顿（监听"),s("code",[t._v("longtask")]),t._v("，超过 50ms 的任务判定为卡顿）、手势操作异常（如移动端双击、滑动无响应）；")]),t._v(" "),s("li",[t._v("新增 “前端安全监控”：如 XSS 攻击（监控"),s("code",[t._v("document.write")]),t._v("、"),s("code",[t._v("eval")]),t._v("等危险 API 调用）、CSRF 攻击（监控异常的表单提交和接口请求）；")]),t._v(" "),s("li",[t._v("新增 “资源性能监控”：如图片懒加载失效、CSS 阻塞渲染、JS 执行时间过长（帮助定位资源优化点）。")])])]),t._v(" "),s("li",[s("strong",[t._v("智能化能力：从 “监控” 到 “诊断”")]),t._v(" "),s("ul",[s("li",[t._v("错误智能分类：基于 AI 模型自动将错误分类（如 “语法错误”“接口错误”“框架错误”），并给出修复建议（如 “未定义变量，建议在使用前判空”）；")]),t._v(" "),s("li",[t._v("性能根因分析：自动关联 “性能指标 - 资源加载 - 接口耗时”，定位性能瓶颈根因（如 “LCP 高是因为 banner 图未压缩，且 CDN 节点延迟高”）；")]),t._v(" "),s("li",[t._v("异常预测：基于历史数据，预测可能出现的问题（如 “某接口近 1 小时响应时间从 500ms 升至 1.5s，可能即将超时，建议排查”）。")])])]),t._v(" "),s("li",[s("strong",[t._v("跨端适配：覆盖全前端场景")]),t._v(" "),s("ul",[s("li",[t._v("小程序监控：适配微信 / 支付宝 / 抖音小程序，监控 “小程序启动耗时”“页面切换耗时”“API 调用错误”；")]),t._v(" "),s("li",[t._v("Electron / 桌面端监控：监控 “应用启动时间”“渲染进程崩溃”“主进程错误”；")]),t._v(" "),s("li",[t._v("跨端统一上报：提供跨端 SDK（Web / 小程序 / Electron），统一上报格式和监控平台，方便业务方一站式查看全端数据。")])])]),t._v(" "),s("li",[s("strong",[t._v("性能与体验优化")]),t._v(" "),s("ul",[s("li",[t._v("更小体积：通过 “按需编译”（业务方只编译需要的模块）和 “代码混淆”，将 SDK 体积从当前的 15KB 降至 8KB 以下；")]),t._v(" "),s("li",[t._v("更快加载：支持 “预加载”（"),s("code",[t._v('<link rel="preload" href="monitor-sdk.js">')]),t._v("）和 “CDN 加速”，减少 SDK 加载时间；")]),t._v(" "),s("li",[t._v("更友好的调试：提供 Chrome 插件，可视化查看 SDK 的监控数据（如错误日志、性能指标），无需登录监控平台。")])])])]),t._v(" "),s("h2",{attrs:{id:"五、面试回答技巧总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#五、面试回答技巧总结"}},[t._v("#")]),t._v(" 五、面试回答技巧总结")]),t._v(" "),s("ol",[s("li",[s("strong",[t._v("结合项目细节")]),t._v("：每个问题的回答都要加入 “我们项目中…”“我当时做的是…”，避免纯理论，体现实战经验；")]),t._v(" "),s("li",[s("strong",[t._v("逻辑清晰")]),t._v("：用 “1. 2. 3.” 或 “背景 - 方案 - 效果” 的结构，让面试官快速抓住重点；")]),t._v(" "),s("li",[s("strong",[t._v("突出解决问题的能力")]),t._v("：难点问题要说明 “痛点是什么→我怎么解决的→解决后效果如何”，而非只说 “我用了 XX 技术”；")]),t._v(" "),s("li",[s("strong",[t._v("展现思考高度")]),t._v("：不仅说 “怎么做”，还要说 “为什么这么做”“有没有更好的方案”“未来如何优化”，体现主动性和深度。")])])])}),[],!1,null,null,null);s.default=r.exports}}]);