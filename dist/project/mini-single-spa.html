<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>mini-qiankun | 前端随笔 WillianLiusHao</title>
    <meta name="generator" content="VuePress 1.9.8">
    
    <meta name="description" content="勤学如春起之苗，不见其增，日有所长">
    
    <link rel="preload" href="/study-record/assets/css/0.styles.59f54295.css" as="style"><link rel="preload" href="/study-record/assets/js/app.77f34578.js" as="script"><link rel="preload" href="/study-record/assets/js/2.8b11eef9.js" as="script"><link rel="preload" href="/study-record/assets/js/39.edf81f9a.js" as="script"><link rel="prefetch" href="/study-record/assets/js/10.0254b9aa.js"><link rel="prefetch" href="/study-record/assets/js/11.c951f4f1.js"><link rel="prefetch" href="/study-record/assets/js/12.f4e59a01.js"><link rel="prefetch" href="/study-record/assets/js/13.4e0c4125.js"><link rel="prefetch" href="/study-record/assets/js/14.bb6194d3.js"><link rel="prefetch" href="/study-record/assets/js/15.10ae3636.js"><link rel="prefetch" href="/study-record/assets/js/16.c2c03bdc.js"><link rel="prefetch" href="/study-record/assets/js/17.f9597e59.js"><link rel="prefetch" href="/study-record/assets/js/18.37fea0cb.js"><link rel="prefetch" href="/study-record/assets/js/19.e96f48f5.js"><link rel="prefetch" href="/study-record/assets/js/20.38da475d.js"><link rel="prefetch" href="/study-record/assets/js/21.d6ea83fb.js"><link rel="prefetch" href="/study-record/assets/js/22.fe101214.js"><link rel="prefetch" href="/study-record/assets/js/23.c511b9ed.js"><link rel="prefetch" href="/study-record/assets/js/24.47a40d9a.js"><link rel="prefetch" href="/study-record/assets/js/25.30745e28.js"><link rel="prefetch" href="/study-record/assets/js/26.c1c8c70b.js"><link rel="prefetch" href="/study-record/assets/js/27.7eb7b5ea.js"><link rel="prefetch" href="/study-record/assets/js/28.c1523410.js"><link rel="prefetch" href="/study-record/assets/js/29.c0d1f9d7.js"><link rel="prefetch" href="/study-record/assets/js/3.48b9d493.js"><link rel="prefetch" href="/study-record/assets/js/30.07ee03bc.js"><link rel="prefetch" href="/study-record/assets/js/31.4275be0b.js"><link rel="prefetch" href="/study-record/assets/js/32.5c239c7e.js"><link rel="prefetch" href="/study-record/assets/js/33.bea7fbf2.js"><link rel="prefetch" href="/study-record/assets/js/34.9e01da9f.js"><link rel="prefetch" href="/study-record/assets/js/35.1342a291.js"><link rel="prefetch" href="/study-record/assets/js/36.31df5eb6.js"><link rel="prefetch" href="/study-record/assets/js/37.31bf1369.js"><link rel="prefetch" href="/study-record/assets/js/38.d0a07206.js"><link rel="prefetch" href="/study-record/assets/js/4.33926142.js"><link rel="prefetch" href="/study-record/assets/js/40.0a5be4fe.js"><link rel="prefetch" href="/study-record/assets/js/41.e4aa8c16.js"><link rel="prefetch" href="/study-record/assets/js/42.315b34a2.js"><link rel="prefetch" href="/study-record/assets/js/5.70b9917c.js"><link rel="prefetch" href="/study-record/assets/js/6.365ce84f.js"><link rel="prefetch" href="/study-record/assets/js/7.e3767b70.js"><link rel="prefetch" href="/study-record/assets/js/8.a3b778af.js"><link rel="prefetch" href="/study-record/assets/js/9.88234870.js">
    <link rel="stylesheet" href="/study-record/assets/css/0.styles.59f54295.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/study-record/" class="home-link router-link-active"><!----> <span class="site-name">前端随笔 WillianLiusHao</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/WillianLiusHao" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/WillianLiusHao" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>daily</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>knowledge</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>project</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/study-record/project/infinite.html" class="sidebar-link">infinite.md</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study-record/project/infinite.html#lightning" class="sidebar-link">lightning</a></li><li class="sidebar-sub-header"><a href="/study-record/project/infinite.html#desktop-micro" class="sidebar-link">desktop-micro</a></li><li class="sidebar-sub-header"><a href="/study-record/project/infinite.html#eams、uni-app、小蓝书、官网" class="sidebar-link">eams、uni-app、小蓝书、官网</a></li><li class="sidebar-sub-header"><a href="/study-record/project/infinite.html#cms" class="sidebar-link">cms</a></li></ul></li><li><a href="/study-record/project/jssdk-monitor.html" class="sidebar-link">jssdk-monitor.md</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study-record/project/jssdk-monitor.html#监控js-sdk" class="sidebar-link">监控js-sdk</a></li></ul></li><li><a href="/study-record/project/low-code.html" class="sidebar-link">low-code.md</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study-record/project/low-code.html#low-code" class="sidebar-link">low-code</a></li><li class="sidebar-sub-header"><a href="/study-record/project/low-code.html#从组件列表到画布" class="sidebar-link">从组件列表到画布</a></li></ul></li><li><a href="/study-record/project/mini-router4.html" class="sidebar-link">mini-router4.md</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study-record/project/mini-router4.html#mini-router4" class="sidebar-link">mini-router4</a></li></ul></li><li><a href="/study-record/project/mini-single-spa.html" aria-current="page" class="active sidebar-link">mini-single-spa.md</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study-record/project/mini-single-spa.html#mini-qiankun" class="sidebar-link">mini-qiankun</a></li></ul></li><li><a href="/study-record/project/mini-vite.html" class="sidebar-link">mini-vite.md</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study-record/project/mini-vite.html#运行部分-serve" class="sidebar-link">运行部分 serve</a></li><li class="sidebar-sub-header"><a href="/study-record/project/mini-vite.html#打包部分-build" class="sidebar-link">打包部分 build</a></li></ul></li><li><a href="/study-record/project/vite-plugin-generate-routes.html" class="sidebar-link">vite-plugin-generate-routes.md</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study-record/project/vite-plugin-generate-routes.html#use" class="sidebar-link">use</a></li><li class="sidebar-sub-header"><a href="/study-record/project/vite-plugin-generate-routes.html#nuxt-rules" class="sidebar-link">nuxt rules</a></li><li class="sidebar-sub-header"><a href="/study-record/project/vite-plugin-generate-routes.html#config" class="sidebar-link">config</a></li></ul></li><li><a href="/study-record/project/vue3-scroll-virtual-list.html" class="sidebar-link">vue3-scroll-virtual-list.md</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study-record/project/vue3-scroll-virtual-list.html#install" class="sidebar-link">install</a></li><li class="sidebar-sub-header"><a href="/study-record/project/vue3-scroll-virtual-list.html#use" class="sidebar-link">use</a></li><li class="sidebar-sub-header"><a href="/study-record/project/vue3-scroll-virtual-list.html#param" class="sidebar-link">param</a></li><li class="sidebar-sub-header"><a href="/study-record/project/vue3-scroll-virtual-list.html#slot" class="sidebar-link">slot</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="mini-qiankun"><a href="#mini-qiankun" class="header-anchor">#</a> mini-qiankun</h2> <blockquote><p>学习微前端，最小化实现一个微前端框架，尽可能完善 qiankun 现有功能</p></blockquote> <h3 id="需求分析"><a href="#需求分析" class="header-anchor">#</a> 需求分析</h3> <ol><li>支持不同框架子应用</li> <li>支持子应用 HTML 入口</li> <li>JS 沙箱，确保微应用之间 全局变量/事件 不冲突</li> <li>样式隔离</li> <li>应用间数据通讯</li></ol> <h3 id="_1-特点"><a href="#_1-特点" class="header-anchor">#</a> 1. 特点</h3> <ul><li>技术栈无关：主框架不限制接入应用的技术栈，微应用具备完全自主权</li> <li>独立开发、独立部署：微应用仓库独立，前后端可独立开发，部署完成后主框架自动完成同步更新</li> <li>增量升级：在面对各种复杂场景时，我们通常很难对一个已经存在的系统做全量的技术栈升级或重构，而微前端是一种非常好的实施渐进式重构的手段和策略</li> <li>独立运行时：每个微应用之间状态隔离，运行时状态不共享</li></ul> <h3 id="_2-整体流程"><a href="#_2-整体流程" class="header-anchor">#</a> 2. 整体流程</h3> <ol><li><p>主应用注册并启动子应用（<strong>registerApplication</strong> &amp; <strong>start</strong>）</p> <ul><li><p><code>registerApplication</code>：初始化子应用对象，并加入到全局 appMaps 进行维护</p> <div class="language-js extra-class"><pre class="language-js"><code>  app <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>app<span class="token punctuation">,</span>
    status<span class="token punctuation">,</span> <span class="token comment">// 用于记录当前子应用所出的状态（9种）</span>
    pageBody<span class="token punctuation">,</span> <span class="token comment">// 子应用body部分的html内容</span>
    sandboxConfig<span class="token punctuation">,</span> <span class="token comment">// 沙箱相关配置</span>
    <span class="token literal-property property">scripts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">styles</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">isFirstLoad</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">loadedURLs</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>start</code>：启动应用</p> <ul><li>结合用户配置完善应用配置</li> <li>预加载配置</li> <li>沙箱配置</li> <li>单例模式(singular)</li></ul></li> <li><p><code>overwriteEventsAndHistory</code>：监听页面变化，切换子应用</p> <ul><li>改写浏览器的<code>popstate</code>, <code>hashChange</code>, <code>history.replaceState</code>, <code>history.pushState</code> 等方法，且每次变化都会执行 <strong>loadApps</strong> 方法</li></ul></li></ul></li> <li><p>初次加载应用（<strong>boostrapApp</strong>）</p> <ul><li><code>解析和加载资源</code>： <strong>parseHTMLandLoadSources</strong> <ul><li>loadSourceText：对子应用主页面<strong>发请求</strong>获取页面内容 html</li> <li>domparser：解析 html，处理成树状 dom（html，head，body）</li> <li>parseCssAndScript：处理 css 和 js资源，<strong>把外部链接和内嵌的处理成可执行的代码</strong></li></ul></li> <li><code>挂载根节点</code>：将子应用挂载到主应用相应位置 上</li> <li><code>沙箱</code></li> <li><code>执行 css 和 js</code></li> <li><code>子应用将 封装好的 mount/unmount 等函数，挂到代理对象上，供主应用使用</code></li></ul></li> <li><p>挂载应用（<strong>mount</strong>）</p> <ul><li><code>快照恢复</code>：恢复沙箱中的快照</li> <li><code>挂载</code>：app.mout()</li></ul></li> <li><p>卸载应用（<strong>unmount</strong>）</p> <ul><li><code>沙箱失活</code>：卸载沙箱代理的window对象 / 卸载window上的事件(监听、计时器等) / 恢复元素选择器API</li> <li><code>卸载</code>：app,unmount()</li></ul></li></ol> <h3 id="_3-沙箱"><a href="#_3-沙箱" class="header-anchor">#</a> 3. 沙箱</h3> <h4 id="_1-js隔离"><a href="#_1-js隔离" class="header-anchor">#</a> 1.js隔离</h4> <h5 id="快照沙箱-单应用"><a href="#快照沙箱-单应用" class="header-anchor">#</a> 快照沙箱（单应用）</h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">SnapshotSandbox</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>originSnapshot <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// 记录每个子应用激活前 window 的快照</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>modifyPropsMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// 记录子应用的修改了的属性</span>
  <span class="token punctuation">}</span>
  <span class="token function">active</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> prop <span class="token keyword">in</span> window<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>prop<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>originSnapshot<span class="token punctuation">[</span>prop<span class="token punctuation">]</span> <span class="token operator">=</span> window<span class="token punctuation">[</span>prop<span class="token punctuation">]</span> <span class="token comment">// 逐个属性赋值，记录快照</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>modifyPropsMap<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      window<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>modifyPropsMap<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">inActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> prop <span class="token keyword">in</span> window<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>prop<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>window<span class="token punctuation">[</span>prop<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>originSnapshot<span class="token punctuation">[</span>prop<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 说明子应用有些属性被修改了</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>modifyPropsMap<span class="token punctuation">[</span>prop<span class="token punctuation">]</span> <span class="token operator">=</span> window<span class="token punctuation">[</span>prop<span class="token punctuation">]</span> <span class="token comment">// 恢复快照前记录变化的属性</span>
          window<span class="token punctuation">[</span>prop<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>originSnapshot<span class="token punctuation">[</span>prop<span class="token punctuation">]</span> <span class="token comment">// 恢复</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    window <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>originSnapshot
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="代理沙箱-可多应用"><a href="#代理沙箱-可多应用" class="header-anchor">#</a> 代理沙箱（可多应用）</h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">proxySandbox</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>originWindow <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>fackWindow <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fackWindow<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sandboxRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 如果设置的键是代理对象自有的，在set前会经过get函数，所以此时的target 为代理对象</span>
          <span class="token comment">// 反之为 window</span>
          target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value
          <span class="token keyword">return</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 当代理对象有该属性时候，返回代理对象</span>
        <span class="token keyword">return</span> target<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">?</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">:</span> window<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>proxy <span class="token operator">=</span> proxy
  <span class="token punctuation">}</span>
  <span class="token function">active</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>sandboxRunning <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
  <span class="token function">inActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>sandboxRunning <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><p>原理：利用 proxy 生成一个代理对象（<code>proxyWindow</code>），作为子应用的 window 对象。</p></li> <li><p>实现:</p> <ul><li>当子应用设置的属性在 window 上有时，设置改值到window上</li> <li>没有时，设置到代理对象上</li> <li><strong>最后通过 with 语法，利用自执行函数，改变子应用的 window 为 proxyWindow</strong></li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code>scripts<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">code</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> codeWrap <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">;(function (proxyWindow) { 
    with(proxyWindow) {
      (function(window) {</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">}).call(proxyWindow, proxyWindow)
    }
  })(this)</span><span class="token template-punctuation string">`</span></span>
  <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span>codeWrap<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>sandbox<span class="token punctuation">.</span>proxyWindow<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// (function(window) {${code}}).call(proxyWindow, proxyWindow)</span>
<span class="token comment">// 这样，子应用代码执行时，子应用中的 window 被 proxyWindow 所取代了</span>
</code></pre></div><h5 id="一些重要的细节"><a href="#一些重要的细节" class="header-anchor">#</a> 一些重要的细节</h5> <ol><li><p>卸载时清除 沙箱 window 上的属性（防止子应用访问到上一次加载的属性）</p> <p>实现：在代理对象的 set 函数中，将在代理对象设置的属性全部记录下来</p></li> <li><p>除了属性，还需要卸载可能绑定在 window 上的一些事件/定时器（setTimeout/clearTimeout/addEventListener/removeEventListener）</p></li> <li><p><strong>缓存子应用快照，便于恢复</strong></p> <ul><li><p>原因：除了初次加载子应用，会像传统的单个 vue 项目一样把所有的流程走一遍。后续重新加载子应用都是只执行子应用暴露的 mount 函数，导致各类 mount 外的js 代码无法再次执行</p></li> <li><p>实现：在每次创建代理对象时，将代理的对象 生成快照，下次重新挂载的时候恢复这个快照即可</p></li></ul></li></ol> <h4 id="_2-元素作用域隔离"><a href="#_2-元素作用域隔离" class="header-anchor">#</a> 2.元素作用域隔离</h4> <blockquote><p>当子应用中使用 <code>document.querySelector</code> 时，依旧可以选择到主应用元素</p></blockquote> <ul><li><p>解决：改写所有的选择器，把选择范围缩小到 子应用的 container 内</p></li> <li><p>tips：卸载的时候需要将选择方法还原</p></li></ul> <h4 id="_3-css隔离"><a href="#_3-css隔离" class="header-anchor">#</a> 3.css隔离</h4> <h5 id="shadowdom"><a href="#shadowdom" class="header-anchor">#</a> shadowDom</h5> <h5 id="样式加前缀"><a href="#样式加前缀" class="header-anchor">#</a> 样式加前缀</h5> <h3 id="_4-通讯"><a href="#_4-通讯" class="header-anchor">#</a> 4. 通讯</h3> <h3 id="_5-疑难杂症"><a href="#_5-疑难杂症" class="header-anchor">#</a> 5. 疑难杂症</h3> <h4 id="_1-资源如何处理的"><a href="#_1-资源如何处理的" class="header-anchor">#</a> 1. 资源如何处理的？</h4> <ul><li><p>传统的 cli 模式下(<a href="https://github.com/kuitos/import-html-entry" target="_blank" rel="noopener noreferrer">import-html-entry<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)</p> <p>将子应用html作为入口(即index.html)，通过解析 html 的结构，解析需要的css，js等资源，并通过eval直接执行</p> <p>资源可能是外部的(有url的)，也可能是内嵌的
- 外部的：通过 promise 发送请求，返回相应内容，并将内容转化成 内嵌的
- 内嵌的：直接执行内部内容</p></li> <li><p>vite 模式下</p> <p>import、export并没有被转码，会导致直接报错（不允许在非 type=module 的 script 里面使用 import）</p> <p>所以只对 index.html 中的内嵌资源做处理，生成对应资源标签后插入到 页面中</p> <p>src资源的话，vite 会自动发送请求获取</p></li></ul> <h4 id="_2-如何在vite项目使用"><a href="#_2-如何在vite项目使用" class="header-anchor">#</a> 2. 如何在vite项目使用？</h4> <blockquote><p>为何vite中不能到生命周期钩子函数呢？</p></blockquote> <ol><li><p>vite 构建的 js 内容必须在 <code>type=module</code> 的 <code>script</code> 脚本里；</p></li> <li><p><code>qiankun</code> 的源码依赖之一 <code>import-html-entry</code> 不支持 <code>type=module</code> 这个属性</p></li> <li><p><code>qiankun</code> 是通过 <code>eval</code> 来执行这些 <code>js</code> 的内容，而 <code>vite</code> 里面 <code>import/export</code> 没有被转码， 所以直接接入会报错：不允许在非<code>type=module</code> 的 <code>script</code> 里面使用 <code>import</code></p></li></ol> <ul><li>vite 应用是采用 <code>esm</code>，统一是发请求的模式，故应将 js/css 等资源在 main 中编写</li> <li>我们可以通过编写自定义的 import 方法，将资源统一通过 import 方法引入，防止部分js的import语法 在 非 module 环境下的报错</li></ul> <blockquote><p>qiankun 官方现在还暂未支持 所以要引入第三方库 <code>vite-plugin-qiankun</code></p></blockquote> <h4 id="_3-子应用切换的生命周期管理-变化"><a href="#_3-子应用切换的生命周期管理-变化" class="header-anchor">#</a> 3. 子应用切换的生命周期管理/变化</h4> <blockquote><p>假设某次流程为：加载A应用 -&gt; 切换到C -&gt; 切换到B -&gt; 切换到A</p></blockquote> <p>请写出该流程的生命周期变化</p> <blockquote><ol><li>加载A：A依次经过 beforeBootStrap -&gt; bootStraped -&gt; beforeMount -&gt; mounted</li></ol></blockquote> <ul><li>其中在 bootstrap 生命周期会做如下事情
<ul><li>解析子应用入口html，构建资源列表</li> <li>挂载子应用 根节点到 主应用</li> <li>沙箱代理</li> <li>执行 css 和 js</li> <li>获取子应用挂载到代理对象上的 mount 和 unmount 函数，以便后续执行</li></ul></li></ul> <blockquote><ol start="2"><li>切换到C：A应用卸载（变成unmounted） -&gt; C应用走一遍<code>流程1</code></li></ol></blockquote> <blockquote><ol start="3"><li>切换到B：C应用卸载（变成unmounted） -&gt; B应用走一遍<code>流程1</code></li></ol></blockquote> <p>此时各子应用的的状态为（A：unmounted，C：unmounted，B：mounted）</p> <blockquote><ol start="4"><li>切换到A：B应用卸载（变成unmounted）-&gt; <code>A应用加载过资源了,只进行 mount 流程</code></li></ol></blockquote> <h4 id="_4-如何获取子应用声明周期钩子"><a href="#_4-如何获取子应用声明周期钩子" class="header-anchor">#</a> 4. 如何获取子应用声明周期钩子？</h4> <div class="language- extra-class"><pre><code>- 子应用将 生命周期函数挂载到 window 上（子应用代理对象），供主应用获取

- 子应用 `main.js` 导出函数，主应用通过 动态 import 的方式获取子应用中的生命周期函数
</code></pre></div><h4 id="_5-资源跨域访问"><a href="#_5-资源跨域访问" class="header-anchor">#</a> 5. 资源跨域访问</h4> <div class="language- extra-class"><pre><code>- 配置 cors，防止出现跨域问题（由于主应用和子应用的域名不同，会出现跨域问题）

    ```js
      module.exports = defineConfig({
        devServer: {
          // ...
          headers: {
            // 允许资源被主应用跨域请求
            'Access-Control-Allow-Origin': '*'
          }
        }
      })
    ```
</code></pre></div><h4 id="_6-资源加载"><a href="#_6-资源加载" class="header-anchor">#</a> 6. 资源加载</h4> <div class="language- extra-class"><pre><code>- 配置资源发布路径`publicPath`,否则主应用在请求子应用相对路径的资源(如：/src/main.js)就会请求到主应用下的资源

    ```js
      module.exports = defineConfig({
        // ...
        devServer: {
          port: 8081,
        },
        publicPath:`//localhost:${port}`,
      })
    ```
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/study-record/project/mini-router4.html" class="prev">
        mini-router4.md
      </a></span> <span class="next"><a href="/study-record/project/mini-vite.html">
        mini-vite.md
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/study-record/assets/js/app.77f34578.js" defer></script><script src="/study-record/assets/js/2.8b11eef9.js" defer></script><script src="/study-record/assets/js/39.edf81f9a.js" defer></script>
  </body>
</html>
