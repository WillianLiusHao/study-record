<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>lightning | 前端随笔 WillianLiusHao</title>
    <meta name="generator" content="VuePress 1.9.8">
    
    <meta name="description" content="勤学如春起之苗，不见其增，日有所长">
    
    <link rel="preload" href="/study-record/assets/css/0.styles.154406c3.css" as="style"><link rel="preload" href="/study-record/assets/js/app.002a58f3.js" as="script"><link rel="preload" href="/study-record/assets/js/2.b3c4d8a1.js" as="script"><link rel="preload" href="/study-record/assets/js/6.5d85da61.js" as="script"><link rel="prefetch" href="/study-record/assets/js/10.7b65a992.js"><link rel="prefetch" href="/study-record/assets/js/11.5c85eb48.js"><link rel="prefetch" href="/study-record/assets/js/12.f8603f5e.js"><link rel="prefetch" href="/study-record/assets/js/13.7d71d050.js"><link rel="prefetch" href="/study-record/assets/js/14.d22cd567.js"><link rel="prefetch" href="/study-record/assets/js/15.b5febf1a.js"><link rel="prefetch" href="/study-record/assets/js/16.c8131751.js"><link rel="prefetch" href="/study-record/assets/js/17.647f396f.js"><link rel="prefetch" href="/study-record/assets/js/18.deded741.js"><link rel="prefetch" href="/study-record/assets/js/19.f19c4540.js"><link rel="prefetch" href="/study-record/assets/js/20.515b20b1.js"><link rel="prefetch" href="/study-record/assets/js/21.5bb8c43d.js"><link rel="prefetch" href="/study-record/assets/js/22.7613b419.js"><link rel="prefetch" href="/study-record/assets/js/23.e784dcb1.js"><link rel="prefetch" href="/study-record/assets/js/24.df17657c.js"><link rel="prefetch" href="/study-record/assets/js/25.df9494ac.js"><link rel="prefetch" href="/study-record/assets/js/26.2c696e27.js"><link rel="prefetch" href="/study-record/assets/js/27.f61ed778.js"><link rel="prefetch" href="/study-record/assets/js/28.91beb4e1.js"><link rel="prefetch" href="/study-record/assets/js/29.6f53803d.js"><link rel="prefetch" href="/study-record/assets/js/3.42dd30a2.js"><link rel="prefetch" href="/study-record/assets/js/30.e8e0dbb9.js"><link rel="prefetch" href="/study-record/assets/js/31.adbfa854.js"><link rel="prefetch" href="/study-record/assets/js/32.193f9c4c.js"><link rel="prefetch" href="/study-record/assets/js/33.51c82d62.js"><link rel="prefetch" href="/study-record/assets/js/34.5e8f87b7.js"><link rel="prefetch" href="/study-record/assets/js/35.82a0cded.js"><link rel="prefetch" href="/study-record/assets/js/36.96463228.js"><link rel="prefetch" href="/study-record/assets/js/37.5c958e29.js"><link rel="prefetch" href="/study-record/assets/js/38.4952585b.js"><link rel="prefetch" href="/study-record/assets/js/39.bbd57d4c.js"><link rel="prefetch" href="/study-record/assets/js/4.adec0697.js"><link rel="prefetch" href="/study-record/assets/js/40.f9b4f584.js"><link rel="prefetch" href="/study-record/assets/js/41.28505a9c.js"><link rel="prefetch" href="/study-record/assets/js/42.ea5815cf.js"><link rel="prefetch" href="/study-record/assets/js/43.960b36cc.js"><link rel="prefetch" href="/study-record/assets/js/44.8e3841cc.js"><link rel="prefetch" href="/study-record/assets/js/45.e0c5f9c4.js"><link rel="prefetch" href="/study-record/assets/js/46.7ba0c029.js"><link rel="prefetch" href="/study-record/assets/js/47.cab37af7.js"><link rel="prefetch" href="/study-record/assets/js/48.baa05ca9.js"><link rel="prefetch" href="/study-record/assets/js/49.64f31c7d.js"><link rel="prefetch" href="/study-record/assets/js/5.cf4e2aea.js"><link rel="prefetch" href="/study-record/assets/js/50.87fe201a.js"><link rel="prefetch" href="/study-record/assets/js/51.bae29d06.js"><link rel="prefetch" href="/study-record/assets/js/52.11ef41b8.js"><link rel="prefetch" href="/study-record/assets/js/53.fa14f0ca.js"><link rel="prefetch" href="/study-record/assets/js/54.c7f7a34d.js"><link rel="prefetch" href="/study-record/assets/js/55.bc75c466.js"><link rel="prefetch" href="/study-record/assets/js/56.3a4c7e70.js"><link rel="prefetch" href="/study-record/assets/js/57.d8480a32.js"><link rel="prefetch" href="/study-record/assets/js/58.8035434c.js"><link rel="prefetch" href="/study-record/assets/js/59.02ee97e1.js"><link rel="prefetch" href="/study-record/assets/js/60.610c4eb0.js"><link rel="prefetch" href="/study-record/assets/js/61.a326cd13.js"><link rel="prefetch" href="/study-record/assets/js/62.81b46413.js"><link rel="prefetch" href="/study-record/assets/js/63.ce727602.js"><link rel="prefetch" href="/study-record/assets/js/64.bc73d375.js"><link rel="prefetch" href="/study-record/assets/js/65.c1135b2e.js"><link rel="prefetch" href="/study-record/assets/js/66.f0b30450.js"><link rel="prefetch" href="/study-record/assets/js/7.112f2913.js"><link rel="prefetch" href="/study-record/assets/js/8.85686300.js"><link rel="prefetch" href="/study-record/assets/js/9.7f17a17b.js">
    <link rel="stylesheet" href="/study-record/assets/css/0.styles.154406c3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/study-record/" class="home-link router-link-active"><!----> <span class="site-name">前端随笔 WillianLiusHao</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/WillianLiusHao" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/WillianLiusHao" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>1.基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>2.项目</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/study-record/2.项目/aboutme.html" class="sidebar-link">aboutme</a></li><li><a href="/study-record/2.项目/cms.html" class="sidebar-link">cms</a></li><li><a href="/study-record/2.项目/infinite.html" class="sidebar-link">infinite</a></li><li><a href="/study-record/2.项目/jssdk-monitor.html" class="sidebar-link">jssdk-monitor</a></li><li><a href="/study-record/2.项目/lightning.html" class="active sidebar-link">lightning</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study-record/2.项目/lightning.html#_1-工程架构设计" class="sidebar-link">1. 工程架构设计</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study-record/2.项目/lightning.html#多页应用" class="sidebar-link">多页应用</a></li><li class="sidebar-sub-header"><a href="/study-record/2.项目/lightning.html#工作原理-重点" class="sidebar-link">工作原理（重点）</a></li><li class="sidebar-sub-header"><a href="/study-record/2.项目/lightning.html#作业流程" class="sidebar-link">作业流程</a></li></ul></li><li class="sidebar-sub-header"><a href="/study-record/2.项目/lightning.html#_2-编辑器组件、编辑组件、业务组件" class="sidebar-link">2. 编辑器组件、编辑组件、业务组件</a></li><li class="sidebar-sub-header"><a href="/study-record/2.项目/lightning.html#_3-脚本命令" class="sidebar-link">3. 脚本命令</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study-record/2.项目/lightning.html#serve" class="sidebar-link">serve</a></li><li class="sidebar-sub-header"><a href="/study-record/2.项目/lightning.html#template" class="sidebar-link">template</a></li></ul></li><li class="sidebar-sub-header"><a href="/study-record/2.项目/lightning.html#_4-sdk" class="sidebar-link">4. sdk</a></li><li class="sidebar-sub-header"><a href="/study-record/2.项目/lightning.html#_5-git-flow-工作流" class="sidebar-link">5. git flow 工作流</a></li><li class="sidebar-sub-header"><a href="/study-record/2.项目/lightning.html#_6-项目总结" class="sidebar-link">6.项目总结</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study-record/2.项目/lightning.html#_6-1-技术要点" class="sidebar-link">6.1 技术要点</a></li><li class="sidebar-sub-header"><a href="/study-record/2.项目/lightning.html#_6-2-架构设计" class="sidebar-link">6.2 架构设计 ！！！</a></li><li class="sidebar-sub-header"><a href="/study-record/2.项目/lightning.html#_6-3-业务亮点-生效率的提升" class="sidebar-link">6.3 业务亮点（生效率的提升）</a></li><li class="sidebar-sub-header"><a href="/study-record/2.项目/lightning.html#_6-4-待优化点" class="sidebar-link">6.4 待优化点</a></li><li class="sidebar-sub-header"><a href="/study-record/2.项目/lightning.html#_6-5-相关问题" class="sidebar-link">6.5 相关问题</a></li></ul></li></ul></li><li><a href="/study-record/2.项目/mini-qiankun.html" class="sidebar-link">mini-qiankun</a></li><li><a href="/study-record/2.项目/mini-router4.html" class="sidebar-link">mini-router4</a></li><li><a href="/study-record/2.项目/mini-vite.html" class="sidebar-link">mini-vite</a></li><li><a href="/study-record/2.项目/vite-plugin-generate-routes.html" class="sidebar-link">vite-plugin-generate-routes</a></li><li><a href="/study-record/2.项目/vue3-scroll-virtual-list.html" class="sidebar-link">vue3-scroll-virtual-list</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>3.算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>4.日常</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/study-record/" aria-current="page" class="sidebar-link">index</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="lightning"><a href="#lightning" class="header-anchor">#</a> lightning</h1> <h2 id="_1-工程架构设计"><a href="#_1-工程架构设计" class="header-anchor">#</a> 1. 工程架构设计</h2> <h3 id="多页应用"><a href="#多页应用" class="header-anchor">#</a> 多页应用</h3> <p>系统采用 <code>multi-page</code> 模式</p> <ul><li>其中平台及编辑页面，编辑的控制台是一个<code>应用A</code></li> <li>用户的模板是一个只关注活动页的<code>次应用B</code></li></ul> <p>在 <code>A</code> 的编辑工作台中，通过 <code>iframe</code> 的方式加载 <code>B</code>，并传入相关参数</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// id 是活动唯一id，template 是模板的名称</span>
<span class="token operator">&lt;</span>iframe
  ref<span class="token operator">=</span><span class="token string">&quot;iframe&quot;</span>
  frameborder<span class="token operator">=</span><span class="token string">&quot;0&quot;</span>
  <span class="token operator">:</span>src<span class="token operator">=</span><span class="token string">&quot;`/subpage/?id=${$route.params.id}&amp;template=${$route.query.template}`&quot;</span>
<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>iframe<span class="token operator">&gt;</span>
</code></pre></div><h3 id="工作原理-重点"><a href="#工作原理-重点" class="header-anchor">#</a> 工作原理（重点）</h3> <ol><li><p>进入编辑页</p> <ul><li><p><strong>beforeRouteEnter</strong></p> <ol><li>调用接口获取模板配置，合并活动配置和模板配置,存到 vuex<div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">const</span> <span class="token punctuation">{</span> config <span class="token punctuation">}</span> <span class="token operator">=</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>bean<span class="token punctuation">.</span>template_config <span class="token comment">// 这个是本地开发好发布的模板配置</span>
  store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'recordActivity'</span><span class="token punctuation">,</span> utils<span class="token punctuation">.</span><span class="token function">cloneDeep</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token punctuation">[</span>to<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> 
        <span class="token literal-property property">_id</span><span class="token operator">:</span> to<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'主实例'</span><span class="token punctuation">,</span>
        <span class="token comment">// 活动配置合并模版配置</span>
        <span class="token literal-property property">config</span><span class="token operator">:</span> utils<span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> config<span class="token punctuation">,</span> <span class="token function">handleConfig</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>bean<span class="token punctuation">.</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">version_num</span><span class="token operator">:</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>bean<span class="token punctuation">.</span>version_num
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div></li> <li>next(vm)
<ul><li>把活动相关的字段(<code>活动名，活动id，企业id，项目id</code>)等 挂到 <code>vm.form</code> 上</li> <li>把模板配置 挂到 <code>vm.template</code> 上</li></ul></li></ol></li> <li><p><strong>created</strong></p> <ul><li>如果是本地环境，会直接获取本地的模板配置，作为主实例配置</li></ul></li> <li><p><strong>mounted</strong></p> <ul><li>暴露编辑器对象到全局：<code>window.$editor = this</code></li></ul></li></ul></li> <li><p>进入活动页</p> <ul><li>created<br>
获取 query 参数，主要是 模板名</li> <li>mounted<div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span>Vue <span class="token operator">=</span> Vue
    <span class="token comment">// 编辑器子应用对象到全局</span>
    window<span class="token punctuation">.</span>$subpage <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token comment">// 获取父应用</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$editor <span class="token operator">=</span> window<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>$editor
    <span class="token comment">// 重点：调用(父)平台应用的加载方法，进而加载活动</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$editor<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 工具条，重要的编辑器组件</span>
    <span class="token keyword">const</span> $toolbar <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$el<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.mouse-catcher .toolbar'</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>toolbar <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span>$toolbar<span class="token punctuation">,</span> <span class="token string">'width'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span>$toolbar<span class="token punctuation">,</span> <span class="token string">'height'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div></li></ul></li></ol> <p>接下来我们看下 平台应用的 <code>load</code> 方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 调用iframe里的模版对象的渲染方法 renderTemplate</span>
  <span class="token comment">// 对模板上的 content (即打包发布的html) 进行处理</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>$subpage <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$refs<span class="token punctuation">.</span>iframe<span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span>$subpage
  <span class="token keyword">this</span><span class="token punctuation">.</span>$subpage<span class="token punctuation">.</span><span class="token function">renderTemplate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>template<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 把企业ID和活动id 挂载到 子应用的 根实例上</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$subpage<span class="token punctuation">.</span>$root<span class="token punctuation">.</span>activityId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>form<span class="token punctuation">.</span>test_activity_id
    <span class="token keyword">this</span><span class="token punctuation">.</span>$subpage<span class="token punctuation">.</span>$root<span class="token punctuation">.</span>companyId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>form<span class="token punctuation">.</span>test_company_id
    <span class="token comment">// 第一个实例默认为当前实例</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>activeExperiment <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>experiments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>timestamp <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$_loading<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>$root<span class="token punctuation">.</span><span class="token function">$on</span><span class="token punctuation">(</span><span class="token string">'edit'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>setting<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> utils<span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span>utils<span class="token punctuation">.</span><span class="token function">cloneDeep</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>setting<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>继续跳到子应用看 <code>renderTemplate</code> 方法
// window[template] ???</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token function">renderTemplate</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> template <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>query
  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'development'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> utils<span class="token punctuation">.</span><span class="token function">renderTemplate</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span>
    <span class="token comment">// window[template] ???</span>
    Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> window<span class="token punctuation">[</span>template<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 开发环境，则直接读取 src/template/index 内容，并将 模板实例 作为组件注册到全局</span>
    <span class="token keyword">const</span> activity <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">@/template</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      name <span class="token operator">===</span> template <span class="token operator">&amp;&amp;</span> Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> activity<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span>default<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>template <span class="token operator">=</span> template
<span class="token punctuation">}</span>
</code></pre></div><p>utils.renderTemplate(content)</p> <p>子应用页面非常简单</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>section</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>subpage<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- setting 是 平台上通过监听 setting 配置，一旦变化，就传进来活动中 --&gt;</span>
    <span class="token comment">&lt;!-- template 是 全局注册的组件 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>component</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>template<span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>setting &amp;&amp; template<span class="token punctuation">&quot;</span></span> <span class="token attr-name">:is</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>template<span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>setting<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>component</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mouse-catcher</span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>catcher<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mouse-catcher</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>callback-preview</span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>setting<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>callbackPreview<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>callback-preview</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>section</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>至此，活动页面就渲染完成</p> <h3 id="作业流程"><a href="#作业流程" class="header-anchor">#</a> 作业流程</h3> <ul><li><p>模板发布<br>
开发人员，在本地通过命令发布，把本地开发好的模板及相关配置发布到线上</p></li> <li><p>活动发布<br> <strong>线上活动读取了模板文件和配置后，合并活动配置，渲染到编辑工作台</strong>，然后在工作台可视化的点击按钮发布</p></li></ul> <h2 id="_2-编辑器组件、编辑组件、业务组件"><a href="#_2-编辑器组件、编辑组件、业务组件" class="header-anchor">#</a> 2. 编辑器组件、编辑组件、业务组件</h2> <h2 id="_3-脚本命令"><a href="#_3-脚本命令" class="header-anchor">#</a> 3. 脚本命令</h2> <h3 id="serve"><a href="#serve" class="header-anchor">#</a> serve</h3> <blockquote><p>本地启动模板<br>
yarn serve [模版名，多个空格隔开]</p></blockquote> <ol><li><p><strong>根据模板名生成导出文件</strong></p> <p><code>fs.writeFileSync</code> 生成的导出文件如下</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/* /src/template/index.js */</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> zhihao_339_38_20220124 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@/template/zhihao_339_38_20220124'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> zhihao_339_38_20220124_configJson <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@/template/zhihao_339_38_20220124/config.json'</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p><strong>运行项目</strong></p> <p>实则是启动了2个项目，主应用和次应用</p> <p><code>yarn start</code> = <code>vue-cli-service serve</code></p></li></ol> <h3 id="template"><a href="#template" class="header-anchor">#</a> template</h3> <blockquote><p>打包开发模板，并发布生产<br>
yarn template [模版名]</p></blockquote> <ol><li><p><strong>前置基本配置处理</strong></p> <ul><li><strong>是否有用户信息</strong><br>
读取根目录下的 <code>env.json</code> 文件，没有的话会走 <code>yarn env</code> 命令，后面会讲到</li> <li><strong>根据模板名称读取打包模板路径</strong><br>
匹配多个模板时，会提供命令行交互选择</li> <li><strong>命令行参数判断发布正式/测试</strong><br>
prod 参数</li></ul></li> <li><p><strong>开始打包</strong></p> <p>使用 vue-cli 自带的打包功能，根据<code>页面开发模板</code>打包，<strong>将模板页面打包成一个库 <code>library</code></strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">yarn build --dest template/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>template<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> --target lib
  --name </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>template<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> src/template/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>template<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/index.vue</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">)</span>
</code></pre></div><p>打包后的 <code>文件夹</code> 和 <code>html</code> 如下：</p></li></ol> <p><img src="/study-record/assets/img/vuecli-build-dist.89d95e6a.png" alt=""></p> <p><img src="/study-record/assets/img/template-build-html.ef24fcd9.png" alt=""></p> <ol start="3"><li><p><strong>资源重命名、资源上传</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 文件重命名
* @params dir 打包后的文件夹
* @params template 模板名
*/</span>
<span class="token keyword">const</span> <span class="token function-variable function">renameAssets</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">dir<span class="token punctuation">,</span> template</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=&gt;</span> name<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> oldPath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>dir<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'oldPath'</span><span class="token punctuation">,</span> oldPath<span class="token punctuation">)</span>
      <span class="token comment">// 只获取umd规范文件（可直接给浏览器或AMD loader使用的 UMD 包）</span>
      <span class="token comment">// 具体规则：umd.min =&gt; 时间戳</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'umd.min.js'</span><span class="token punctuation">)</span> <span class="token operator">||</span> name<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'css'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fs<span class="token punctuation">.</span><span class="token function">renameSync</span><span class="token punctuation">(</span>
          oldPath<span class="token punctuation">,</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>oldPath
            <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token function">extname</span><span class="token punctuation">(</span>oldPath<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'.umd.min'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">generate</span><span class="token punctuation">(</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>template<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">_</span><span class="token regex-delimiter">/</span><span class="token regex-flags">gi</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">dayjs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'YYYYMMDD'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
            <span class="token number">8</span>
          <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'css'</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">'css'</span> <span class="token operator">:</span> <span class="token string">'js'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>name<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'umd.min'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 非 umd 文件全部删掉</span>
        fs<span class="token punctuation">.</span><span class="token function">unlinkSync</span><span class="token punctuation">(</span>oldPath<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 资源上传：uploadAssets</span>
<span class="token comment">// 调用接口将资源上传到公司的cdn，返回静态资源地址集合</span>
<span class="token keyword">const</span> cdnRes <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">uploadAssets</span><span class="token punctuation">(</span><span class="token function">getFiles</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">,</span> template<span class="token punctuation">)</span>
</code></pre></div></li> <li><p><strong>生成html文件！！！</strong></p> <p><strong>该步骤主要有如下功能</strong></p> <ol><li>把默认 html 模板中的 css 和 js 预留位替换成 构建且上传的 cdn资源</li> <li>把 template 替换成构建的模板名（即当前页面使用的组件）</li> <li>生成 html 文件到打包模板目录下</li> <li>发布上传
<ul><li>模板名称 <code>name</code></li> <li>打包后的模板 <code>content</code></li> <li>模板配置项 <code>setting</code></li></ul></li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">await</span> <span class="token function">renderHtml</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> cdnRes<span class="token punctuation">,</span> template<span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">renderHtml</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">dir<span class="token punctuation">,</span> cdn<span class="token punctuation">,</span> template</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 基于统一的 template 模板文件进行</span>
  <span class="token keyword">let</span> data <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token function">join</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">../../script/template.html</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">flag</span><span class="token operator">:</span> <span class="token string">'r+'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">encoding</span><span class="token operator">:</span> <span class="token string">'utf8'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 模板内的 js 和 css 替换成 cdn 资源</span>
  <span class="token keyword">const</span> reg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>template<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.[0-9a-z]*.(css|js)$</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token string">'gi'</span><span class="token punctuation">)</span>
  <span class="token punctuation">;</span><span class="token punctuation">[</span><span class="token string">'css'</span><span class="token punctuation">,</span> <span class="token string">'js'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">x</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    data <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>
      <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">{{ </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>x<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> }}</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token string">'gi'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      cdn<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token operator">=&gt;</span> c<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>c<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'umd.min'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> c<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>reg<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 模板中的变量替换</span>
  <span class="token comment">// 1. {{ template }} =&gt; 对应模板名称（组件名称）</span>
  <span class="token comment">// 2. {{ timestamp }} =&gt; 当前时间</span>
  data <span class="token operator">=</span> data
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">{{ template }}</span><span class="token regex-delimiter">/</span><span class="token regex-flags">gi</span></span><span class="token punctuation">,</span> template<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">{{ timestamp }}</span><span class="token regex-delimiter">/</span><span class="token regex-flags">gi</span></span><span class="token punctuation">,</span> <span class="token function">dayjs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'YYYYMMDDHHmmssSSS '</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">// 写入文件 /template/[模板名]/index.prod.html</span>
  <span class="token comment">// 该文件已经 替换了 css/js，引入了模板组件</span>
  fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token function">join</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> <span class="token string">'index.prod.html'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">flag</span><span class="token operator">:</span> <span class="token string">'w+'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">encoding</span><span class="token operator">:</span> <span class="token string">'utf8'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> secretKey <span class="token operator">=</span>
    <span class="token string">'hiWcOTz^#XsppKCKRyf6n*x8*U&amp;I1Wg1p1CLa#9V8SD@dSTD#2tWukl1WZ!QOG9l'</span>
  <span class="token comment">// 读取开发模板的配置，构建接口参数</span>
  <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token function">join</span><span class="token punctuation">(</span>
    __dirname<span class="token punctuation">,</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">../../src/template/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>template<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/config.json</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">delete</span> config<span class="token punctuation">.</span>style
  config<span class="token punctuation">.</span>template <span class="token operator">||</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>template <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  config<span class="token punctuation">.</span>other <span class="token operator">||</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>other <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  config<span class="token punctuation">.</span>hidden <span class="token operator">||</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>hidden <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> template<span class="token punctuation">,</span>
    <span class="token literal-property property">content</span><span class="token operator">:</span> data<span class="token punctuation">,</span>
    config<span class="token punctuation">,</span>
    <span class="token literal-property property">email</span><span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span>envPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token constant">EMAIL</span><span class="token punctuation">,</span>
    <span class="token literal-property property">responseTime</span><span class="token operator">:</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  params<span class="token punctuation">.</span>sign <span class="token operator">=</span> crypto
    <span class="token punctuation">.</span><span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">'sha1'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>params<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>params<span class="token punctuation">.</span>email<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>params<span class="token punctuation">.</span>responseTime<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>secretKey<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token string">'utf-8'</span>
    <span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span>

  <span class="token comment">// 发布项目</span>
  <span class="token keyword">const</span> publishUrl <span class="token operator">=</span> prod <span class="token operator">?</span> <span class="token string">'https://adms.vrm.cn'</span> <span class="token operator">:</span> <span class="token string">'http://192.168.0.114'</span>
  <span class="token keyword">const</span> resNew <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>publishUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/api/template/package</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    params
  <span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
    resNew<span class="token punctuation">.</span>data<span class="token punctuation">.</span>success
      <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>publishUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 提交成功 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>template<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">.</span>green
      <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>publishUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 提交失败 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>template<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>resNew<span class="token punctuation">.</span>data<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">.</span>red
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><p>生成后的 html 如下</p> <p><img src="/study-record/assets/img/template-prod-html.56a5f886.png" alt=""></p></li></ol> <h2 id="_4-sdk"><a href="#_4-sdk" class="header-anchor">#</a> 4. sdk</h2> <p><a href="/study-record/2.项目/jssdk-monitor.html">立刻前往</a></p> <h2 id="_5-git-flow-工作流"><a href="#_5-git-flow-工作流" class="header-anchor">#</a> 5. git flow 工作流</h2> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;husky&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">&quot;hooks&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 每次切分支，都要拉主分支合并</span>
    <span class="token property">&quot;post-checkout&quot;</span><span class="token operator">:</span> <span class="token string">&quot;git pull origin master &amp;&amp; git merge master&quot;</span><span class="token punctuation">,</span>
    <span class="token comment">// 每次提交前要走 gitflow.js（校验是否是template下的文件），然后拉取主分支合并</span>
    <span class="token property">&quot;pre-commit&quot;</span><span class="token operator">:</span> &quot;node ./script/command/gitflow.js &amp;&amp; git pull origin master 
    &amp;&amp; git merge master &amp;&amp; lint-staged&quot;<span class="token punctuation">,</span>
    <span class="token property">&quot;commit-msg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;commitlint -E HUSKY_GIT_PARAMS&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>master</strong>：是平台分支</p> <p><strong>template2020</strong>： 是公共分支，也是发布生产的分支</p> <p><strong>template_xxx</strong>：每个用户有自己的 template 分支</p> <p><code>yarn build</code>：自动拉取 mater 合并，确保是最新的平台代码（业务组件是在平台上）</p> <p><code>yarn commit</code>：</p> <h2 id="_6-项目总结"><a href="#_6-项目总结" class="header-anchor">#</a> 6.项目总结</h2> <h3 id="_6-1-技术要点"><a href="#_6-1-技术要点" class="header-anchor">#</a> 6.1 技术要点</h3> <ol><li><p><strong>页面组件化</strong></p></li> <li><p>组件的开发</p></li> <li><p>页面可视化编辑</p> <ul><li>数据流问题</li></ul></li> <li><p>页面的实时预览</p></li> <li><p>页面的打包</p> <ul><li>平台和页面多入口应用，分开打包</li> <li>一系列活动页面相关的脚本</li></ul></li></ol> <h3 id="_6-2-架构设计"><a href="#_6-2-架构设计" class="header-anchor">#</a> 6.2 架构设计 ！！！</h3> <blockquote><p><strong>安全性</strong></p></blockquote> <ol><li>平台和活动页为双入口应用，且分开打包
<ul><li>活动页的本地运行，打包都写了js脚本</li> <li>每次组件有更新的话，平台需要打包重新发布，但是活动页面不会马上用最新的组件代码，需重新打包</li></ul></li> <li>非开发同事有时候活动改了关键配置后发布，导致线上页面报错
<ul><li>引入前端监控（错误/性能/行为）</li></ul></li></ol> <blockquote><p><strong>复杂度</strong></p></blockquote> <ol><li><p>组件类型多样</p> <ul><li>业务组件
<ul><li>常规组件</li> <li>弹层组件</li></ul></li> <li>素材组件</li> <li>编辑组件
<ul><li>捕获器组件</li> <li>cb组件</li></ul></li></ul></li> <li><p>组件复杂度</p> <ul><li>表单组件</li></ul></li></ol> <blockquote><p><strong>可维护性</strong></p></blockquote> <ol><li><p>单向数据流，保证页面的配置项数据的改动只会在平台进行，活动页内是只进行数据渲染和展示</p></li> <li><p>数据的合并,diff算法</p> <ul><li>线上配置合并到模板配置的时候
<ul><li>如果模板重新发布了，有新增的属性，则合并后是多了属性</li> <li>如果模板重新发布了，有删除的属性，属性不会删除（因为是以线上的为准）</li></ul></li></ul></li></ol> <blockquote><p><strong>性能</strong>？？？todo</p></blockquote> <ol><li><p>MutationObserver
鼠标捕获器监听页面结构变化</p></li> <li><p>ResizeObserver</p> <ul><li>监听素材容器尺寸变化，每次素材大小改变的时候，捕获器的宽高也要随之改变</li> <li>对比 onresize 和 getComputedSize 性能好太多</li></ul></li></ol> <h3 id="_6-3-业务亮点-生效率的提升"><a href="#_6-3-业务亮点-生效率的提升" class="header-anchor">#</a> 6.3 业务亮点（生效率的提升）</h3> <ul><li>提供丰富的页面模板</li> <li>业务组件可满足绝大部分场景</li> <li>提供数据分析能力（以及AB测试能力）</li></ul> <h3 id="_6-4-待优化点"><a href="#_6-4-待优化点" class="header-anchor">#</a> 6.4 待优化点</h3> <ol><li><p>模板的配置合并问题（<code>本质就是对象数据合并问题</code>）</p> <ul><li>目前流程
<ul><li>模板的配置是开发人员本地发布的，但并不是最重要的效果（最终是要以线上的为准）</li> <li>编辑页内，以线上活动的配置为主，通过 <code>mergeWith</code> 的方式，将 <code>模板中的新配置</code> 合并到 <code>线上活动配置</code> 中</li></ul></li> <li>存在问题
<ul><li>引用数据类型（对象/数组）的删除无法实现（旧配置有改属性）</li> <li>配置越来越大（合并规则：<code>对象不断合并属性，数组直接替换</code>）</li></ul></li></ul></li> <li><p>模板越来越多，项目越来越大</p> <ul><li>分支管理</li></ul></li> <li><p>业务功能嵌入太多，以发展到不可控状态</p> <ul><li>产品宣讲，人为规范</li> <li>开发对功能的规范</li></ul></li></ol> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;template&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 改模板的全局配置，一般是页面级别的功能</span>
    <span class="token comment">// 例如：页面的回退回调、页面自动提交表单 等</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;dataSource&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 素材组件的地址列表</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;config&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;form&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;fields&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;layer_[id1]&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 每个弹层组件有自己单独的配置</span>
  <span class="token property">&quot;layer_[id2]&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;layer_[idn]&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  
  <span class="token property">&quot;other&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// 通过可视化编辑，进行组件的样式编辑，会根据id进行样式的存储</span>
    <span class="token comment">// 最后通过行内样式的形式附加到改组件上</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;组件id&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;style&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_6-5-相关问题"><a href="#_6-5-相关问题" class="header-anchor">#</a> 6.5 相关问题</h3> <ol><li><p>竞品：凡科</p></li> <li><p><strong>项目背景</strong></p> <ul><li><strong>背景/为什么自研</strong></li></ul> <table><thead><tr><th>维度</th> <th>市面上</th> <th>我们</th></tr></thead> <tbody><tr><td>需求</td> <td>像市面上很多的低代码编辑都是拖拽的，但其实只是制作简单的 H5 海报页</td> <td>而我们是 银行&amp;保险 类营销页面，会涉及大量的业务逻辑和业务功能</td></tr> <tr><td>难点</td> <td>拖拽功能</td> <td>复杂的业务场景</td></tr></tbody></table> <ul><li>业务场景
<ul><li>数据传输（公司内部，公司和外部）</li> <li>各类运营策略下的功能（引流，回退，弹层又弹层，事件埋点，上报统计）</li> <li>组件的多样性，功能丰富性（其实说很多业务功能- -）</li></ul></li></ul></li> <li><p><strong>复杂度</strong></p></li></ol> <ul><li><p>3.1 组件类型多样</p> <ul><li><ol><li>业务组件</li></ol> <ul><li>常规组件</li> <li>弹层组件</li></ul></li> <li><ol start="2"><li>素材组件</li></ol></li> <li><ol start="3"><li>编辑组件</li></ol> <ul><li>捕获器组件
<ul><li>样式的计算（宽高，位置）</li> <li>更新问题（配置变化就要 重新获取捕获器 / 重设捕获器属性）<code>MutationObserver</code> + <code>ResizeObserver</code></li></ul></li> <li>cb组件</li></ul></li></ul></li> <li><p>3.2 为满足多样的业务，组件开发复杂度也高</p> <ul><li>拿众多复杂组件中的<strong>表单组件</strong>举个例子，说明复杂度
<ol><li>类型：就分为 注册表单和更新表单
<ul><li>因为调用不同的接口</li> <li>注册表单必填，更新非必填（可跳过）</li></ul></li> <li>字段
<ul><li>手机：<code>前置验证码</code> / <code>后置验证码</code> / <code>填完显示其他表单（营销策略）</code></li> <li>姓名：<code>带不带性别</code> / <code>性别选择的（样式/文案/默认值）</code></li> <li>身份证：<code>带X</code></li> <li>服务协议：<code>自定义协议管理模块</code></li></ul></li> <li>注册后的回调
<ul><li><code>ic 分发</code></li> <li><code>跳机器人</code></li> <li><code>跳引流</code></li> <li><code>打开弹层</code></li></ul></li> <li>拓展功能
<ul><li><code>自动填充用户信息（获取连接上的参数）</code></li></ul></li></ol></li></ul></li></ul> <ol start="4"><li><p><strong>数据流</strong></p> <p>整个项目都是基于 setting 进行 <code>修改，编辑，渲染</code>，所以 setting 要怎么合理的设计 setting 数据的 更新尤其重要，防止数据混乱</p> <ul><li>setting 统一是由<code>编辑工作台的主页</code>进行维护，通过 <code>watch</code> 监听变化，一旦变化就会同步给 <code>活动页面</code></li> <li>活动页面不会也不能修改 setting 配置</li></ul></li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/study-record/2.项目/jssdk-monitor.html" class="prev">
        jssdk-monitor
      </a></span> <span class="next"><a href="/study-record/2.项目/mini-qiankun.html">
        mini-qiankun
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/study-record/assets/js/app.002a58f3.js" defer></script><script src="/study-record/assets/js/2.b3c4d8a1.js" defer></script><script src="/study-record/assets/js/6.5d85da61.js" defer></script>
  </body>
</html>
